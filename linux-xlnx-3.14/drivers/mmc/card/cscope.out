cscope 15 $HOME/source_code/emmc/linux-xlnx-3.14/drivers/mmc/card               0000194316
	@block.c

20 
	~<löux/moduÀ∑øm.h
>

21 
	~<löux/moduÀ.h
>

22 
	~<löux/öô.h
>

24 
	~<löux/kî√l.h
>

25 
	~<löux/fs.h
>

26 
	~<löux/¶ab.h
>

27 
	~<löux/î∫o.h
>

28 
	~<löux/hdªg.h
>

29 
	~<löux/kdev_t.h
>

30 
	~<löux/blkdev.h
>

31 
	~<löux/muãx.h
>

32 
	~<löux/sˇâîli°.h
>

33 
	~<löux/°rög_hñ≥rs.h
>

34 
	~<löux/dñay.h
>

35 
	~<löux/ˇ∑bûôy.h
>

36 
	~<löux/com∑t.h
>

37 
	~<löux/pm_ru¡ime.h
>

39 
	~<löux/mmc/io˘l.h
>

40 
	~<löux/mmc/ˇrd.h
>

41 
	~<löux/mmc/ho°.h
>

42 
	~<löux/mmc/mmc.h
>

43 
	~<löux/mmc/sd.h
>

45 
	~<asm/uac˚ss.h
>

47 
	~"queue.h
"

49 
MODULE_ALIAS
("mmc:block");

50 #ifde‡
MODULE_PARAM_PREFIX


51 #unde‡
MODULE_PARAM_PREFIX


53 
	#MODULE_PARAM_PREFIX
 "mmcblk."

	)

55 
	#INAND_CMD38_ARG_EXT_CSD
 113

	)

56 
	#INAND_CMD38_ARG_ERASE
 0x00

	)

57 
	#INAND_CMD38_ARG_TRIM
 0x01

	)

58 
	#INAND_CMD38_ARG_SECERASE
 0x80

	)

59 
	#INAND_CMD38_ARG_SECTRIM1
 0x81

	)

60 
	#INAND_CMD38_ARG_SECTRIM2
 0x88

	)

61 
	#MMC_BLK_TIMEOUT_MS
 (10 * 60 * 1000Ë

	)

62 
	#MMC_SANITIZE_REQ_TIMEOUT
 240000

	)

63 
	#MMC_EXTRACT_INDEX_FROM_ARG
(
x
Ë((x & 0x00FF0000Ë>> 16)

	)

65 
	#mmc_ªq_ªl_wr
(
ªq
Ë((‘eq->
cmd_Êags
 & 
REQ_FUA
) || \

66 (
ªq
->
cmd_Êags
 & 
REQ_META
)) && \

67 (
	`rq_d©a_dú
(
ªq
Ë=
WRITE
))

	)

68 
	#PACKED_CMD_VER
 0x01

	)

69 
	#PACKED_CMD_WR
 0x02

	)

71 
DEFINE_MUTEX
(
block_muãx
);

77 
	g≥rdev_mö‹s
 = 
CONFIG_MMC_BLOCK_MINORS
;

83 
	gmax_devi˚s
;

86 
DECLARE_BITMAP
(
dev_u£
, 256);

87 
DECLARE_BITMAP
(
«me_u£
, 256);

92 
	smmc_blk_d©a
 {

93 
•ölock_t
 
	mlock
;

94 
gídisk
 *
	mdisk
;

95 
mmc_queue
 
	mqueue
;

96 
li°_hód
 
	m∑π
;

98 
	mÊags
;

99 
	#MMC_BLK_CMD23
 (1 << 0Ë

	)

100 
	#MMC_BLK_REL_WR
 (1 << 1Ë

	)

101 
	#MMC_BLK_PACKED_CMD
 (1 << 2Ë

	)

103 
	mußge
;

104 
	mªad_⁄ly
;

105 
	m∑π_ty≥
;

106 
	m«me_idx
;

107 
	mª£t_d⁄e
;

108 
	#MMC_BLK_READ
 
	`BIT
(0)

	)

109 
	#MMC_BLK_WRITE
 
	`BIT
(1)

	)

110 
	#MMC_BLK_DISCARD
 
	`BIT
(2)

	)

111 
	#MMC_BLK_SECDISCARD
 
	`BIT
(3)

	)

118 
	m∑π_cuº
;

119 
devi˚_©åibuã
 
	mf‹˚_ro
;

120 
devi˚_©åibuã
 
	mpowî_ro_lock
;

121 
	m¨ó_ty≥
;

124 
DEFINE_MUTEX
(
›í_lock
);

127 
	mMMC_PACKED_NR_IDX
 = -1,

128 
	mMMC_PACKED_NR_ZERO
,

129 
	mMMC_PACKED_NR_SINGLE
,

132 
moduÀ_∑øm
(
≥rdev_mö‹s
, , 0444);

133 
MODULE_PARM_DESC
(
≥rdev_mö‹s
, "MinorsÇumbersÅoállocateÖer device");

135 
ölöe
 
mmc_blk_∑π_swôch
(
mmc_ˇrd
 *
ˇrd
,

136 
mmc_blk_d©a
 *
md
);

137 
gë_ˇrd_°©us
(
mmc_ˇrd
 *
ˇrd
, 
u32
 *
°©us
, 
ªåõs
);

139 
ölöe
 
	$mmc_blk_˛ór_∑cked
(
mmc_queue_ªq
 *
mqrq
)

141 
mmc_∑cked
 *
∑cked
 = 
mqrq
->packed;

143 
	`BUG_ON
(!
∑cked
);

145 
mqrq
->
cmd_ty≥
 = 
MMC_PACKED_NONE
;

146 
∑cked
->
ƒ_íåõs
 = 
MMC_PACKED_NR_ZERO
;

147 
∑cked
->
idx_Áûuª
 = 
MMC_PACKED_NR_IDX
;

148 
∑cked
->
ªåõs
 = 0;

149 
∑cked
->
blocks
 = 0;

150 
	}
}

152 
mmc_blk_d©a
 *
	$mmc_blk_gë
(
gídisk
 *
disk
)

154 
mmc_blk_d©a
 *
md
;

156 
	`muãx_lock
(&
›í_lock
);

157 
md
 = 
disk
->
¥iv©e_d©a
;

158 i‡(
md
 && md->
ußge
 == 0)

159 
md
 = 
NULL
;

160 i‡(
md
)

161 
md
->
ußge
++;

162 
	`muãx_u∆ock
(&
›í_lock
);

164  
md
;

165 
	}
}

167 
ölöe
 
	$mmc_gë_devidx
(
gídisk
 *
disk
)

169 
devmaj
 = 
	`MAJOR
(
	`disk_devt
(
disk
));

170 
devidx
 = 
	`MINOR
(
	`disk_devt
(
disk
)Ë/ 
≥rdev_mö‹s
;

172 i‡(!
devmaj
)

173 
devidx
 = 
disk
->
fú°_mö‹
 / 
≥rdev_mö‹s
;

174  
devidx
;

175 
	}
}

177 
	$mmc_blk_put
(
mmc_blk_d©a
 *
md
)

179 
	`muãx_lock
(&
›í_lock
);

180 
md
->
ußge
--;

181 i‡(
md
->
ußge
 == 0) {

182 
devidx
 = 
	`mmc_gë_devidx
(
md
->
disk
);

183 
	`blk_˛ónup_queue
(
md
->
queue
.queue);

185 
	`__˛ór_bô
(
devidx
, 
dev_u£
);

187 
	`put_disk
(
md
->
disk
);

188 
	`k‰ì
(
md
);

190 
	`muãx_u∆ock
(&
›í_lock
);

191 
	}
}

193 
ssize_t
 
	$powî_ro_lock_show
(
devi˚
 *
dev
,

194 
devi˚_©åibuã
 *
©å
, *
buf
)

196 
ªt
;

197 
mmc_blk_d©a
 *
md
 = 
	`mmc_blk_gë
(
	`dev_to_disk
(
dev
));

198 
mmc_ˇrd
 *
ˇrd
 = 
md
->
queue
.card;

199 
locked
 = 0;

201 i‡(
ˇrd
->
ext_csd
.
boŸ_ro_lock
 & 
EXT_CSD_BOOT_WP_B_PERM_WP_EN
)

202 
locked
 = 2;

203 i‡(
ˇrd
->
ext_csd
.
boŸ_ro_lock
 & 
EXT_CSD_BOOT_WP_B_PWR_WP_EN
)

204 
locked
 = 1;

206 
ªt
 = 
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n", 
locked
);

208  
ªt
;

209 
	}
}

211 
ssize_t
 
	$powî_ro_lock_°‹e
(
devi˚
 *
dev
,

212 
devi˚_©åibuã
 *
©å
, c⁄° *
buf
, 
size_t
 
cou¡
)

214 
ªt
;

215 
mmc_blk_d©a
 *
md
, *
∑π_md
;

216 
mmc_ˇrd
 *
ˇrd
;

217 
£t
;

219 i‡(
	`k°πoul
(
buf
, 0, &
£t
))

220  -
EINVAL
;

222 i‡(
£t
 != 1)

223  
cou¡
;

225 
md
 = 
	`mmc_blk_gë
(
	`dev_to_disk
(
dev
));

226 
ˇrd
 = 
md
->
queue
.card;

228 
	`mmc_gë_ˇrd
(
ˇrd
);

230 
ªt
 = 
	`mmc_swôch
(
ˇrd
, 
EXT_CSD_CMD_SET_NORMAL
, 
EXT_CSD_BOOT_WP
,

231 
ˇrd
->
ext_csd
.
boŸ_ro_lock
 |

232 
EXT_CSD_BOOT_WP_B_PWR_WP_EN
,

233 
ˇrd
->
ext_csd
.
∑π_time
);

234 i‡(
ªt
)

235 
	`¥_îr
("%s: Lockög boŸÖ¨tôi⁄Ñÿu¡ûÇexàpowî o¿Áûed: %d\n", 
md
->
disk
->
disk_«me
, 
ªt
);

237 
ˇrd
->
ext_csd
.
boŸ_ro_lock
 |
EXT_CSD_BOOT_WP_B_PWR_WP_EN
;

239 
	`mmc_put_ˇrd
(
ˇrd
);

241 i‡(!
ªt
) {

242 
	`¥_öfo
("%s: Locking bootÖartitionÑo untilÇextÖower on\n",

243 
md
->
disk
->
disk_«me
);

244 
	`£t_disk_ro
(
md
->
disk
, 1);

246 
	`li°_f‹_óch_íåy
(
∑π_md
, &
md
->
∑π
,Öart)

247 i‡(
∑π_md
->
¨ó_ty≥
 =
MMC_BLK_DATA_AREA_BOOT
) {

248 
	`¥_öfo
("%s: Lockög boŸÖ¨tôi⁄Ñÿu¡ûÇexàpowî on\n", 
∑π_md
->
disk
->
disk_«me
);

249 
	`£t_disk_ro
(
∑π_md
->
disk
, 1);

253 
	`mmc_blk_put
(
md
);

254  
cou¡
;

255 
	}
}

257 
ssize_t
 
	$f‹˚_ro_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
,

258 *
buf
)

260 
ªt
;

261 
mmc_blk_d©a
 *
md
 = 
	`mmc_blk_gë
(
	`dev_to_disk
(
dev
));

263 
ªt
 = 
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d",

264 
	`gë_disk_ro
(
	`dev_to_disk
(
dev
)) ^

265 
md
->
ªad_⁄ly
);

266 
	`mmc_blk_put
(
md
);

267  
ªt
;

268 
	}
}

270 
ssize_t
 
	$f‹˚_ro_°‹e
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
,

271 c⁄° *
buf
, 
size_t
 
cou¡
)

273 
ªt
;

274 *
íd
;

275 
mmc_blk_d©a
 *
md
 = 
	`mmc_blk_gë
(
	`dev_to_disk
(
dev
));

276 
£t
 = 
	`sim∂e_°πoul
(
buf
, &
íd
, 0);

277 i‡(
íd
 =
buf
) {

278 
ªt
 = -
EINVAL
;

279 
out
;

282 
	`£t_disk_ro
(
	`dev_to_disk
(
dev
), 
£t
 || 
md
->
ªad_⁄ly
);

283 
ªt
 = 
cou¡
;

284 
out
:

285 
	`mmc_blk_put
(
md
);

286  
ªt
;

287 
	}
}

289 
	$mmc_blk_›í
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
)

291 
mmc_blk_d©a
 *
md
 = 
	`mmc_blk_gë
(
bdev
->
bd_disk
);

292 
ªt
 = -
ENXIO
;

294 
	`muãx_lock
(&
block_muãx
);

295 i‡(
md
) {

296 i‡(
md
->
ußge
 == 2)

297 
	`check_disk_ch™ge
(
bdev
);

298 
ªt
 = 0;

300 i‡((
mode
 & 
FMODE_WRITE
Ë&& 
md
->
ªad_⁄ly
) {

301 
	`mmc_blk_put
(
md
);

302 
ªt
 = -
EROFS
;

305 
	`muãx_u∆ock
(&
block_muãx
);

307  
ªt
;

308 
	}
}

310 
	$mmc_blk_ªÀa£
(
gídisk
 *
disk
, 
fmode_t
 
mode
)

312 
mmc_blk_d©a
 *
md
 = 
disk
->
¥iv©e_d©a
;

314 
	`muãx_lock
(&
block_muãx
);

315 
	`mmc_blk_put
(
md
);

316 
	`muãx_u∆ock
(&
block_muãx
);

317 
	}
}

320 
	$mmc_blk_gëgeo
(
block_devi˚
 *
bdev
, 
hd_geomëry
 *
geo
)

322 
geo
->
cylödîs
 = 
	`gë_ˇ∑côy
(
bdev
->
bd_disk
) / (4 * 16);

323 
geo
->
hóds
 = 4;

324 
geo
->
£˘‹s
 = 16;

326 
	}
}

328 
	smmc_blk_ioc_d©a
 {

329 
mmc_ioc_cmd
 
	mic
;

330 *
	mbuf
;

331 
u64
 
	mbuf_byãs
;

334 
mmc_blk_ioc_d©a
 *
	$mmc_blk_io˘l_c›y_‰om_u£r
(

335 
mmc_ioc_cmd
 
__u£r
 *
u£r
)

337 
mmc_blk_ioc_d©a
 *
id©a
;

338 
îr
;

340 
id©a
 = 
	`kzÆloc
((*id©a), 
GFP_KERNEL
);

341 i‡(!
id©a
) {

342 
îr
 = -
ENOMEM
;

343 
out
;

346 i‡(
	`c›y_‰om_u£r
(&
id©a
->
ic
, 
u£r
, (idata->ic))) {

347 
îr
 = -
EFAULT
;

348 
id©a_îr
;

351 
id©a
->
buf_byãs
 = (
u64
Ëid©a->
ic
.
blksz
 * id©a->ic.
blocks
;

352 i‡(
id©a
->
buf_byãs
 > 
MMC_IOC_MAX_BYTES
) {

353 
îr
 = -
EOVERFLOW
;

354 
id©a_îr
;

357 i‡(!
id©a
->
buf_byãs
)

358  
id©a
;

360 
id©a
->
buf
 = 
	`kzÆloc
(id©a->
buf_byãs
, 
GFP_KERNEL
);

361 i‡(!
id©a
->
buf
) {

362 
îr
 = -
ENOMEM
;

363 
id©a_îr
;

366 i‡(
	`c›y_‰om_u£r
(
id©a
->
buf
, (
__u£r
 *)()

367 
id©a
->
ic
.
d©a_±r
, id©a->
buf_byãs
)) {

368 
îr
 = -
EFAULT
;

369 
c›y_îr
;

372  
id©a
;

374 
c›y_îr
:

375 
	`k‰ì
(
id©a
->
buf
);

376 
id©a_îr
:

377 
	`k‰ì
(
id©a
);

378 
out
:

379  
	`ERR_PTR
(
îr
);

380 
	}
}

382 
	$io˘l_Ωmb_ˇrd_°©us_pﬁl
(
mmc_ˇrd
 *
ˇrd
, 
u32
 *
°©us
,

383 
u32
 
ªåõs_max
)

385 
îr
;

386 
u32
 
ªåy_cou¡
 = 0;

388 i‡(!
°©us
 || !
ªåõs_max
)

389  -
EINVAL
;

392 
îr
 = 
	`gë_ˇrd_°©us
(
ˇrd
, 
°©us
, 5);

393 i‡(
îr
)

396 i‡(!
	`R1_STATUS
(*
°©us
) &&

397 (
	`R1_CURRENT_STATE
(*
°©us
Ë!
R1_STATE_PRG
))

405 
	`u¶ìp_ønge
(1000, 5000);

406 } ++
ªåy_cou¡
 < 
ªåõs_max
);

408 i‡(
ªåy_cou¡
 =
ªåõs_max
)

409 
îr
 = -
EPERM
;

411  
îr
;

412 
	}
}

414 
	$io˘l_do_ßnôize
(
mmc_ˇrd
 *
ˇrd
)

416 
îr
;

418 i‡(!(
	`mmc_ˇn_ßnôize
(
ˇrd
) &&

419 (
ˇrd
->
ho°
->
ˇps2
 & 
MMC_CAP2_SANITIZE
))) {

420 
	`¥_w¨n
("%s: %s - SANITIZE isÇot supported\n",

421 
	`mmc_ho°«me
(
ˇrd
->
ho°
), 
__func__
);

422 
îr
 = -
EOPNOTSUPP
;

423 
out
;

426 
	`¥_debug
("%s: %s - SANITIZE IN PROGRESS...\n",

427 
	`mmc_ho°«me
(
ˇrd
->
ho°
), 
__func__
);

429 
îr
 = 
	`mmc_swôch
(
ˇrd
, 
EXT_CSD_CMD_SET_NORMAL
,

430 
EXT_CSD_SANITIZE_START
, 1,

431 
MMC_SANITIZE_REQ_TIMEOUT
);

433 i‡(
îr
)

434 
	`¥_îr
("%s: %s - EXT_CSD_SANITIZE_START failed.Érr=%d\n",

435 
	`mmc_ho°«me
(
ˇrd
->
ho°
), 
__func__
, 
îr
);

437 
	`¥_debug
("%s: %†- SANITIZE COMPLETED\n", 
	`mmc_ho°«me
(
ˇrd
->
ho°
),

438 
__func__
);

439 
out
:

440  
îr
;

441 
	}
}

443 
	$mmc_blk_io˘l_cmd
(
block_devi˚
 *
bdev
,

444 
mmc_ioc_cmd
 
__u£r
 *
ic_±r
)

446 
mmc_blk_ioc_d©a
 *
id©a
;

447 
mmc_blk_d©a
 *
md
;

448 
mmc_ˇrd
 *
ˇrd
;

449 
mmc_comm™d
 
cmd
 = {0};

450 
mmc_d©a
 
d©a
 = {0};

451 
mmc_ªque°
 
mrq
 = {
NULL
};

452 
sˇâîli°
 
sg
;

453 
îr
;

454 
is_Ωmb
 = 
Ál£
;

455 
u32
 
°©us
 = 0;

462 i‡((!
	`ˇ∑bÀ
(
CAP_SYS_RAWIO
)Ë|| (
bdev
 !bdev->
bd_c⁄èös
))

463  -
EPERM
;

465 
id©a
 = 
	`mmc_blk_io˘l_c›y_‰om_u£r
(
ic_±r
);

466 i‡(
	`IS_ERR
(
id©a
))

467  
	`PTR_ERR
(
id©a
);

469 
md
 = 
	`mmc_blk_gë
(
bdev
->
bd_disk
);

470 i‡(!
md
) {

471 
îr
 = -
EINVAL
;

472 
cmd_îr
;

475 i‡(
md
->
¨ó_ty≥
 & 
MMC_BLK_DATA_AREA_RPMB
)

476 
is_Ωmb
 = 
åue
;

478 
ˇrd
 = 
md
->
queue
.card;

479 i‡(
	`IS_ERR
(
ˇrd
)) {

480 
îr
 = 
	`PTR_ERR
(
ˇrd
);

481 
cmd_d⁄e
;

484 
cmd
.
›code
 = 
id©a
->
ic
.opcode;

485 
cmd
.
¨g
 = 
id©a
->
ic
.arg;

486 
cmd
.
Êags
 = 
id©a
->
ic
.flags;

488 i‡(
id©a
->
buf_byãs
) {

489 
d©a
.
sg
 = &sg;

490 
d©a
.
sg_Àn
 = 1;

491 
d©a
.
blksz
 = 
id©a
->
ic
.blksz;

492 
d©a
.
blocks
 = 
id©a
->
ic
.blocks;

494 
	`sg_öô_⁄e
(
d©a
.
sg
, 
id©a
->
buf
, id©a->
buf_byãs
);

496 i‡(
id©a
->
ic
.
wrôe_Êag
)

497 
d©a
.
Êags
 = 
MMC_DATA_WRITE
;

499 
d©a
.
Êags
 = 
MMC_DATA_READ
;

502 
	`mmc_£t_d©a_timeout
(&
d©a
, 
ˇrd
);

505 i‡(
id©a
->
ic
.
d©a_timeout_ns
)

506 
d©a
.
timeout_ns
 = 
id©a
->
ic
.
d©a_timeout_ns
;

508 i‡((
cmd
.
Êags
 & 
MMC_RSP_R1B
) == MMC_RSP_R1B) {

518 
d©a
.
timeout_ns
 = 
id©a
->
ic
.
cmd_timeout_ms
 * 1000000;

521 
mrq
.
d©a
 = &data;

524 
mrq
.
cmd
 = &cmd;

526 
	`mmc_gë_ˇrd
(
ˇrd
);

528 
îr
 = 
	`mmc_blk_∑π_swôch
(
ˇrd
, 
md
);

529 i‡(
îr
)

530 
cmd_ªl_ho°
;

532 i‡(
id©a
->
ic
.
is_acmd
) {

533 
îr
 = 
	`mmc_≠p_cmd
(
ˇrd
->
ho°
, card);

534 i‡(
îr
)

535 
cmd_ªl_ho°
;

538 i‡(
is_Ωmb
) {

539 
îr
 = 
	`mmc_£t_blockcou¡
(
ˇrd
, 
d©a
.
blocks
,

540 
id©a
->
ic
.
wrôe_Êag
 & (1 << 31));

541 i‡(
îr
)

542 
cmd_ªl_ho°
;

545 i‡((
	`MMC_EXTRACT_INDEX_FROM_ARG
(
cmd
.
¨g
Ë=
EXT_CSD_SANITIZE_START
) &&

546 (
cmd
.
›code
 =
MMC_SWITCH
)) {

547 
îr
 = 
	`io˘l_do_ßnôize
(
ˇrd
);

549 i‡(
îr
)

550 
	`¥_îr
("%s: ioctl_do_sanitize() failed.Érr = %d",

551 
__func__
, 
îr
);

553 
cmd_ªl_ho°
;

556 
	`mmc_waô_f‹_ªq
(
ˇrd
->
ho°
, &
mrq
);

558 i‡(
cmd
.
îr‹
) {

559 
	`dev_îr
(
	`mmc_dev
(
ˇrd
->
ho°
), "%s: cmdÉrror %d\n",

560 
__func__
, 
cmd
.
îr‹
);

561 
îr
 = 
cmd
.
îr‹
;

562 
cmd_ªl_ho°
;

564 i‡(
d©a
.
îr‹
) {

565 
	`dev_îr
(
	`mmc_dev
(
ˇrd
->
ho°
), "%s: dataÉrror %d\n",

566 
__func__
, 
d©a
.
îr‹
);

567 
îr
 = 
d©a
.
îr‹
;

568 
cmd_ªl_ho°
;

575 i‡(
id©a
->
ic
.
po°¶ìp_mö_us
)

576 
	`u¶ìp_ønge
(
id©a
->
ic
.
po°¶ìp_mö_us
, id©a->ic.
po°¶ìp_max_us
);

578 i‡(
	`c›y_to_u£r
(&(
ic_±r
->
ª•⁄£
), 
cmd
.
ª•
, (cmd.resp))) {

579 
îr
 = -
EFAULT
;

580 
cmd_ªl_ho°
;

583 i‡(!
id©a
->
ic
.
wrôe_Êag
) {

584 i‡(
	`c›y_to_u£r
((
__u£r
 *)(Ë
id©a
->
ic
.
d©a_±r
,

585 
id©a
->
buf
, id©a->
buf_byãs
)) {

586 
îr
 = -
EFAULT
;

587 
cmd_ªl_ho°
;

591 i‡(
is_Ωmb
) {

596 
îr
 = 
	`io˘l_Ωmb_ˇrd_°©us_pﬁl
(
ˇrd
, &
°©us
, 5);

597 i‡(
îr
)

598 
	`dev_îr
(
	`mmc_dev
(
ˇrd
->
ho°
),

600 
__func__
, 
°©us
, 
îr
);

603 
cmd_ªl_ho°
:

604 
	`mmc_put_ˇrd
(
ˇrd
);

606 
cmd_d⁄e
:

607 
	`mmc_blk_put
(
md
);

608 
cmd_îr
:

609 
	`k‰ì
(
id©a
->
buf
);

610 
	`k‰ì
(
id©a
);

611  
îr
;

612 
	}
}

614 
	$mmc_blk_io˘l
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
,

615 
cmd
, 
¨g
)

617 
ªt
 = -
EINVAL
;

618 i‡(
cmd
 =
MMC_IOC_CMD
)

619 
ªt
 = 
	`mmc_blk_io˘l_cmd
(
bdev
, (
mmc_ioc_cmd
 
__u£r
 *)
¨g
);

620  
ªt
;

621 
	}
}

623 #ifde‡
CONFIG_COMPAT


624 
	$mmc_blk_com∑t_io˘l
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
,

625 
cmd
, 
¨g
)

627  
	`mmc_blk_io˘l
(
bdev
, 
mode
, 
cmd
, (Ë
	`com∑t_±r
(
¨g
));

628 
	}
}

631 c⁄° 
block_devi˚_›î©i⁄s
 
	gmmc_bd›s
 = {

632 .
›í
 = 
mmc_blk_›í
,

633 .
	gªÀa£
 = 
mmc_blk_ªÀa£
,

634 .
	ggëgeo
 = 
mmc_blk_gëgeo
,

635 .
	gow√r
 = 
THIS_MODULE
,

636 .
	gio˘l
 = 
mmc_blk_io˘l
,

637 #ifde‡
CONFIG_COMPAT


638 .
	gcom∑t_io˘l
 = 
mmc_blk_com∑t_io˘l
,

642 
ölöe
 
	$mmc_blk_∑π_swôch
(
mmc_ˇrd
 *
ˇrd
,

643 
mmc_blk_d©a
 *
md
)

645 
ªt
;

646 
mmc_blk_d©a
 *
maö_md
 = 
	`mmc_gë_drvd©a
(
ˇrd
);

648 i‡(
maö_md
->
∑π_cuº
 =
md
->
∑π_ty≥
)

651 i‡(
	`mmc_ˇrd_mmc
(
ˇrd
)) {

652 
u8
 
∑π_c⁄fig
 = 
ˇrd
->
ext_csd
.part_config;

654 
∑π_c⁄fig
 &~
EXT_CSD_PART_CONFIG_ACC_MASK
;

655 
∑π_c⁄fig
 |
md
->
∑π_ty≥
;

657 
ªt
 = 
	`mmc_swôch
(
ˇrd
, 
EXT_CSD_CMD_SET_NORMAL
,

658 
EXT_CSD_PART_CONFIG
, 
∑π_c⁄fig
,

659 
ˇrd
->
ext_csd
.
∑π_time
);

660 i‡(
ªt
)

661  
ªt
;

663 
ˇrd
->
ext_csd
.
∑π_c⁄fig
 =Öart_config;

666 
maö_md
->
∑π_cuº
 = 
md
->
∑π_ty≥
;

668 
	}
}

670 
u32
 
	$mmc_sd_num_wr_blocks
(
mmc_ˇrd
 *
ˇrd
)

672 
îr
;

673 
u32
 
ªsu…
;

674 
__be32
 *
blocks
;

676 
mmc_ªque°
 
mrq
 = {
NULL
};

677 
mmc_comm™d
 
cmd
 = {0};

678 
mmc_d©a
 
d©a
 = {0};

680 
sˇâîli°
 
sg
;

682 
cmd
.
›code
 = 
MMC_APP_CMD
;

683 
cmd
.
¨g
 = 
ˇrd
->
rˇ
 << 16;

684 
cmd
.
Êags
 = 
MMC_RSP_SPI_R1
 | 
MMC_RSP_R1
 | 
MMC_CMD_AC
;

686 
îr
 = 
	`mmc_waô_f‹_cmd
(
ˇrd
->
ho°
, &
cmd
, 0);

687 i‡(
îr
)

688  (
u32
)-1;

689 i‡(!
	`mmc_ho°_is_•i
(
ˇrd
->
ho°
Ë&& !(
cmd
.
ª•
[0] & 
R1_APP_CMD
))

690  (
u32
)-1;

692 
	`mem£t
(&
cmd
, 0, (
mmc_comm™d
));

694 
cmd
.
›code
 = 
SD_APP_SEND_NUM_WR_BLKS
;

695 
cmd
.
¨g
 = 0;

696 
cmd
.
Êags
 = 
MMC_RSP_SPI_R1
 | 
MMC_RSP_R1
 | 
MMC_CMD_ADTC
;

698 
d©a
.
blksz
 = 4;

699 
d©a
.
blocks
 = 1;

700 
d©a
.
Êags
 = 
MMC_DATA_READ
;

701 
d©a
.
sg
 = &sg;

702 
d©a
.
sg_Àn
 = 1;

703 
	`mmc_£t_d©a_timeout
(&
d©a
, 
ˇrd
);

705 
mrq
.
cmd
 = &cmd;

706 
mrq
.
d©a
 = &data;

708 
blocks
 = 
	`kmÆloc
(4, 
GFP_KERNEL
);

709 i‡(!
blocks
)

710  (
u32
)-1;

712 
	`sg_öô_⁄e
(&
sg
, 
blocks
, 4);

714 
	`mmc_waô_f‹_ªq
(
ˇrd
->
ho°
, &
mrq
);

716 
ªsu…
 = 
	`¡ohl
(*
blocks
);

717 
	`k‰ì
(
blocks
);

719 i‡(
cmd
.
îr‹
 || 
d©a
.error)

720 
ªsu…
 = (
u32
)-1;

722  
ªsu…
;

723 
	}
}

725 
	$£nd_°›
(
mmc_ˇrd
 *
ˇrd
, 
u32
 *
°©us
)

727 
mmc_comm™d
 
cmd
 = {0};

728 
îr
;

730 
cmd
.
›code
 = 
MMC_STOP_TRANSMISSION
;

731 
cmd
.
Êags
 = 
MMC_RSP_SPI_R1B
 | 
MMC_RSP_R1B
 | 
MMC_CMD_AC
;

732 
îr
 = 
	`mmc_waô_f‹_cmd
(
ˇrd
->
ho°
, &
cmd
, 5);

733 i‡(
îr
 == 0)

734 *
°©us
 = 
cmd
.
ª•
[0];

735  
îr
;

736 
	}
}

738 
	$gë_ˇrd_°©us
(
mmc_ˇrd
 *
ˇrd
, 
u32
 *
°©us
, 
ªåõs
)

740 
mmc_comm™d
 
cmd
 = {0};

741 
îr
;

743 
cmd
.
›code
 = 
MMC_SEND_STATUS
;

744 i‡(!
	`mmc_ho°_is_•i
(
ˇrd
->
ho°
))

745 
cmd
.
¨g
 = 
ˇrd
->
rˇ
 << 16;

746 
cmd
.
Êags
 = 
MMC_RSP_SPI_R2
 | 
MMC_RSP_R1
 | 
MMC_CMD_AC
;

747 
îr
 = 
	`mmc_waô_f‹_cmd
(
ˇrd
->
ho°
, &
cmd
, 
ªåõs
);

748 i‡(
îr
 == 0)

749 *
°©us
 = 
cmd
.
ª•
[0];

750  
îr
;

751 
	}
}

753 
	#ERR_NOMEDIUM
 3

	)

754 
	#ERR_RETRY
 2

	)

755 
	#ERR_ABORT
 1

	)

756 
	#ERR_CONTINUE
 0

	)

758 
	$mmc_blk_cmd_îr‹
(
ªque°
 *
ªq
, c⁄° *
«me
, 
îr‹
,

759 
boﬁ
 
°©us_vÆid
, 
u32
 
°©us
)

761 
îr‹
) {

762 -
EILSEQ
:

764 
	`¥_îr
("%s: %s sending %s command, card status %#x\n",

765 
ªq
->
rq_disk
->
disk_«me
, "response CRCÉrror",

766 
«me
, 
°©us
);

767  
ERR_RETRY
;

769 -
ETIMEDOUT
:

770 
	`¥_îr
("%s: %s sending %s command, card status %#x\n",

771 
ªq
->
rq_disk
->
disk_«me
, "timed out", 
«me
, 
°©us
);

774 i‡(!
°©us_vÆid
)

775  
ERR_RETRY
;

782 i‡(
°©us
 & (
R1_COM_CRC_ERROR
 | 
R1_ILLEGAL_COMMAND
))

783  
ERR_RETRY
;

786  
ERR_ABORT
;

790 
	`¥_îr
("%s: unknownÉrror %d sendingÑead/write command, card status %#x\n",

791 
ªq
->
rq_disk
->
disk_«me
, 
îr‹
, 
°©us
);

792  
ERR_ABORT
;

794 
	}
}

814 
	$mmc_blk_cmd_ªcovîy
(
mmc_ˇrd
 *
ˇrd
, 
ªque°
 *
ªq
,

815 
mmc_blk_ªque°
 *
brq
, *
ecc_îr
, *
gí_îr
)

817 
boﬁ
 
¥ev_cmd_°©us_vÆid
 = 
åue
;

818 
u32
 
°©us
, 
°›_°©us
 = 0;

819 
îr
, 
ªåy
;

821 i‡(
	`mmc_ˇrd_ªmoved
(
ˇrd
))

822  
ERR_NOMEDIUM
;

829 
ªåy
 = 2;Ñetry >= 0;Ñetry--) {

830 
îr
 = 
	`gë_ˇrd_°©us
(
ˇrd
, &
°©us
, 0);

831 i‡(!
îr
)

834 
¥ev_cmd_°©us_vÆid
 = 
Ál£
;

835 
	`¥_îr
("%s:Érror %d sending status command, %sing\n",

836 
ªq
->
rq_disk
->
disk_«me
, 
îr
, 
ªåy
 ? "retry" : "abort");

840 i‡(
îr
) {

842 i‡(
	`mmc_dëe˘_ˇrd_ªmoved
(
ˇrd
->
ho°
))

843  
ERR_NOMEDIUM
;

844  
ERR_ABORT
;

848 i‡((
°©us
 & 
R1_CARD_ECC_FAILED
) ||

849 (
brq
->
°›
.
ª•
[0] & 
R1_CARD_ECC_FAILED
) ||

850 (
brq
->
cmd
.
ª•
[0] & 
R1_CARD_ECC_FAILED
))

851 *
ecc_îr
 = 1;

854 i‡(!
	`mmc_ho°_is_•i
(
ˇrd
->
ho°
Ë&& 
	`rq_d©a_dú
(
ªq
Ë!
READ
)

855 i‡((
°©us
 & 
R1_ERROR
) ||

856 (
brq
->
°›
.
ª•
[0] & 
R1_ERROR
)) {

857 
	`¥_îr
("%s: %s: generalÉrror sending stop or status command, stop cmdÑesponse %#x, card status %#x\n",

858 
ªq
->
rq_disk
->
disk_«me
, 
__func__
,

859 
brq
->
°›
.
ª•
[0], 
°©us
);

860 *
gí_îr
 = 1;

867 i‡(
	`R1_CURRENT_STATE
(
°©us
Ë=
R1_STATE_DATA
 ||

868 
	`R1_CURRENT_STATE
(
°©us
Ë=
R1_STATE_RCV
) {

869 
îr
 = 
	`£nd_°›
(
ˇrd
, &
°›_°©us
);

870 i‡(
îr
)

871 
	`¥_îr
("%s:Érror %d sending stop command\n",

872 
ªq
->
rq_disk
->
disk_«me
, 
îr
);

878 i‡(
îr
)

879  
ERR_ABORT
;

880 i‡(
°›_°©us
 & 
R1_CARD_ECC_FAILED
)

881 *
ecc_îr
 = 1;

882 i‡(!
	`mmc_ho°_is_•i
(
ˇrd
->
ho°
Ë&& 
	`rq_d©a_dú
(
ªq
Ë!
READ
)

883 i‡(
°›_°©us
 & 
R1_ERROR
) {

884 
	`¥_îr
("%s: %s: generalÉrror sending stop command, stop cmdÑesponse %#x\n",

885 
ªq
->
rq_disk
->
disk_«me
, 
__func__
,

886 
°›_°©us
);

887 *
gí_îr
 = 1;

892 i‡(
brq
->
sbc
.
îr‹
)

893  
	`mmc_blk_cmd_îr‹
(
ªq
, "SET_BLOCK_COUNT", 
brq
->
sbc
.
îr‹
,

894 
¥ev_cmd_°©us_vÆid
, 
°©us
);

897 i‡(
brq
->
cmd
.
îr‹
)

898  
	`mmc_blk_cmd_îr‹
(
ªq
, "r/w cmd", 
brq
->
cmd
.
îr‹
,

899 
¥ev_cmd_°©us_vÆid
, 
°©us
);

902 i‡(!
brq
->
°›
.
îr‹
)

903  
ERR_CONTINUE
;

906 
	`¥_îr
("%s:Érror %d sending stop command, original cmdÑesponse %#x, card status %#x\n",

907 
ªq
->
rq_disk
->
disk_«me
, 
brq
->
°›
.
îr‹
,

908 
brq
->
cmd
.
ª•
[0], 
°©us
);

914 i‡(
°›_°©us
) {

915 
brq
->
°›
.
ª•
[0] = 
°›_°©us
;

916 
brq
->
°›
.
îr‹
 = 0;

918  
ERR_CONTINUE
;

919 
	}
}

921 
	$mmc_blk_ª£t
(
mmc_blk_d©a
 *
md
, 
mmc_ho°
 *
ho°
,

922 
ty≥
)

924 
îr
;

926 i‡(
md
->
ª£t_d⁄e
 & 
ty≥
)

927  -
EEXIST
;

929 
md
->
ª£t_d⁄e
 |
ty≥
;

930 
îr
 = 
	`mmc_hw_ª£t
(
ho°
);

932 i‡(
îr
 !-
EOPNOTSUPP
) {

933 
mmc_blk_d©a
 *
maö_md
 = 
	`mmc_gë_drvd©a
(
ho°
->
ˇrd
);

934 
∑π_îr
;

936 
maö_md
->
∑π_cuº
 = maö_md->
∑π_ty≥
;

937 
∑π_îr
 = 
	`mmc_blk_∑π_swôch
(
ho°
->
ˇrd
, 
md
);

938 i‡(
∑π_îr
) {

943  -
ENODEV
;

946  
îr
;

947 
	}
}

949 
ölöe
 
	$mmc_blk_ª£t_suc˚ss
(
mmc_blk_d©a
 *
md
, 
ty≥
)

951 
md
->
ª£t_d⁄e
 &~
ty≥
;

952 
	}
}

954 
	$mmc_blk_issue_disˇrd_rq
(
mmc_queue
 *
mq
, 
ªque°
 *
ªq
)

956 
mmc_blk_d©a
 *
md
 = 
mq
->
d©a
;

957 
mmc_ˇrd
 *
ˇrd
 = 
md
->
queue
.card;

958 
‰om
, 
ƒ
, 
¨g
;

959 
îr
 = 0, 
ty≥
 = 
MMC_BLK_DISCARD
;

961 i‡(!
	`mmc_ˇn_îa£
(
ˇrd
)) {

962 
îr
 = -
EOPNOTSUPP
;

963 
out
;

966 
‰om
 = 
	`blk_rq_pos
(
ªq
);

967 
ƒ
 = 
	`blk_rq_£˘‹s
(
ªq
);

969 i‡(
	`mmc_ˇn_disˇrd
(
ˇrd
))

970 
¨g
 = 
MMC_DISCARD_ARG
;

971 i‡(
	`mmc_ˇn_åim
(
ˇrd
))

972 
¨g
 = 
MMC_TRIM_ARG
;

974 
¨g
 = 
MMC_ERASE_ARG
;

975 
ªåy
:

976 i‡(
ˇrd
->
quúks
 & 
MMC_QUIRK_INAND_CMD38
) {

977 
îr
 = 
	`mmc_swôch
(
ˇrd
, 
EXT_CSD_CMD_SET_NORMAL
,

978 
INAND_CMD38_ARG_EXT_CSD
,

979 
¨g
 =
MMC_TRIM_ARG
 ?

980 
INAND_CMD38_ARG_TRIM
 :

981 
INAND_CMD38_ARG_ERASE
,

983 i‡(
îr
)

984 
out
;

986 
îr
 = 
	`mmc_îa£
(
ˇrd
, 
‰om
, 
ƒ
, 
¨g
);

987 
out
:

988 i‡(
îr
 =-
EIO
 && !
	`mmc_blk_ª£t
(
md
, 
ˇrd
->
ho°
, 
ty≥
))

989 
ªåy
;

990 i‡(!
îr
)

991 
	`mmc_blk_ª£t_suc˚ss
(
md
, 
ty≥
);

992 
	`blk_íd_ªque°
(
ªq
, 
îr
, 
	`blk_rq_byãs
(req));

994  
îr
 ? 0 : 1;

995 
	}
}

997 
	$mmc_blk_issue_£cdisˇrd_rq
(
mmc_queue
 *
mq
,

998 
ªque°
 *
ªq
)

1000 
mmc_blk_d©a
 *
md
 = 
mq
->
d©a
;

1001 
mmc_ˇrd
 *
ˇrd
 = 
md
->
queue
.card;

1002 
‰om
, 
ƒ
, 
¨g
;

1003 
îr
 = 0, 
ty≥
 = 
MMC_BLK_SECDISCARD
;

1005 i‡(!(
	`mmc_ˇn_£cuª_îa£_åim
(
ˇrd
))) {

1006 
îr
 = -
EOPNOTSUPP
;

1007 
out
;

1010 
‰om
 = 
	`blk_rq_pos
(
ªq
);

1011 
ƒ
 = 
	`blk_rq_£˘‹s
(
ªq
);

1013 i‡(
	`mmc_ˇn_åim
(
ˇrd
Ë&& !
	`mmc_îa£_group_Æig√d
(ˇrd, 
‰om
, 
ƒ
))

1014 
¨g
 = 
MMC_SECURE_TRIM1_ARG
;

1016 
¨g
 = 
MMC_SECURE_ERASE_ARG
;

1018 
ªåy
:

1019 i‡(
ˇrd
->
quúks
 & 
MMC_QUIRK_INAND_CMD38
) {

1020 
îr
 = 
	`mmc_swôch
(
ˇrd
, 
EXT_CSD_CMD_SET_NORMAL
,

1021 
INAND_CMD38_ARG_EXT_CSD
,

1022 
¨g
 =
MMC_SECURE_TRIM1_ARG
 ?

1023 
INAND_CMD38_ARG_SECTRIM1
 :

1024 
INAND_CMD38_ARG_SECERASE
,

1026 i‡(
îr
)

1027 
out_ªåy
;

1030 
îr
 = 
	`mmc_îa£
(
ˇrd
, 
‰om
, 
ƒ
, 
¨g
);

1031 i‡(
îr
 =-
EIO
)

1032 
out_ªåy
;

1033 i‡(
îr
)

1034 
out
;

1036 i‡(
¨g
 =
MMC_SECURE_TRIM1_ARG
) {

1037 i‡(
ˇrd
->
quúks
 & 
MMC_QUIRK_INAND_CMD38
) {

1038 
îr
 = 
	`mmc_swôch
(
ˇrd
, 
EXT_CSD_CMD_SET_NORMAL
,

1039 
INAND_CMD38_ARG_EXT_CSD
,

1040 
INAND_CMD38_ARG_SECTRIM2
,

1042 i‡(
îr
)

1043 
out_ªåy
;

1046 
îr
 = 
	`mmc_îa£
(
ˇrd
, 
‰om
, 
ƒ
, 
MMC_SECURE_TRIM2_ARG
);

1047 i‡(
îr
 =-
EIO
)

1048 
out_ªåy
;

1049 i‡(
îr
)

1050 
out
;

1053 
out_ªåy
:

1054 i‡(
îr
 && !
	`mmc_blk_ª£t
(
md
, 
ˇrd
->
ho°
, 
ty≥
))

1055 
ªåy
;

1056 i‡(!
îr
)

1057 
	`mmc_blk_ª£t_suc˚ss
(
md
, 
ty≥
);

1058 
out
:

1059 
	`blk_íd_ªque°
(
ªq
, 
îr
, 
	`blk_rq_byãs
(req));

1061  
îr
 ? 0 : 1;

1062 
	}
}

1064 
	$mmc_blk_issue_Êush
(
mmc_queue
 *
mq
, 
ªque°
 *
ªq
)

1066 
mmc_blk_d©a
 *
md
 = 
mq
->
d©a
;

1067 
mmc_ˇrd
 *
ˇrd
 = 
md
->
queue
.card;

1068 
ªt
 = 0;

1070 
ªt
 = 
	`mmc_Êush_ˇche
(
ˇrd
);

1071 i‡(
ªt
)

1072 
ªt
 = -
EIO
;

1074 
	`blk_íd_ªque°_Æl
(
ªq
, 
ªt
);

1076  
ªt
 ? 0 : 1;

1077 
	}
}

1086 
ölöe
 
	$mmc_≠∂y_ªl_rw
(
mmc_blk_ªque°
 *
brq
,

1087 
mmc_ˇrd
 *
ˇrd
,

1088 
ªque°
 *
ªq
)

1090 i‡(!(
ˇrd
->
ext_csd
.
ªl_∑øm
 & 
EXT_CSD_WR_REL_PARAM_EN
)) {

1092 i‡(!
	`IS_ALIGNED
(
brq
->
cmd
.
¨g
, 
ˇrd
->
ext_csd
.
ªl_£˘‹s
))

1093 
brq
->
d©a
.
blocks
 = 1;

1095 i‡(
brq
->
d©a
.
blocks
 > 
ˇrd
->
ext_csd
.
ªl_£˘‹s
)

1096 
brq
->
d©a
.
blocks
 = 
ˇrd
->
ext_csd
.
ªl_£˘‹s
;

1097 i‡(
brq
->
d©a
.
blocks
 < 
ˇrd
->
ext_csd
.
ªl_£˘‹s
)

1098 
brq
->
d©a
.
blocks
 = 1;

1100 
	}
}

1102 
	#CMD_ERRORS
 \

1103 (
R1_OUT_OF_RANGE
 | \

1104 
R1_ADDRESS_ERROR
 | \

1105 
R1_BLOCK_LEN_ERROR
 | \

1106 
R1_WP_VIOLATION
 | \

1107 
R1_CC_ERROR
 | \

1108 
R1_ERROR
Ë

	)

1110 
	$mmc_blk_îr_check
(
mmc_ˇrd
 *
ˇrd
,

1111 
mmc_async_ªq
 *
¨eq
)

1113 
mmc_queue_ªq
 *
mq_mrq
 = 
	`c⁄èöî_of
(
¨eq
, mmc_queue_req,

1114 
mmc_a˘ive
);

1115 
mmc_blk_ªque°
 *
brq
 = &
mq_mrq
->brq;

1116 
ªque°
 *
ªq
 = 
mq_mrq
->req;

1117 
ecc_îr
 = 0, 
gí_îr
 = 0;

1129 i‡(
brq
->
sbc
.
îr‹
 || brq->
cmd
.îr‹ || brq->
°›
.error ||

1130 
brq
->
d©a
.
îr‹
) {

1131 
	`mmc_blk_cmd_ªcovîy
(
ˇrd
, 
ªq
, 
brq
, &
ecc_îr
, &
gí_îr
)) {

1132 
ERR_RETRY
:

1133  
MMC_BLK_RETRY
;

1134 
ERR_ABORT
:

1135  
MMC_BLK_ABORT
;

1136 
ERR_NOMEDIUM
:

1137  
MMC_BLK_NOMEDIUM
;

1138 
ERR_CONTINUE
:

1148 i‡(
brq
->
cmd
.
ª•
[0] & 
CMD_ERRORS
) {

1149 
	`¥_îr
("%s:Ñ/w command failed, status = %#x\n",

1150 
ªq
->
rq_disk
->
disk_«me
, 
brq
->
cmd
.
ª•
[0]);

1151  
MMC_BLK_ABORT
;

1159 i‡(!
	`mmc_ho°_is_•i
(
ˇrd
->
ho°
Ë&& 
	`rq_d©a_dú
(
ªq
Ë!
READ
) {

1160 
u32
 
°©us
;

1161 
timeout
;

1164 i‡(
brq
->
°›
.
ª•
[0] & 
R1_ERROR
) {

1165 
	`¥_îr
("%s: %s: generalÉrror sending stop command, stop cmdÑesponse %#x\n",

1166 
ªq
->
rq_disk
->
disk_«me
, 
__func__
,

1167 
brq
->
°›
.
ª•
[0]);

1168 
gí_îr
 = 1;

1171 
timeout
 = 
jiffõs
 + 
	`m£cs_to_jiffõs
(
MMC_BLK_TIMEOUT_MS
);

1173 
îr
 = 
	`gë_ˇrd_°©us
(
ˇrd
, &
°©us
, 5);

1174 i‡(
îr
) {

1175 
	`¥_îr
("%s:Érror %dÑequesting status\n",

1176 
ªq
->
rq_disk
->
disk_«me
, 
îr
);

1177  
MMC_BLK_CMD_ERR
;

1180 i‡(
°©us
 & 
R1_ERROR
) {

1181 
	`¥_îr
("%s: %s: generalÉrror sending status command, card status %#x\n",

1182 
ªq
->
rq_disk
->
disk_«me
, 
__func__
,

1183 
°©us
);

1184 
gí_îr
 = 1;

1190 i‡(
	`time_a·î
(
jiffõs
, 
timeout
)) {

1191 
	`¥_îr
("%s: Card stuck inÖrogramming state!"\

1192 " %†%s\n", 
	`mmc_ho°«me
(
ˇrd
->
ho°
),

1193 
ªq
->
rq_disk
->
disk_«me
, 
__func__
);

1195  
MMC_BLK_CMD_ERR
;

1202 } !(
°©us
 & 
R1_READY_FOR_DATA
) ||

1203 (
	`R1_CURRENT_STATE
(
°©us
Ë=
R1_STATE_PRG
));

1207 i‡(
gí_îr
) {

1208 
	`¥_w¨n
("%s:Ñetrying write for generalÉrror\n",

1209 
ªq
->
rq_disk
->
disk_«me
);

1210  
MMC_BLK_RETRY
;

1213 i‡(
brq
->
d©a
.
îr‹
) {

1214 
	`¥_îr
("%s:Érror %dÅransferring data, sector %u,Çr %u, cmdÑesponse %#x, card status %#x\n",

1215 
ªq
->
rq_disk
->
disk_«me
, 
brq
->
d©a
.
îr‹
,

1216 ()
	`blk_rq_pos
(
ªq
),

1217 ()
	`blk_rq_£˘‹s
(
ªq
),

1218 
brq
->
cmd
.
ª•
[0], brq->
°›
.resp[0]);

1220 i‡(
	`rq_d©a_dú
(
ªq
Ë=
READ
) {

1221 i‡(
ecc_îr
)

1222  
MMC_BLK_ECC_ERR
;

1223  
MMC_BLK_DATA_ERR
;

1225  
MMC_BLK_CMD_ERR
;

1229 i‡(!
brq
->
d©a
.
byãs_x„ªd
)

1230  
MMC_BLK_RETRY
;

1232 i‡(
	`mmc_∑cked_cmd
(
mq_mrq
->
cmd_ty≥
)) {

1233 i‡(
	`u∆ikñy
(
brq
->
d©a
.
blocks
 << 9 !brq->d©a.
byãs_x„ªd
))

1234  
MMC_BLK_PARTIAL
;

1236  
MMC_BLK_SUCCESS
;

1239 i‡(
	`blk_rq_byãs
(
ªq
Ë!
brq
->
d©a
.
byãs_x„ªd
)

1240  
MMC_BLK_PARTIAL
;

1242  
MMC_BLK_SUCCESS
;

1243 
	}
}

1245 
	$mmc_blk_∑cked_îr_check
(
mmc_ˇrd
 *
ˇrd
,

1246 
mmc_async_ªq
 *
¨eq
)

1248 
mmc_queue_ªq
 *
mq_rq
 = 
	`c⁄èöî_of
(
¨eq
, mmc_queue_req,

1249 
mmc_a˘ive
);

1250 
ªque°
 *
ªq
 = 
mq_rq
->req;

1251 
mmc_∑cked
 *
∑cked
 = 
mq_rq
->packed;

1252 
îr
, 
check
, 
°©us
;

1253 
u8
 *
ext_csd
;

1255 
	`BUG_ON
(!
∑cked
);

1257 
∑cked
->
ªåõs
--;

1258 
check
 = 
	`mmc_blk_îr_check
(
ˇrd
, 
¨eq
);

1259 
îr
 = 
	`gë_ˇrd_°©us
(
ˇrd
, &
°©us
, 0);

1260 i‡(
îr
) {

1261 
	`¥_îr
("%s:Érror %d sending status command\n",

1262 
ªq
->
rq_disk
->
disk_«me
, 
îr
);

1263  
MMC_BLK_ABORT
;

1266 i‡(
°©us
 & 
R1_EXCEPTION_EVENT
) {

1267 
ext_csd
 = 
	`kzÆloc
(512, 
GFP_KERNEL
);

1268 i‡(!
ext_csd
) {

1269 
	`¥_îr
("%s: unableÅoállocate buffer forÉxt_csd\n",

1270 
ªq
->
rq_disk
->
disk_«me
);

1271  -
ENOMEM
;

1274 
îr
 = 
	`mmc_£nd_ext_csd
(
ˇrd
, 
ext_csd
);

1275 i‡(
îr
) {

1276 
	`¥_îr
("%s:Érror %d sendingÉxt_csd\n",

1277 
ªq
->
rq_disk
->
disk_«me
, 
îr
);

1278 
check
 = 
MMC_BLK_ABORT
;

1279 
‰ì
;

1282 i‡((
ext_csd
[
EXT_CSD_EXP_EVENTS_STATUS
] &

1283 
EXT_CSD_PACKED_FAILURE
) &&

1284 (
ext_csd
[
EXT_CSD_PACKED_CMD_STATUS
] &

1285 
EXT_CSD_PACKED_GENERIC_ERROR
)) {

1286 i‡(
ext_csd
[
EXT_CSD_PACKED_CMD_STATUS
] &

1287 
EXT_CSD_PACKED_INDEXED_ERROR
) {

1288 
∑cked
->
idx_Áûuª
 =

1289 
ext_csd
[
EXT_CSD_PACKED_FAILURE_INDEX
] - 1;

1290 
check
 = 
MMC_BLK_PARTIAL
;

1292 
	`¥_îr
("%s:Öacked cmd failed,Çr %u, sectors %u, "

1294 
ªq
->
rq_disk
->
disk_«me
, 
∑cked
->
ƒ_íåõs
,

1295 
∑cked
->
blocks
,Öacked->
idx_Áûuª
);

1297 
‰ì
:

1298 
	`k‰ì
(
ext_csd
);

1301  
check
;

1302 
	}
}

1304 
	$mmc_blk_rw_rq_¥ï
(
mmc_queue_ªq
 *
mqrq
,

1305 
mmc_ˇrd
 *
ˇrd
,

1306 
dißbÀ_mu…i
,

1307 
mmc_queue
 *
mq
)

1309 
u32
 
ªadcmd
, 
wrôecmd
;

1310 
mmc_blk_ªque°
 *
brq
 = &
mqrq
->brq;

1311 
ªque°
 *
ªq
 = 
mqrq
->req;

1312 
mmc_blk_d©a
 *
md
 = 
mq
->
d©a
;

1313 
boﬁ
 
do_d©a_èg
;

1322 
boﬁ
 
do_ªl_wr
 = ((
ªq
->
cmd_Êags
 & 
REQ_FUA
) ||

1323 (
ªq
->
cmd_Êags
 & 
REQ_META
)) &&

1324 (
	`rq_d©a_dú
(
ªq
Ë=
WRITE
) &&

1325 (
md
->
Êags
 & 
MMC_BLK_REL_WR
);

1327 
	`mem£t
(
brq
, 0, (
mmc_blk_ªque°
));

1328 
brq
->
mrq
.
cmd
 = &brq->cmd;

1329 
brq
->
mrq
.
d©a
 = &brq->data;

1331 
brq
->
cmd
.
¨g
 = 
	`blk_rq_pos
(
ªq
);

1332 i‡(!
	`mmc_ˇrd_blockaddr
(
ˇrd
))

1333 
brq
->
cmd
.
¨g
 <<= 9;

1334 
brq
->
cmd
.
Êags
 = 
MMC_RSP_SPI_R1
 | 
MMC_RSP_R1
 | 
MMC_CMD_ADTC
;

1335 
brq
->
d©a
.
blksz
 = 512;

1336 
brq
->
°›
.
›code
 = 
MMC_STOP_TRANSMISSION
;

1337 
brq
->
°›
.
¨g
 = 0;

1338 
brq
->
°›
.
Êags
 = 
MMC_RSP_SPI_R1B
 | 
MMC_RSP_R1B
 | 
MMC_CMD_AC
;

1339 
brq
->
d©a
.
blocks
 = 
	`blk_rq_£˘‹s
(
ªq
);

1346 i‡(
brq
->
d©a
.
blocks
 > 
ˇrd
->
ho°
->
max_blk_cou¡
)

1347 
brq
->
d©a
.
blocks
 = 
ˇrd
->
ho°
->
max_blk_cou¡
;

1349 i‡(
brq
->
d©a
.
blocks
 > 1) {

1355 i‡(
dißbÀ_mu…i
)

1356 
brq
->
d©a
.
blocks
 = 1;

1359 i‡(
ˇrd
->
ho°
->
ˇps2
 & 
MMC_CAP2_NO_MULTI_READ
 &&

1360 
	`rq_d©a_dú
(
ªq
Ë=
READ
)

1361 
brq
->
d©a
.
blocks
 = 1;

1364 i‡(
brq
->
d©a
.
blocks
 > 1 || 
do_ªl_wr
) {

1368 i‡(!
	`mmc_ho°_is_•i
(
ˇrd
->
ho°
) ||

1369 
	`rq_d©a_dú
(
ªq
Ë=
READ
)

1370 
brq
->
mrq
.
°›
 = &brq->stop;

1371 
ªadcmd
 = 
MMC_READ_MULTIPLE_BLOCK
;

1372 
wrôecmd
 = 
MMC_WRITE_MULTIPLE_BLOCK
;

1374 
brq
->
mrq
.
°›
 = 
NULL
;

1375 
ªadcmd
 = 
MMC_READ_SINGLE_BLOCK
;

1376 
wrôecmd
 = 
MMC_WRITE_BLOCK
;

1378 i‡(
	`rq_d©a_dú
(
ªq
Ë=
READ
) {

1379 
brq
->
cmd
.
›code
 = 
ªadcmd
;

1380 
brq
->
d©a
.
Êags
 |
MMC_DATA_READ
;

1382 
brq
->
cmd
.
›code
 = 
wrôecmd
;

1383 
brq
->
d©a
.
Êags
 |
MMC_DATA_WRITE
;

1386 i‡(
do_ªl_wr
)

1387 
	`mmc_≠∂y_ªl_rw
(
brq
, 
ˇrd
, 
ªq
);

1393 
do_d©a_èg
 = (
ˇrd
->
ext_csd
.
d©a_èg_unô_size
) &&

1394 (
ªq
->
cmd_Êags
 & 
REQ_META
) &&

1395 (
	`rq_d©a_dú
(
ªq
Ë=
WRITE
) &&

1396 ((
brq
->
d©a
.
blocks
 * brq->d©a.
blksz
) >=

1397 
ˇrd
->
ext_csd
.
d©a_èg_unô_size
);

1417 i‡((
md
->
Êags
 & 
MMC_BLK_CMD23
Ë&& 
	`mmc_›_mu…i
(
brq
->
cmd
.
›code
) &&

1418 (
do_ªl_wr
 || !(
ˇrd
->
quúks
 & 
MMC_QUIRK_BLK_NO_CMD23
) ||

1419 
do_d©a_èg
)) {

1420 
brq
->
sbc
.
›code
 = 
MMC_SET_BLOCK_COUNT
;

1421 
brq
->
sbc
.
¨g
 = brq->
d©a
.
blocks
 |

1422 (
do_ªl_wr
 ? (1 << 31) : 0) |

1423 (
do_d©a_èg
 ? (1 << 29) : 0);

1424 
brq
->
sbc
.
Êags
 = 
MMC_RSP_R1
 | 
MMC_CMD_AC
;

1425 
brq
->
mrq
.
sbc
 = &brq->sbc;

1428 
	`mmc_£t_d©a_timeout
(&
brq
->
d©a
, 
ˇrd
);

1430 
brq
->
d©a
.
sg
 = 
mqrq
->sg;

1431 
brq
->
d©a
.
sg_Àn
 = 
	`mmc_queue_m≠_sg
(
mq
, 
mqrq
);

1437 i‡(
brq
->
d©a
.
blocks
 !
	`blk_rq_£˘‹s
(
ªq
)) {

1438 
i
, 
d©a_size
 = 
brq
->
d©a
.
blocks
 << 9;

1439 
sˇâîli°
 *
sg
;

1441 
	`f‹_óch_sg
(
brq
->
d©a
.
sg
, sg, brq->d©a.
sg_Àn
, 
i
) {

1442 
d©a_size
 -
sg
->
Àngth
;

1443 i‡(
d©a_size
 <= 0) {

1444 
sg
->
Àngth
 +
d©a_size
;

1445 
i
++;

1449 
brq
->
d©a
.
sg_Àn
 = 
i
;

1452 
mqrq
->
mmc_a˘ive
.
mrq
 = &
brq
->mrq;

1453 
mqrq
->
mmc_a˘ive
.
îr_check
 = 
mmc_blk_îr_check
;

1455 
	`mmc_queue_boun˚_¥e
(
mqrq
);

1456 
	}
}

1458 
ölöe
 
u8
 
	$mmc_ˇlc_∑cked_hdr_£gs
(
ªque°_queue
 *
q
,

1459 
mmc_ˇrd
 *
ˇrd
)

1461 
hdr_sz
 = 
	`mmc_œrge_£˘‹
(
ˇrd
) ? 4096 : 512;

1462 
max_£g_sz
 = 
	`queue_max_£gmít_size
(
q
);

1463 
Àn
, 
ƒ_£gs
 = 0;

1466 
Àn
 = 
	`mö
(
hdr_sz
, 
max_£g_sz
);

1467 
hdr_sz
 -
Àn
;

1468 
ƒ_£gs
++;

1469 } 
hdr_sz
);

1471  
ƒ_£gs
;

1472 
	}
}

1474 
u8
 
	$mmc_blk_¥ï_∑cked_li°
(
mmc_queue
 *
mq
, 
ªque°
 *
ªq
)

1476 
ªque°_queue
 *
q
 = 
mq
->
queue
;

1477 
mmc_ˇrd
 *
ˇrd
 = 
mq
->card;

1478 
ªque°
 *
cur
 = 
ªq
, *
√xt
 = 
NULL
;

1479 
mmc_blk_d©a
 *
md
 = 
mq
->
d©a
;

1480 
mmc_queue_ªq
 *
mqrq
 = 
mq
->
mqrq_cur
;

1481 
boﬁ
 
í_ªl_wr
 = 
ˇrd
->
ext_csd
.
ªl_∑øm
 & 
EXT_CSD_WR_REL_PARAM_EN
;

1482 
ªq_£˘‹s
 = 0, 
phys_£gmíts
 = 0;

1483 
max_blk_cou¡
, 
max_phys_£gs
;

1484 
boﬁ
 
put_back
 = 
åue
;

1485 
u8
 
max_∑cked_rw
 = 0;

1486 
u8
 
ªqs
 = 0;

1488 i‡(!(
md
->
Êags
 & 
MMC_BLK_PACKED_CMD
))

1489 
no_∑cked
;

1491 i‡((
	`rq_d©a_dú
(
cur
Ë=
WRITE
) &&

1492 
	`mmc_ho°_∑cked_wr
(
ˇrd
->
ho°
))

1493 
max_∑cked_rw
 = 
ˇrd
->
ext_csd
.
max_∑cked_wrôes
;

1495 i‡(
max_∑cked_rw
 == 0)

1496 
no_∑cked
;

1498 i‡(
	`mmc_ªq_ªl_wr
(
cur
) &&

1499 (
md
->
Êags
 & 
MMC_BLK_REL_WR
Ë&& !
í_ªl_wr
)

1500 
no_∑cked
;

1502 i‡(
	`mmc_œrge_£˘‹
(
ˇrd
) &&

1503 !
	`IS_ALIGNED
(
	`blk_rq_£˘‹s
(
cur
), 8))

1504 
no_∑cked
;

1506 
	`mmc_blk_˛ór_∑cked
(
mqrq
);

1508 
max_blk_cou¡
 = 
	`mö
(
ˇrd
->
ho°
->max_blk_count,

1509 
ˇrd
->
ho°
->
max_ªq_size
 >> 9);

1510 i‡(
	`u∆ikñy
(
max_blk_cou¡
 > 0xffff))

1511 
max_blk_cou¡
 = 0xffff;

1513 
max_phys_£gs
 = 
	`queue_max_£gmíts
(
q
);

1514 
ªq_£˘‹s
 +
	`blk_rq_£˘‹s
(
cur
);

1515 
phys_£gmíts
 +
cur
->
ƒ_phys_£gmíts
;

1517 i‡(
	`rq_d©a_dú
(
cur
Ë=
WRITE
) {

1518 
ªq_£˘‹s
 +
	`mmc_œrge_£˘‹
(
ˇrd
) ? 8 : 1;

1519 
phys_£gmíts
 +
	`mmc_ˇlc_∑cked_hdr_£gs
(
q
, 
ˇrd
);

1523 i‡(
ªqs
 >
max_∑cked_rw
 - 1) {

1524 
put_back
 = 
Ál£
;

1528 
	`•ö_lock_úq
(
q
->
queue_lock
);

1529 
√xt
 = 
	`blk_„tch_ªque°
(
q
);

1530 
	`•ö_u∆ock_úq
(
q
->
queue_lock
);

1531 i‡(!
√xt
) {

1532 
put_back
 = 
Ál£
;

1536 i‡(
	`mmc_œrge_£˘‹
(
ˇrd
) &&

1537 !
	`IS_ALIGNED
(
	`blk_rq_£˘‹s
(
√xt
), 8))

1540 i‡(
√xt
->
cmd_Êags
 & 
REQ_DISCARD
 ||

1541 
√xt
->
cmd_Êags
 & 
REQ_FLUSH
)

1544 i‡(
	`rq_d©a_dú
(
cur
Ë!rq_d©a_dú(
√xt
))

1547 i‡(
	`mmc_ªq_ªl_wr
(
√xt
) &&

1548 (
md
->
Êags
 & 
MMC_BLK_REL_WR
Ë&& !
í_ªl_wr
)

1551 
ªq_£˘‹s
 +
	`blk_rq_£˘‹s
(
√xt
);

1552 i‡(
ªq_£˘‹s
 > 
max_blk_cou¡
)

1555 
phys_£gmíts
 +
√xt
->
ƒ_phys_£gmíts
;

1556 i‡(
phys_£gmíts
 > 
max_phys_£gs
)

1559 
	`li°_add_èû
(&
√xt
->
queuñi°
, &
mqrq
->
∑cked
->
li°
);

1560 
cur
 = 
√xt
;

1561 
ªqs
++;

1564 i‡(
put_back
) {

1565 
	`•ö_lock_úq
(
q
->
queue_lock
);

1566 
	`blk_ªqueue_ªque°
(
q
, 
√xt
);

1567 
	`•ö_u∆ock_úq
(
q
->
queue_lock
);

1570 i‡(
ªqs
 > 0) {

1571 
	`li°_add
(&
ªq
->
queuñi°
, &
mqrq
->
∑cked
->
li°
);

1572 
mqrq
->
∑cked
->
ƒ_íåõs
 = ++
ªqs
;

1573 
mqrq
->
∑cked
->
ªåõs
 = 
ªqs
;

1574  
ªqs
;

1577 
no_∑cked
:

1578 
mqrq
->
cmd_ty≥
 = 
MMC_PACKED_NONE
;

1580 
	}
}

1582 
	$mmc_blk_∑cked_hdr_wrq_¥ï
(
mmc_queue_ªq
 *
mqrq
,

1583 
mmc_ˇrd
 *
ˇrd
,

1584 
mmc_queue
 *
mq
)

1586 
mmc_blk_ªque°
 *
brq
 = &
mqrq
->brq;

1587 
ªque°
 *
ªq
 = 
mqrq
->req;

1588 
ªque°
 *
¥q
;

1589 
mmc_blk_d©a
 *
md
 = 
mq
->
d©a
;

1590 
mmc_∑cked
 *
∑cked
 = 
mqrq
->packed;

1591 
boﬁ
 
do_ªl_wr
, 
do_d©a_èg
;

1592 
u32
 *
∑cked_cmd_hdr
;

1593 
u8
 
hdr_blocks
;

1594 
u8
 
i
 = 1;

1596 
	`BUG_ON
(!
∑cked
);

1598 
mqrq
->
cmd_ty≥
 = 
MMC_PACKED_WRITE
;

1599 
∑cked
->
blocks
 = 0;

1600 
∑cked
->
idx_Áûuª
 = 
MMC_PACKED_NR_IDX
;

1602 
∑cked_cmd_hdr
 = 
∑cked
->
cmd_hdr
;

1603 
	`mem£t
(
∑cked_cmd_hdr
, 0, (
∑cked
->
cmd_hdr
));

1604 
∑cked_cmd_hdr
[0] = (
∑cked
->
ƒ_íåõs
 << 16) |

1605 (
PACKED_CMD_WR
 << 8Ë| 
PACKED_CMD_VER
;

1606 
hdr_blocks
 = 
	`mmc_œrge_£˘‹
(
ˇrd
) ? 8 : 1;

1611 
	`li°_f‹_óch_íåy
(
¥q
, &
∑cked
->
li°
, 
queuñi°
) {

1612 
do_ªl_wr
 = 
	`mmc_ªq_ªl_wr
(
¥q
Ë&& (
md
->
Êags
 & 
MMC_BLK_REL_WR
);

1613 
do_d©a_èg
 = (
ˇrd
->
ext_csd
.
d©a_èg_unô_size
) &&

1614 (
¥q
->
cmd_Êags
 & 
REQ_META
) &&

1615 (
	`rq_d©a_dú
(
¥q
Ë=
WRITE
) &&

1616 ((
brq
->
d©a
.
blocks
 * brq->d©a.
blksz
) >=

1617 
ˇrd
->
ext_csd
.
d©a_èg_unô_size
);

1619 
∑cked_cmd_hdr
[(
i
 * 2)] =

1620 (
do_ªl_wr
 ? 
MMC_CMD23_ARG_REL_WR
 : 0) |

1621 (
do_d©a_èg
 ? 
MMC_CMD23_ARG_TAG_REQ
 : 0) |

1622 
	`blk_rq_£˘‹s
(
¥q
);

1624 
∑cked_cmd_hdr
[((
i
 * 2)) + 1] =

1625 
	`mmc_ˇrd_blockaddr
(
ˇrd
) ?

1626 
	`blk_rq_pos
(
¥q
) : blk_rq_pos(prq) << 9;

1627 
∑cked
->
blocks
 +
	`blk_rq_£˘‹s
(
¥q
);

1628 
i
++;

1631 
	`mem£t
(
brq
, 0, (
mmc_blk_ªque°
));

1632 
brq
->
mrq
.
cmd
 = &brq->cmd;

1633 
brq
->
mrq
.
d©a
 = &brq->data;

1634 
brq
->
mrq
.
sbc
 = &brq->sbc;

1635 
brq
->
mrq
.
°›
 = &brq->stop;

1637 
brq
->
sbc
.
›code
 = 
MMC_SET_BLOCK_COUNT
;

1638 
brq
->
sbc
.
¨g
 = 
MMC_CMD23_ARG_PACKED
 | (
∑cked
->
blocks
 + 
hdr_blocks
);

1639 
brq
->
sbc
.
Êags
 = 
MMC_RSP_R1
 | 
MMC_CMD_AC
;

1641 
brq
->
cmd
.
›code
 = 
MMC_WRITE_MULTIPLE_BLOCK
;

1642 
brq
->
cmd
.
¨g
 = 
	`blk_rq_pos
(
ªq
);

1643 i‡(!
	`mmc_ˇrd_blockaddr
(
ˇrd
))

1644 
brq
->
cmd
.
¨g
 <<= 9;

1645 
brq
->
cmd
.
Êags
 = 
MMC_RSP_SPI_R1
 | 
MMC_RSP_R1
 | 
MMC_CMD_ADTC
;

1647 
brq
->
d©a
.
blksz
 = 512;

1648 
brq
->
d©a
.
blocks
 = 
∑cked
->block†+ 
hdr_blocks
;

1649 
brq
->
d©a
.
Êags
 |
MMC_DATA_WRITE
;

1651 
brq
->
°›
.
›code
 = 
MMC_STOP_TRANSMISSION
;

1652 
brq
->
°›
.
¨g
 = 0;

1653 
brq
->
°›
.
Êags
 = 
MMC_RSP_SPI_R1B
 | 
MMC_RSP_R1B
 | 
MMC_CMD_AC
;

1655 
	`mmc_£t_d©a_timeout
(&
brq
->
d©a
, 
ˇrd
);

1657 
brq
->
d©a
.
sg
 = 
mqrq
->sg;

1658 
brq
->
d©a
.
sg_Àn
 = 
	`mmc_queue_m≠_sg
(
mq
, 
mqrq
);

1660 
mqrq
->
mmc_a˘ive
.
mrq
 = &
brq
->mrq;

1661 
mqrq
->
mmc_a˘ive
.
îr_check
 = 
mmc_blk_∑cked_îr_check
;

1663 
	`mmc_queue_boun˚_¥e
(
mqrq
);

1664 
	}
}

1666 
	$mmc_blk_cmd_îr
(
mmc_blk_d©a
 *
md
, 
mmc_ˇrd
 *
ˇrd
,

1667 
mmc_blk_ªque°
 *
brq
, 
ªque°
 *
ªq
,

1668 
ªt
)

1670 
mmc_queue_ªq
 *
mq_rq
;

1671 
mq_rq
 = 
	`c⁄èöî_of
(
brq
, 
mmc_queue_ªq
, brq);

1681 i‡(
	`mmc_ˇrd_sd
(
ˇrd
)) {

1682 
u32
 
blocks
;

1684 
blocks
 = 
	`mmc_sd_num_wr_blocks
(
ˇrd
);

1685 i‡(
blocks
 !(
u32
)-1) {

1686 
ªt
 = 
	`blk_íd_ªque°
(
ªq
, 0, 
blocks
 << 9);

1689 i‡(!
	`mmc_∑cked_cmd
(
mq_rq
->
cmd_ty≥
))

1690 
ªt
 = 
	`blk_íd_ªque°
(
ªq
, 0, 
brq
->
d©a
.
byãs_x„ªd
);

1692  
ªt
;

1693 
	}
}

1695 
	$mmc_blk_íd_∑cked_ªq
(
mmc_queue_ªq
 *
mq_rq
)

1697 
ªque°
 *
¥q
;

1698 
mmc_∑cked
 *
∑cked
 = 
mq_rq
->packed;

1699 
idx
 = 
∑cked
->
idx_Áûuª
, 
i
 = 0;

1700 
ªt
 = 0;

1702 
	`BUG_ON
(!
∑cked
);

1704 !
	`li°_em±y
(&
∑cked
->
li°
)) {

1705 
¥q
 = 
	`li°_íåy_rq
(
∑cked
->
li°
.
√xt
);

1706 i‡(
idx
 =
i
) {

1708 
∑cked
->
ƒ_íåõs
 -
idx
;

1709 
mq_rq
->
ªq
 = 
¥q
;

1710 
ªt
 = 1;

1712 i‡(
∑cked
->
ƒ_íåõs
 =
MMC_PACKED_NR_SINGLE
) {

1713 
	`li°_dñ_öô
(&
¥q
->
queuñi°
);

1714 
	`mmc_blk_˛ór_∑cked
(
mq_rq
);

1716  
ªt
;

1718 
	`li°_dñ_öô
(&
¥q
->
queuñi°
);

1719 
	`blk_íd_ªque°
(
¥q
, 0, 
	`blk_rq_byãs
(prq));

1720 
i
++;

1723 
	`mmc_blk_˛ór_∑cked
(
mq_rq
);

1724  
ªt
;

1725 
	}
}

1727 
	$mmc_blk_ab‹t_∑cked_ªq
(
mmc_queue_ªq
 *
mq_rq
)

1729 
ªque°
 *
¥q
;

1730 
mmc_∑cked
 *
∑cked
 = 
mq_rq
->packed;

1732 
	`BUG_ON
(!
∑cked
);

1734 !
	`li°_em±y
(&
∑cked
->
li°
)) {

1735 
¥q
 = 
	`li°_íåy_rq
(
∑cked
->
li°
.
√xt
);

1736 
	`li°_dñ_öô
(&
¥q
->
queuñi°
);

1737 
	`blk_íd_ªque°
(
¥q
, -
EIO
, 
	`blk_rq_byãs
(prq));

1740 
	`mmc_blk_˛ór_∑cked
(
mq_rq
);

1741 
	}
}

1743 
	$mmc_blk_ªvît_∑cked_ªq
(
mmc_queue
 *
mq
,

1744 
mmc_queue_ªq
 *
mq_rq
)

1746 
ªque°
 *
¥q
;

1747 
ªque°_queue
 *
q
 = 
mq
->
queue
;

1748 
mmc_∑cked
 *
∑cked
 = 
mq_rq
->packed;

1750 
	`BUG_ON
(!
∑cked
);

1752 !
	`li°_em±y
(&
∑cked
->
li°
)) {

1753 
¥q
 = 
	`li°_íåy_rq
(
∑cked
->
li°
.
¥ev
);

1754 i‡(
¥q
->
queuñi°
.
¥ev
 !&
∑cked
->
li°
) {

1755 
	`li°_dñ_öô
(&
¥q
->
queuñi°
);

1756 
	`•ö_lock_úq
(
q
->
queue_lock
);

1757 
	`blk_ªqueue_ªque°
(
mq
->
queue
, 
¥q
);

1758 
	`•ö_u∆ock_úq
(
q
->
queue_lock
);

1760 
	`li°_dñ_öô
(&
¥q
->
queuñi°
);

1764 
	`mmc_blk_˛ór_∑cked
(
mq_rq
);

1765 
	}
}

1767 
	$mmc_blk_issue_rw_rq
(
mmc_queue
 *
mq
, 
ªque°
 *
rqc
)

1769 
mmc_blk_d©a
 *
md
 = 
mq
->
d©a
;

1770 
mmc_ˇrd
 *
ˇrd
 = 
md
->
queue
.card;

1771 
mmc_blk_ªque°
 *
brq
 = &
mq
->
mqrq_cur
->brq;

1772 
ªt
 = 1, 
dißbÀ_mu…i
 = 0, 
ªåy
 = 0, 
ty≥
;

1773 
mmc_blk_°©us
 
°©us
;

1774 
mmc_queue_ªq
 *
mq_rq
;

1775 
ªque°
 *
ªq
 = 
rqc
;

1776 
mmc_async_ªq
 *
¨eq
;

1777 c⁄° 
u8
 
∑cked_ƒ
 = 2;

1778 
u8
 
ªqs
 = 0;

1780 i‡(!
rqc
 && !
mq
->
mqrq_¥ev
->
ªq
)

1783 i‡(
rqc
)

1784 
ªqs
 = 
	`mmc_blk_¥ï_∑cked_li°
(
mq
, 
rqc
);

1787 i‡(
rqc
) {

1792 i‡((
brq
->
d©a
.
blocks
 & 0x07) &&

1793 (
ˇrd
->
ext_csd
.
d©a_£˘‹_size
 == 4096)) {

1794 
	`¥_îr
("%s: Transfer size isÇot 4KB sector sizeáligned\n",

1795 
ªq
->
rq_disk
->
disk_«me
);

1796 
mq_rq
 = 
mq
->
mqrq_cur
;

1797 
cmd_ab‹t
;

1800 i‡(
ªqs
 >
∑cked_ƒ
)

1801 
	`mmc_blk_∑cked_hdr_wrq_¥ï
(
mq
->
mqrq_cur
,

1802 
ˇrd
, 
mq
);

1804 
	`mmc_blk_rw_rq_¥ï
(
mq
->
mqrq_cur
, 
ˇrd
, 0, mq);

1805 
¨eq
 = &
mq
->
mqrq_cur
->
mmc_a˘ive
;

1807 
¨eq
 = 
NULL
;

1808 
¨eq
 = 
	`mmc_°¨t_ªq
(
ˇrd
->
ho°
,áªq, (*Ë&
°©us
);

1809 i‡(!
¨eq
) {

1810 i‡(
°©us
 =
MMC_BLK_NEW_REQUEST
)

1811 
mq
->
Êags
 |
MMC_QUEUE_NEW_REQUEST
;

1815 
mq_rq
 = 
	`c⁄èöî_of
(
¨eq
, 
mmc_queue_ªq
, 
mmc_a˘ive
);

1816 
brq
 = &
mq_rq
->brq;

1817 
ªq
 = 
mq_rq
->req;

1818 
ty≥
 = 
	`rq_d©a_dú
(
ªq
Ë=
READ
 ? 
MMC_BLK_READ
 : 
MMC_BLK_WRITE
;

1819 
	`mmc_queue_boun˚_po°
(
mq_rq
);

1821 
°©us
) {

1822 
MMC_BLK_SUCCESS
:

1823 
MMC_BLK_PARTIAL
:

1827 
	`mmc_blk_ª£t_suc˚ss
(
md
, 
ty≥
);

1829 i‡(
	`mmc_∑cked_cmd
(
mq_rq
->
cmd_ty≥
)) {

1830 
ªt
 = 
	`mmc_blk_íd_∑cked_ªq
(
mq_rq
);

1833 
ªt
 = 
	`blk_íd_ªque°
(
ªq
, 0,

1834 
brq
->
d©a
.
byãs_x„ªd
);

1842 i‡(
°©us
 =
MMC_BLK_SUCCESS
 && 
ªt
) {

1843 
	`¥_îr
("%s BUGÑq_tot %d d_xfer %d\n",

1844 
__func__
, 
	`blk_rq_byãs
(
ªq
),

1845 
brq
->
d©a
.
byãs_x„ªd
);

1846 
rqc
 = 
NULL
;

1847 
cmd_ab‹t
;

1850 
MMC_BLK_CMD_ERR
:

1851 
ªt
 = 
	`mmc_blk_cmd_îr
(
md
, 
ˇrd
, 
brq
, 
ªq
,Ñet);

1852 i‡(!
	`mmc_blk_ª£t
(
md
, 
ˇrd
->
ho°
, 
ty≥
))

1854 
cmd_ab‹t
;

1855 
MMC_BLK_RETRY
:

1856 i‡(
ªåy
++ < 5)

1859 
MMC_BLK_ABORT
:

1860 i‡(!
	`mmc_blk_ª£t
(
md
, 
ˇrd
->
ho°
, 
ty≥
))

1862 
cmd_ab‹t
;

1863 
MMC_BLK_DATA_ERR
: {

1864 
îr
;

1866 
îr
 = 
	`mmc_blk_ª£t
(
md
, 
ˇrd
->
ho°
, 
ty≥
);

1867 i‡(!
îr
)

1869 i‡(
îr
 =-
ENODEV
 ||

1870 
	`mmc_∑cked_cmd
(
mq_rq
->
cmd_ty≥
))

1871 
cmd_ab‹t
;

1874 
MMC_BLK_ECC_ERR
:

1875 i‡(
brq
->
d©a
.
blocks
 > 1) {

1877 
	`¥_w¨nög
("%s:Ñetrying using single blockÑead\n",

1878 
ªq
->
rq_disk
->
disk_«me
);

1879 
dißbÀ_mu…i
 = 1;

1887 
ªt
 = 
	`blk_íd_ªque°
(
ªq
, -
EIO
,

1888 
brq
->
d©a
.
blksz
);

1889 i‡(!
ªt
)

1890 
°¨t_√w_ªq
;

1892 
MMC_BLK_NOMEDIUM
:

1893 
cmd_ab‹t
;

1895 
	`¥_îr
("%s: UnhandledÑeturn value (%d)",

1896 
ªq
->
rq_disk
->
disk_«me
, 
°©us
);

1897 
cmd_ab‹t
;

1900 i‡(
ªt
) {

1901 i‡(
	`mmc_∑cked_cmd
(
mq_rq
->
cmd_ty≥
)) {

1902 i‡(!
mq_rq
->
∑cked
->
ªåõs
)

1903 
cmd_ab‹t
;

1904 
	`mmc_blk_∑cked_hdr_wrq_¥ï
(
mq_rq
, 
ˇrd
, 
mq
);

1905 
	`mmc_°¨t_ªq
(
ˇrd
->
ho°
,

1906 &
mq_rq
->
mmc_a˘ive
, 
NULL
);

1913 
	`mmc_blk_rw_rq_¥ï
(
mq_rq
, 
ˇrd
,

1914 
dißbÀ_mu…i
, 
mq
);

1915 
	`mmc_°¨t_ªq
(
ˇrd
->
ho°
,

1916 &
mq_rq
->
mmc_a˘ive
, 
NULL
);

1919 } 
ªt
);

1923 
cmd_ab‹t
:

1924 i‡(
	`mmc_∑cked_cmd
(
mq_rq
->
cmd_ty≥
)) {

1925 
	`mmc_blk_ab‹t_∑cked_ªq
(
mq_rq
);

1927 i‡(
	`mmc_ˇrd_ªmoved
(
ˇrd
))

1928 
ªq
->
cmd_Êags
 |
REQ_QUIET
;

1929 
ªt
)

1930 
ªt
 = 
	`blk_íd_ªque°
(
ªq
, -
EIO
,

1931 
	`blk_rq_cur_byãs
(
ªq
));

1934 
°¨t_√w_ªq
:

1935 i‡(
rqc
) {

1936 i‡(
	`mmc_ˇrd_ªmoved
(
ˇrd
)) {

1937 
rqc
->
cmd_Êags
 |
REQ_QUIET
;

1938 
	`blk_íd_ªque°_Æl
(
rqc
, -
EIO
);

1943 i‡(
	`mmc_∑cked_cmd
(
mq
->
mqrq_cur
->
cmd_ty≥
))

1944 
	`mmc_blk_ªvît_∑cked_ªq
(
mq
, mq->
mqrq_cur
);

1946 
	`mmc_blk_rw_rq_¥ï
(
mq
->
mqrq_cur
, 
ˇrd
, 0, mq);

1947 
	`mmc_°¨t_ªq
(
ˇrd
->
ho°
,

1948 &
mq
->
mqrq_cur
->
mmc_a˘ive
, 
NULL
);

1953 
	}
}

1955 
	$mmc_blk_issue_rq
(
mmc_queue
 *
mq
, 
ªque°
 *
ªq
)

1957 
ªt
;

1958 
mmc_blk_d©a
 *
md
 = 
mq
->
d©a
;

1959 
mmc_ˇrd
 *
ˇrd
 = 
md
->
queue
.card;

1960 
mmc_ho°
 *
ho°
 = 
ˇrd
->host;

1961 
Êags
;

1962 
cmd_Êags
 = 
ªq
 ?Ñeq->cmd_flags : 0;

1964 i‡(
ªq
 && !
mq
->
mqrq_¥ev
->req)

1966 
	`mmc_gë_ˇrd
(
ˇrd
);

1968 
ªt
 = 
	`mmc_blk_∑π_swôch
(
ˇrd
, 
md
);

1969 i‡(
ªt
) {

1970 i‡(
ªq
) {

1971 
	`blk_íd_ªque°_Æl
(
ªq
, -
EIO
);

1973 
ªt
 = 0;

1974 
out
;

1977 
mq
->
Êags
 &~
MMC_QUEUE_NEW_REQUEST
;

1978 i‡(
cmd_Êags
 & 
REQ_DISCARD
) {

1980 i‡(
ˇrd
->
ho°
->
¨eq
)

1981 
	`mmc_blk_issue_rw_rq
(
mq
, 
NULL
);

1982 i‡(
ªq
->
cmd_Êags
 & 
REQ_SECURE
 &&

1983 !(
ˇrd
->
quúks
 & 
MMC_QUIRK_SEC_ERASE_TRIM_BROKEN
))

1984 
ªt
 = 
	`mmc_blk_issue_£cdisˇrd_rq
(
mq
, 
ªq
);

1986 
ªt
 = 
	`mmc_blk_issue_disˇrd_rq
(
mq
, 
ªq
);

1987 } i‡(
cmd_Êags
 & 
REQ_FLUSH
) {

1989 i‡(
ˇrd
->
ho°
->
¨eq
)

1990 
	`mmc_blk_issue_rw_rq
(
mq
, 
NULL
);

1991 
ªt
 = 
	`mmc_blk_issue_Êush
(
mq
, 
ªq
);

1993 i‡(!
ªq
 && 
ho°
->
¨eq
) {

1994 
	`•ö_lock_úqßve
(&
ho°
->
c⁄ãxt_öfo
.
lock
, 
Êags
);

1995 
ho°
->
c⁄ãxt_öfo
.
is_waôög_œ°_ªq
 = 
åue
;

1996 
	`•ö_u∆ock_úqª°‹e
(&
ho°
->
c⁄ãxt_öfo
.
lock
, 
Êags
);

1998 
ªt
 = 
	`mmc_blk_issue_rw_rq
(
mq
, 
ªq
);

2001 
out
:

2002 i‡((!
ªq
 && !(
mq
->
Êags
 & 
MMC_QUEUE_NEW_REQUEST
)) ||

2003 (
cmd_Êags
 & 
MMC_REQ_SPECIAL_MASK
))

2010 
	`mmc_put_ˇrd
(
ˇrd
);

2011  
ªt
;

2012 
	}
}

2014 
ölöe
 
	$mmc_blk_ªad⁄ly
(
mmc_ˇrd
 *
ˇrd
)

2016  
	`mmc_ˇrd_ªad⁄ly
(
ˇrd
) ||

2017 !(
ˇrd
->
csd
.
cmd˛ass
 & 
CCC_BLOCK_WRITE
);

2018 
	}
}

2020 
mmc_blk_d©a
 *
	$mmc_blk_Æloc_ªq
(
mmc_ˇrd
 *
ˇrd
,

2021 
devi˚
 *
∑ª¡
,

2022 
£˘‹_t
 
size
,

2023 
boﬁ
 
deÁu…_ro
,

2024 c⁄° *
sub«me
,

2025 
¨ó_ty≥
)

2027 
mmc_blk_d©a
 *
md
;

2028 
devidx
, 
ªt
;

2030 
devidx
 = 
	`föd_fú°_zîo_bô
(
dev_u£
, 
max_devi˚s
);

2031 i‡(
devidx
 >
max_devi˚s
)

2032  
	`ERR_PTR
(-
ENOSPC
);

2033 
	`__£t_bô
(
devidx
, 
dev_u£
);

2035 
md
 = 
	`kzÆloc
((
mmc_blk_d©a
), 
GFP_KERNEL
);

2036 i‡(!
md
) {

2037 
ªt
 = -
ENOMEM
;

2038 
out
;

2047 i‡(!
sub«me
) {

2048 
md
->
«me_idx
 = 
	`föd_fú°_zîo_bô
(
«me_u£
, 
max_devi˚s
);

2049 
	`__£t_bô
(
md
->
«me_idx
, 
«me_u£
);

2051 
md
->
«me_idx
 = ((
mmc_blk_d©a
 *)

2052 
	`dev_to_disk
(
∑ª¡
)->
¥iv©e_d©a
)->
«me_idx
;

2054 
md
->
¨ó_ty≥
 =área_type;

2060 
md
->
ªad_⁄ly
 = 
	`mmc_blk_ªad⁄ly
(
ˇrd
);

2062 
md
->
disk
 = 
	`Æloc_disk
(
≥rdev_mö‹s
);

2063 i‡(
md
->
disk
 =
NULL
) {

2064 
ªt
 = -
ENOMEM
;

2065 
îr_k‰ì
;

2068 
	`•ö_lock_öô
(&
md
->
lock
);

2069 
	`INIT_LIST_HEAD
(&
md
->
∑π
);

2070 
md
->
ußge
 = 1;

2072 
ªt
 = 
	`mmc_öô_queue
(&
md
->
queue
, 
ˇrd
, &md->
lock
, 
sub«me
);

2073 i‡(
ªt
)

2074 
îr_putdisk
;

2076 
md
->
queue
.
issue_‚
 = 
mmc_blk_issue_rq
;

2077 
md
->
queue
.
d©a
 = md;

2079 
md
->
disk
->
maj‹
 = 
MMC_BLOCK_MAJOR
;

2080 
md
->
disk
->
fú°_mö‹
 = 
devidx
 * 
≥rdev_mö‹s
;

2081 
md
->
disk
->
f›s
 = &
mmc_bd›s
;

2082 
md
->
disk
->
¥iv©e_d©a
 = md;

2083 
md
->
disk
->
queue
 = md->queue.queue;

2084 
md
->
disk
->
drivîfs_dev
 = 
∑ª¡
;

2085 
	`£t_disk_ro
(
md
->
disk
, md->
ªad_⁄ly
 || 
deÁu…_ro
);

2086 i‡(
¨ó_ty≥
 & 
MMC_BLK_DATA_AREA_RPMB
)

2087 
md
->
disk
->
Êags
 |
GENHD_FL_NO_PART_SCAN
;

2101 
	`¢¥ötf
(
md
->
disk
->
disk_«me
, (md->disk->disk_name),

2102 "mmcblk%d%s", 
md
->
«me_idx
, 
sub«me
 ? subname : "");

2104 i‡(
	`mmc_ˇrd_mmc
(
ˇrd
))

2105 
	`blk_queue_logiˇl_block_size
(
md
->
queue
.queue,

2106 
ˇrd
->
ext_csd
.
d©a_£˘‹_size
);

2108 
	`blk_queue_logiˇl_block_size
(
md
->
queue
.queue, 512);

2110 
	`£t_ˇ∑côy
(
md
->
disk
, 
size
);

2112 i‡(
	`mmc_ho°_cmd23
(
ˇrd
->
ho°
)) {

2113 i‡(
	`mmc_ˇrd_mmc
(
ˇrd
) ||

2114 (
	`mmc_ˇrd_sd
(
ˇrd
) &&

2115 
ˇrd
->
s¸
.
cmds
 & 
SD_SCR_CMD23_SUPPORT
))

2116 
md
->
Êags
 |
MMC_BLK_CMD23
;

2119 i‡(
	`mmc_ˇrd_mmc
(
ˇrd
) &&

2120 
md
->
Êags
 & 
MMC_BLK_CMD23
 &&

2121 ((
ˇrd
->
ext_csd
.
ªl_∑øm
 & 
EXT_CSD_WR_REL_PARAM_EN
) ||

2122 
ˇrd
->
ext_csd
.
ªl_£˘‹s
)) {

2123 
md
->
Êags
 |
MMC_BLK_REL_WR
;

2124 
	`blk_queue_Êush
(
md
->
queue
.queue, 
REQ_FLUSH
 | 
REQ_FUA
);

2127 i‡(
	`mmc_ˇrd_mmc
(
ˇrd
) &&

2128 (
¨ó_ty≥
 =
MMC_BLK_DATA_AREA_MAIN
) &&

2129 (
md
->
Êags
 & 
MMC_BLK_CMD23
) &&

2130 
ˇrd
->
ext_csd
.
∑cked_evít_í
) {

2131 i‡(!
	`mmc_∑cked_öô
(&
md
->
queue
, 
ˇrd
))

2132 
md
->
Êags
 |
MMC_BLK_PACKED_CMD
;

2135  
md
;

2137 
îr_putdisk
:

2138 
	`put_disk
(
md
->
disk
);

2139 
îr_k‰ì
:

2140 
	`k‰ì
(
md
);

2141 
out
:

2142  
	`ERR_PTR
(
ªt
);

2143 
	}
}

2145 
mmc_blk_d©a
 *
	$mmc_blk_Æloc
(
mmc_ˇrd
 *
ˇrd
)

2147 
£˘‹_t
 
size
;

2148 
mmc_blk_d©a
 *
md
;

2150 i‡(!
	`mmc_ˇrd_sd
(
ˇrd
Ë&& 
	`mmc_ˇrd_blockaddr
(card)) {

2155 
size
 = 
ˇrd
->
ext_csd
.
£˘‹s
;

2161 
size
 = 
ˇrd
->
csd
.
ˇ∑côy
 << (ˇrd->csd.
ªad_blkbôs
 - 9);

2164 
md
 = 
	`mmc_blk_Æloc_ªq
(
ˇrd
, &ˇrd->
dev
, 
size
, 
Ál£
, 
NULL
,

2165 
MMC_BLK_DATA_AREA_MAIN
);

2166  
md
;

2167 
	}
}

2169 
	$mmc_blk_Æloc_∑π
(
mmc_ˇrd
 *
ˇrd
,

2170 
mmc_blk_d©a
 *
md
,

2171 
∑π_ty≥
,

2172 
£˘‹_t
 
size
,

2173 
boﬁ
 
deÁu…_ro
,

2174 c⁄° *
sub«me
,

2175 
¨ó_ty≥
)

2177 
ˇp_°r
[10];

2178 
mmc_blk_d©a
 *
∑π_md
;

2180 
∑π_md
 = 
	`mmc_blk_Æloc_ªq
(
ˇrd
, 
	`disk_to_dev
(
md
->
disk
), 
size
, 
deÁu…_ro
,

2181 
sub«me
, 
¨ó_ty≥
);

2182 i‡(
	`IS_ERR
(
∑π_md
))

2183  
	`PTR_ERR
(
∑π_md
);

2184 
∑π_md
->
∑π_ty≥
 =Öart_type;

2185 
	`li°_add
(&
∑π_md
->
∑π
, &
md
->part);

2187 
	`°rög_gë_size
((
u64
)
	`gë_ˇ∑côy
(
∑π_md
->
disk
Ë<< 9, 
STRING_UNITS_2
,

2188 
ˇp_°r
, (cap_str));

2189 
	`¥_öfo
("%s: %s %sÖartition %u %s\n",

2190 
∑π_md
->
disk
->
disk_«me
, 
	`mmc_ˇrd_id
(
ˇrd
),

2191 
	`mmc_ˇrd_«me
(
ˇrd
), 
∑π_md
->
∑π_ty≥
, 
ˇp_°r
);

2193 
	}
}

2201 
	$mmc_blk_Æloc_∑πs
(
mmc_ˇrd
 *
ˇrd
, 
mmc_blk_d©a
 *
md
)

2203 
idx
, 
ªt
 = 0;

2205 i‡(!
	`mmc_ˇrd_mmc
(
ˇrd
))

2208 
idx
 = 0; idx < 
ˇrd
->
ƒ_∑πs
; idx++) {

2209 i‡(
ˇrd
->
∑π
[
idx
].
size
) {

2210 
ªt
 = 
	`mmc_blk_Æloc_∑π
(
ˇrd
, 
md
,

2211 
ˇrd
->
∑π
[
idx
].
∑π_cfg
,

2212 
ˇrd
->
∑π
[
idx
].
size
 >> 9,

2213 
ˇrd
->
∑π
[
idx
].
f‹˚_ro
,

2214 
ˇrd
->
∑π
[
idx
].
«me
,

2215 
ˇrd
->
∑π
[
idx
].
¨ó_ty≥
);

2216 i‡(
ªt
)

2217  
ªt
;

2221  
ªt
;

2222 
	}
}

2224 
	$mmc_blk_ªmove_ªq
(
mmc_blk_d©a
 *
md
)

2226 
mmc_ˇrd
 *
ˇrd
;

2228 i‡(
md
) {

2234 
ˇrd
 = 
md
->
queue
.card;

2235 
	`mmc_˛ónup_queue
(&
md
->
queue
);

2236 i‡(
md
->
Êags
 & 
MMC_BLK_PACKED_CMD
)

2237 
	`mmc_∑cked_˛ón
(&
md
->
queue
);

2238 i‡(
md
->
disk
->
Êags
 & 
GENHD_FL_UP
) {

2239 
	`devi˚_ªmove_fûe
(
	`disk_to_dev
(
md
->
disk
), &md->
f‹˚_ro
);

2240 i‡((
md
->
¨ó_ty≥
 & 
MMC_BLK_DATA_AREA_BOOT
) &&

2241 
ˇrd
->
ext_csd
.
boŸ_ro_lockabÀ
)

2242 
	`devi˚_ªmove_fûe
(
	`disk_to_dev
(
md
->
disk
),

2243 &
md
->
powî_ro_lock
);

2245 
	`dñ_gídisk
(
md
->
disk
);

2247 
	`mmc_blk_put
(
md
);

2249 
	}
}

2251 
	$mmc_blk_ªmove_∑πs
(
mmc_ˇrd
 *
ˇrd
,

2252 
mmc_blk_d©a
 *
md
)

2254 
li°_hód
 *
pos
, *
q
;

2255 
mmc_blk_d©a
 *
∑π_md
;

2257 
	`__˛ór_bô
(
md
->
«me_idx
, 
«me_u£
);

2258 
	`li°_f‹_óch_ß„
(
pos
, 
q
, &
md
->
∑π
) {

2259 
∑π_md
 = 
	`li°_íåy
(
pos
, 
mmc_blk_d©a
, 
∑π
);

2260 
	`li°_dñ
(
pos
);

2261 
	`mmc_blk_ªmove_ªq
(
∑π_md
);

2263 
	}
}

2265 
	$mmc_add_disk
(
mmc_blk_d©a
 *
md
)

2267 
ªt
;

2268 
mmc_ˇrd
 *
ˇrd
 = 
md
->
queue
.card;

2270 
	`add_disk
(
md
->
disk
);

2271 
md
->
f‹˚_ro
.
show
 = 
f‹˚_ro_show
;

2272 
md
->
f‹˚_ro
.
°‹e
 = 
f‹˚_ro_°‹e
;

2273 
	`sysfs_©å_öô
(&
md
->
f‹˚_ro
.
©å
);

2274 
md
->
f‹˚_ro
.
©å
.
«me
 = "force_ro";

2275 
md
->
f‹˚_ro
.
©å
.
mode
 = 
S_IRUGO
 | 
S_IWUSR
;

2276 
ªt
 = 
	`devi˚_¸óã_fûe
(
	`disk_to_dev
(
md
->
disk
), &md->
f‹˚_ro
);

2277 i‡(
ªt
)

2278 
f‹˚_ro_Áû
;

2280 i‡((
md
->
¨ó_ty≥
 & 
MMC_BLK_DATA_AREA_BOOT
) &&

2281 
ˇrd
->
ext_csd
.
boŸ_ro_lockabÀ
) {

2282 
umode_t
 
mode
;

2284 i‡(
ˇrd
->
ext_csd
.
boŸ_ro_lock
 & 
EXT_CSD_BOOT_WP_B_PWR_WP_DIS
)

2285 
mode
 = 
S_IRUGO
;

2287 
mode
 = 
S_IRUGO
 | 
S_IWUSR
;

2289 
md
->
powî_ro_lock
.
show
 = 
powî_ro_lock_show
;

2290 
md
->
powî_ro_lock
.
°‹e
 = 
powî_ro_lock_°‹e
;

2291 
	`sysfs_©å_öô
(&
md
->
powî_ro_lock
.
©å
);

2292 
md
->
powî_ro_lock
.
©å
.
mode
 = mode;

2293 
md
->
powî_ro_lock
.
©å
.
«me
 =

2295 
ªt
 = 
	`devi˚_¸óã_fûe
(
	`disk_to_dev
(
md
->
disk
),

2296 &
md
->
powî_ro_lock
);

2297 i‡(
ªt
)

2298 
powî_ro_lock_Áû
;

2300  
ªt
;

2302 
powî_ro_lock_Áû
:

2303 
	`devi˚_ªmove_fûe
(
	`disk_to_dev
(
md
->
disk
), &md->
f‹˚_ro
);

2304 
f‹˚_ro_Áû
:

2305 
	`dñ_gídisk
(
md
->
disk
);

2307  
ªt
;

2308 
	}
}

2310 
	#CID_MANFID_SANDISK
 0x2

	)

2311 
	#CID_MANFID_TOSHIBA
 0x11

	)

2312 
	#CID_MANFID_MICRON
 0x13

	)

2313 
	#CID_MANFID_SAMSUNG
 0x15

	)

2315 c⁄° 
mmc_fixup
 
	gblk_fixups
[] =

2317 
MMC_FIXUP
("SEM02G", 
CID_MANFID_SANDISK
, 0x100, 
add_quúk
,

2318 
MMC_QUIRK_INAND_CMD38
),

2319 
MMC_FIXUP
("SEM04G", 
CID_MANFID_SANDISK
, 0x100, 
add_quúk
,

2320 
MMC_QUIRK_INAND_CMD38
),

2321 
MMC_FIXUP
("SEM08G", 
CID_MANFID_SANDISK
, 0x100, 
add_quúk
,

2322 
MMC_QUIRK_INAND_CMD38
),

2323 
MMC_FIXUP
("SEM16G", 
CID_MANFID_SANDISK
, 0x100, 
add_quúk
,

2324 
MMC_QUIRK_INAND_CMD38
),

2325 
MMC_FIXUP
("SEM32G", 
CID_MANFID_SANDISK
, 0x100, 
add_quúk
,

2326 
MMC_QUIRK_INAND_CMD38
),

2336 
MMC_FIXUP
("MMC08G", 
CID_MANFID_TOSHIBA
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2337 
MMC_QUIRK_BLK_NO_CMD23
),

2338 
MMC_FIXUP
("MMC16G", 
CID_MANFID_TOSHIBA
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2339 
MMC_QUIRK_BLK_NO_CMD23
),

2340 
MMC_FIXUP
("MMC32G", 
CID_MANFID_TOSHIBA
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2341 
MMC_QUIRK_BLK_NO_CMD23
),

2347 
MMC_FIXUP
(
CID_NAME_ANY
, 
CID_MANFID_MICRON
, 0x200, 
add_quúk_mmc
,

2348 
MMC_QUIRK_LONG_READ_TIME
),

2355 
MMC_FIXUP
("M8G2FA", 
CID_MANFID_SAMSUNG
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2356 
MMC_QUIRK_SEC_ERASE_TRIM_BROKEN
),

2357 
MMC_FIXUP
("MAG4FA", 
CID_MANFID_SAMSUNG
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2358 
MMC_QUIRK_SEC_ERASE_TRIM_BROKEN
),

2359 
MMC_FIXUP
("MBG8FA", 
CID_MANFID_SAMSUNG
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2360 
MMC_QUIRK_SEC_ERASE_TRIM_BROKEN
),

2361 
MMC_FIXUP
("MCGAFA", 
CID_MANFID_SAMSUNG
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2362 
MMC_QUIRK_SEC_ERASE_TRIM_BROKEN
),

2363 
MMC_FIXUP
("VAL00M", 
CID_MANFID_SAMSUNG
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2364 
MMC_QUIRK_SEC_ERASE_TRIM_BROKEN
),

2365 
MMC_FIXUP
("VYL00M", 
CID_MANFID_SAMSUNG
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2366 
MMC_QUIRK_SEC_ERASE_TRIM_BROKEN
),

2367 
MMC_FIXUP
("KYL00M", 
CID_MANFID_SAMSUNG
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2368 
MMC_QUIRK_SEC_ERASE_TRIM_BROKEN
),

2369 
MMC_FIXUP
("VZL00M", 
CID_MANFID_SAMSUNG
, 
CID_OEMID_ANY
, 
add_quúk_mmc
,

2370 
MMC_QUIRK_SEC_ERASE_TRIM_BROKEN
),

2372 
END_FIXUP


2375 
	$mmc_blk_¥obe
(
mmc_ˇrd
 *
ˇrd
)

2377 
mmc_blk_d©a
 *
md
, *
∑π_md
;

2378 
ˇp_°r
[10];

2383 i‡(!(
ˇrd
->
csd
.
cmd˛ass
 & 
CCC_BLOCK_READ
))

2384  -
ENODEV
;

2386 
md
 = 
	`mmc_blk_Æloc
(
ˇrd
);

2387 i‡(
	`IS_ERR
(
md
))

2388  
	`PTR_ERR
(
md
);

2390 
	`°rög_gë_size
((
u64
)
	`gë_ˇ∑côy
(
md
->
disk
Ë<< 9, 
STRING_UNITS_2
,

2391 
ˇp_°r
, (cap_str));

2392 
	`¥_öfo
("%s: %s %s %s %s\n",

2393 
md
->
disk
->
disk_«me
, 
	`mmc_ˇrd_id
(
ˇrd
), 
	`mmc_ˇrd_«me
(card),

2394 
ˇp_°r
, 
md
->
ªad_⁄ly
 ? "(ro)" : "");

2396 i‡(
	`mmc_blk_Æloc_∑πs
(
ˇrd
, 
md
))

2397 
out
;

2399 
	`mmc_£t_drvd©a
(
ˇrd
, 
md
);

2400 
	`mmc_fixup_devi˚
(
ˇrd
, 
blk_fixups
);

2402 i‡(
	`mmc_add_disk
(
md
))

2403 
out
;

2405 
	`li°_f‹_óch_íåy
(
∑π_md
, &
md
->
∑π
,Öart) {

2406 i‡(
	`mmc_add_disk
(
∑π_md
))

2407 
out
;

2410 
	`pm_ru¡ime_£t_autosu•íd_dñay
(&
ˇrd
->
dev
, 3000);

2411 
	`pm_ru¡ime_u£_autosu•íd
(&
ˇrd
->
dev
);

2417 i‡(
ˇrd
->
ty≥
 !
MMC_TYPE_SD_COMBO
) {

2418 
	`pm_ru¡ime_£t_a˘ive
(&
ˇrd
->
dev
);

2419 
	`pm_ru¡ime_íabÀ
(&
ˇrd
->
dev
);

2424 
out
:

2425 
	`mmc_blk_ªmove_∑πs
(
ˇrd
, 
md
);

2426 
	`mmc_blk_ªmove_ªq
(
md
);

2428 
	}
}

2430 
	$mmc_blk_ªmove
(
mmc_ˇrd
 *
ˇrd
)

2432 
mmc_blk_d©a
 *
md
 = 
	`mmc_gë_drvd©a
(
ˇrd
);

2434 
	`mmc_blk_ªmove_∑πs
(
ˇrd
, 
md
);

2435 
	`pm_ru¡ime_gë_sync
(&
ˇrd
->
dev
);

2436 
	`mmc_˛aim_ho°
(
ˇrd
->
ho°
);

2437 
	`mmc_blk_∑π_swôch
(
ˇrd
, 
md
);

2438 
	`mmc_ªÀa£_ho°
(
ˇrd
->
ho°
);

2439 i‡(
ˇrd
->
ty≥
 !
MMC_TYPE_SD_COMBO
)

2440 
	`pm_ru¡ime_dißbÀ
(&
ˇrd
->
dev
);

2441 
	`pm_ru¡ime_put_noidÀ
(&
ˇrd
->
dev
);

2442 
	`mmc_blk_ªmove_ªq
(
md
);

2443 
	`mmc_£t_drvd©a
(
ˇrd
, 
NULL
);

2444 
	}
}

2446 
	$_mmc_blk_su•íd
(
mmc_ˇrd
 *
ˇrd
)

2448 
mmc_blk_d©a
 *
∑π_md
;

2449 
mmc_blk_d©a
 *
md
 = 
	`mmc_gë_drvd©a
(
ˇrd
);

2451 i‡(
md
) {

2452 
	`mmc_queue_su•íd
(&
md
->
queue
);

2453 
	`li°_f‹_óch_íåy
(
∑π_md
, &
md
->
∑π
,Öart) {

2454 
	`mmc_queue_su•íd
(&
∑π_md
->
queue
);

2458 
	}
}

2460 
	$mmc_blk_shutdown
(
mmc_ˇrd
 *
ˇrd
)

2462 
	`_mmc_blk_su•íd
(
ˇrd
);

2463 
	}
}

2465 #ifde‡
CONFIG_PM


2466 
	$mmc_blk_su•íd
(
mmc_ˇrd
 *
ˇrd
)

2468  
	`_mmc_blk_su•íd
(
ˇrd
);

2469 
	}
}

2471 
	$mmc_blk_ªsume
(
mmc_ˇrd
 *
ˇrd
)

2473 
mmc_blk_d©a
 *
∑π_md
;

2474 
mmc_blk_d©a
 *
md
 = 
	`mmc_gë_drvd©a
(
ˇrd
);

2476 i‡(
md
) {

2481 
md
->
∑π_cuº
 = md->
∑π_ty≥
;

2482 
	`mmc_queue_ªsume
(&
md
->
queue
);

2483 
	`li°_f‹_óch_íåy
(
∑π_md
, &
md
->
∑π
,Öart) {

2484 
	`mmc_queue_ªsume
(&
∑π_md
->
queue
);

2488 
	}
}

2490 
	#mmc_blk_su•íd
 
NULL


	)

2491 
	#mmc_blk_ªsume
 
NULL


	)

2494 
mmc_drivî
 
	gmmc_drivî
 = {

2495 .
drv
 = {

2496 .
«me
 = "mmcblk",

2498 .
	g¥obe
 = 
mmc_blk_¥obe
,

2499 .
	gªmove
 = 
mmc_blk_ªmove
,

2500 .
	gsu•íd
 = 
mmc_blk_su•íd
,

2501 .
	gªsume
 = 
mmc_blk_ªsume
,

2502 .
	gshutdown
 = 
mmc_blk_shutdown
,

2505 
__öô
 
	$mmc_blk_öô
()

2507 
ªs
;

2509 i‡(
≥rdev_mö‹s
 !
CONFIG_MMC_BLOCK_MINORS
)

2510 
	`¥_öfo
("mmcblk: usög %d mö‹†≥∏devi˚\n", 
≥rdev_mö‹s
);

2512 
max_devi˚s
 = 256 / 
≥rdev_mö‹s
;

2514 
ªs
 = 
	`ªgi°î_blkdev
(
MMC_BLOCK_MAJOR
, "mmc");

2515 i‡(
ªs
)

2516 
out
;

2518 
ªs
 = 
	`mmc_ªgi°î_drivî
(&
mmc_drivî
);

2519 i‡(
ªs
)

2520 
out2
;

2523 
out2
:

2524 
	`uƒegi°î_blkdev
(
MMC_BLOCK_MAJOR
, "mmc");

2525 
out
:

2526  
ªs
;

2527 
	}
}

2529 
__exô
 
	$mmc_blk_exô
()

2531 
	`mmc_uƒegi°î_drivî
(&
mmc_drivî
);

2532 
	`uƒegi°î_blkdev
(
MMC_BLOCK_MAJOR
, "mmc");

2533 
	}
}

2535 
moduÀ_öô
(
mmc_blk_öô
);

2536 
moduÀ_exô
(
mmc_blk_exô
);

2538 
MODULE_LICENSE
("GPL");

2539 
MODULE_DESCRIPTION
("Multimedia Card (MMC) block device driver");

	@mmc_test.c

12 
	~<löux/mmc/c‹e.h
>

13 
	~<löux/mmc/ˇrd.h
>

14 
	~<löux/mmc/ho°.h
>

15 
	~<löux/mmc/mmc.h
>

16 
	~<löux/¶ab.h
>

18 
	~<löux/sˇâîli°.h
>

19 
	~<löux/sw≠.h
>

20 
	~<löux/li°.h
>

22 
	~<löux/debugfs.h
>

23 
	~<löux/uac˚ss.h
>

24 
	~<löux/£q_fûe.h
>

25 
	~<löux/moduÀ.h
>

27 
	#RESULT_OK
 0

	)

28 
	#RESULT_FAIL
 1

	)

29 
	#RESULT_UNSUP_HOST
 2

	)

30 
	#RESULT_UNSUP_CARD
 3

	)

32 
	#BUFFER_ORDER
 2

	)

33 
	#BUFFER_SIZE
 (
PAGE_SIZE
 << 
BUFFER_ORDER
)

	)

39 
	#TEST_AREA_MAX_SIZE
 (128 * 1024 * 1024)

	)

46 
	smmc_ã°_∑ges
 {

47 
∑ge
 *
	m∑ge
;

48 
	m‹dî
;

56 
	smmc_ã°_mem
 {

57 
mmc_ã°_∑ges
 *
	m¨r
;

58 
	m˙t
;

73 
	smmc_ã°_¨ó
 {

74 
	mmax_sz
;

75 
	mdev_addr
;

76 
	mmax_t‰
;

77 
	mmax_£gs
;

78 
	mmax_£g_sz
;

79 
	mblocks
;

80 
	msg_Àn
;

81 
mmc_ã°_mem
 *
	mmem
;

82 
sˇâîli°
 *
	msg
;

94 
	smmc_ã°_å™s„r_ªsu…
 {

95 
li°_hód
 
	mlök
;

96 
	mcou¡
;

97 
	m£˘‹s
;

98 
time•ec
 
	mts
;

99 
	møã
;

100 
	mi›s
;

111 
	smmc_ã°_gíîÆ_ªsu…
 {

112 
li°_hód
 
	mlök
;

113 
mmc_ˇrd
 *
	mˇrd
;

114 
	mã°ˇ£
;

115 
	mªsu…
;

116 
li°_hód
 
	må_l°
;

125 
	smmc_ã°_dbgfs_fûe
 {

126 
li°_hód
 
	mlök
;

127 
mmc_ˇrd
 *
	mˇrd
;

128 
díåy
 *
	mfûe
;

140 
	smmc_ã°_ˇrd
 {

141 
mmc_ˇrd
 *
	mˇrd
;

143 
u8
 
	ms¸©ch
[
BUFFER_SIZE
];

144 
u8
 *
	mbuf„r
;

145 #ifde‡
CONFIG_HIGHMEM


146 
∑ge
 *
	mhighmem
;

148 
mmc_ã°_¨ó
 
	m¨ó
;

149 
mmc_ã°_gíîÆ_ªsu…
 *
	mgr
;

152 
	emmc_ã°_¥ï_medü
 {

153 
	mMMC_TEST_PREP_NONE
 = 0,

154 
	mMMC_TEST_PREP_WRITE_FULL
 = 1 << 0,

155 
	mMMC_TEST_PREP_ERASE
 = 1 << 1,

158 
	smmc_ã°_mu…ùÀ_rw
 {

159 *
	msg_Àn
;

160 *
	mbs
;

161 
	mÀn
;

162 
	msize
;

163 
boﬁ
 
	mdo_wrôe
;

164 
boﬁ
 
	mdo_n⁄block_ªq
;

165 
mmc_ã°_¥ï_medü
 
	m¥ï¨e
;

168 
	smmc_ã°_async_ªq
 {

169 
mmc_async_ªq
 
	m¨eq
;

170 
mmc_ã°_ˇrd
 *
	mã°
;

180 
	$mmc_ã°_£t_blksize
(
mmc_ã°_ˇrd
 *
ã°
, 
size
)

182  
	`mmc_£t_blockÀn
(
ã°
->
ˇrd
, 
size
);

183 
	}
}

188 
	$mmc_ã°_¥ï¨e_mrq
(
mmc_ã°_ˇrd
 *
ã°
,

189 
mmc_ªque°
 *
mrq
, 
sˇâîli°
 *
sg
, 
sg_Àn
,

190 
dev_addr
, 
blocks
, 
blksz
, 
wrôe
)

192 
	`BUG_ON
(!
mrq
 || !mrq->
cmd
 || !mrq->
d©a
 || !mrq->
°›
);

194 i‡(
blocks
 > 1) {

195 
mrq
->
cmd
->
›code
 = 
wrôe
 ?

196 
MMC_WRITE_MULTIPLE_BLOCK
 : 
MMC_READ_MULTIPLE_BLOCK
;

198 
mrq
->
cmd
->
›code
 = 
wrôe
 ?

199 
MMC_WRITE_BLOCK
 : 
MMC_READ_SINGLE_BLOCK
;

202 
mrq
->
cmd
->
¨g
 = 
dev_addr
;

203 i‡(!
	`mmc_ˇrd_blockaddr
(
ã°
->
ˇrd
))

204 
mrq
->
cmd
->
¨g
 <<= 9;

206 
mrq
->
cmd
->
Êags
 = 
MMC_RSP_R1
 | 
MMC_CMD_ADTC
;

208 i‡(
blocks
 == 1)

209 
mrq
->
°›
 = 
NULL
;

211 
mrq
->
°›
->
›code
 = 
MMC_STOP_TRANSMISSION
;

212 
mrq
->
°›
->
¨g
 = 0;

213 
mrq
->
°›
->
Êags
 = 
MMC_RSP_R1B
 | 
MMC_CMD_AC
;

216 
mrq
->
d©a
->
blksz
 = blksz;

217 
mrq
->
d©a
->
blocks
 = blocks;

218 
mrq
->
d©a
->
Êags
 = 
wrôe
 ? 
MMC_DATA_WRITE
 : 
MMC_DATA_READ
;

219 
mrq
->
d©a
->
sg
 = sg;

220 
mrq
->
d©a
->
sg_Àn
 = sg_len;

222 
	`mmc_£t_d©a_timeout
(
mrq
->
d©a
, 
ã°
->
ˇrd
);

223 
	}
}

225 
	$mmc_ã°_busy
(
mmc_comm™d
 *
cmd
)

227  !(
cmd
->
ª•
[0] & 
R1_READY_FOR_DATA
) ||

228 (
	`R1_CURRENT_STATE
(
cmd
->
ª•
[0]Ë=
R1_STATE_PRG
);

229 
	}
}

234 
	$mmc_ã°_waô_busy
(
mmc_ã°_ˇrd
 *
ã°
)

236 
ªt
, 
busy
;

237 
mmc_comm™d
 
cmd
 = {0};

239 
busy
 = 0;

241 
	`mem£t
(&
cmd
, 0, (
mmc_comm™d
));

243 
cmd
.
›code
 = 
MMC_SEND_STATUS
;

244 
cmd
.
¨g
 = 
ã°
->
ˇrd
->
rˇ
 << 16;

245 
cmd
.
Êags
 = 
MMC_RSP_R1
 | 
MMC_CMD_AC
;

247 
ªt
 = 
	`mmc_waô_f‹_cmd
(
ã°
->
ˇrd
->
ho°
, &
cmd
, 0);

248 i‡(
ªt
)

251 i‡(!
busy
 && 
	`mmc_ã°_busy
(&
cmd
)) {

252 
busy
 = 1;

253 i‡(
ã°
->
ˇrd
->
ho°
->
ˇps
 & 
MMC_CAP_WAIT_WHILE_BUSY
)

254 
	`¥_öfo
("%s: Warning: Host didÇot "

256 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
));

258 } 
	`mmc_ã°_busy
(&
cmd
));

260  
ªt
;

261 
	}
}

266 
	$mmc_ã°_buf„r_å™s„r
(
mmc_ã°_ˇrd
 *
ã°
,

267 
u8
 *
buf„r
, 
addr
, 
blksz
, 
wrôe
)

269 
ªt
;

271 
mmc_ªque°
 
mrq
 = {0};

272 
mmc_comm™d
 
cmd
 = {0};

273 
mmc_comm™d
 
°›
 = {0};

274 
mmc_d©a
 
d©a
 = {0};

276 
sˇâîli°
 
sg
;

278 
mrq
.
cmd
 = &cmd;

279 
mrq
.
d©a
 = &data;

280 
mrq
.
°›
 = &stop;

282 
	`sg_öô_⁄e
(&
sg
, 
buf„r
, 
blksz
);

284 
	`mmc_ã°_¥ï¨e_mrq
(
ã°
, &
mrq
, &
sg
, 1, 
addr
, 1, 
blksz
, 
wrôe
);

286 
	`mmc_waô_f‹_ªq
(
ã°
->
ˇrd
->
ho°
, &
mrq
);

288 i‡(
cmd
.
îr‹
)

289  
cmd
.
îr‹
;

290 i‡(
d©a
.
îr‹
)

291  
d©a
.
îr‹
;

293 
ªt
 = 
	`mmc_ã°_waô_busy
(
ã°
);

294 i‡(
ªt
)

295  
ªt
;

298 
	}
}

300 
	$mmc_ã°_‰ì_mem
(
mmc_ã°_mem
 *
mem
)

302 i‡(!
mem
)

304 
mem
->
˙t
--)

305 
	`__‰ì_∑ges
(
mem
->
¨r
[mem->
˙t
].
∑ge
,

306 
mem
->
¨r
[mem->
˙t
].
‹dî
);

307 
	`k‰ì
(
mem
->
¨r
);

308 
	`k‰ì
(
mem
);

309 
	}
}

317 
mmc_ã°_mem
 *
	$mmc_ã°_Æloc_mem
(
mö_sz
,

318 
max_sz
,

319 
max_£gs
,

320 
max_£g_sz
)

322 
max_∑ge_˙t
 = 
	`DIV_ROUND_UP
(
max_sz
, 
PAGE_SIZE
);

323 
mö_∑ge_˙t
 = 
	`DIV_ROUND_UP
(
mö_sz
, 
PAGE_SIZE
);

324 
max_£g_∑ge_˙t
 = 
	`DIV_ROUND_UP
(
max_£g_sz
, 
PAGE_SIZE
);

325 
∑ge_˙t
 = 0;

326 
limô
 = 
	`ƒ_‰ì_buf„r_∑ges
() >> 4;

327 
mmc_ã°_mem
 *
mem
;

329 i‡(
max_∑ge_˙t
 > 
limô
)

330 
max_∑ge_˙t
 = 
limô
;

331 i‡(
mö_∑ge_˙t
 > 
max_∑ge_˙t
)

332 
mö_∑ge_˙t
 = 
max_∑ge_˙t
;

334 i‡(
max_£g_∑ge_˙t
 > 
max_∑ge_˙t
)

335 
max_£g_∑ge_˙t
 = 
max_∑ge_˙t
;

337 i‡(
max_£gs
 > 
max_∑ge_˙t
)

338 
max_£gs
 = 
max_∑ge_˙t
;

340 
mem
 = 
	`kzÆloc
((
mmc_ã°_mem
), 
GFP_KERNEL
);

341 i‡(!
mem
)

342  
NULL
;

344 
mem
->
¨r
 = 
	`kzÆloc
((
mmc_ã°_∑ges
Ë* 
max_£gs
,

345 
GFP_KERNEL
);

346 i‡(!
mem
->
¨r
)

347 
out_‰ì
;

349 
max_∑ge_˙t
) {

350 
∑ge
 *page;

351 
‹dî
;

352 
gÂ_t
 
Êags
 = 
GFP_KERNEL
 | 
GFP_DMA
 | 
__GFP_NOWARN
 |

353 
__GFP_NORETRY
;

355 
‹dî
 = 
	`gë_‹dî
(
max_£g_∑ge_˙t
 << 
PAGE_SHIFT
);

357 
∑ge
 = 
	`Æloc_∑ges
(
Êags
, 
‹dî
);

358 i‡(
∑ge
 || !
‹dî
)

360 
‹dî
 -= 1;

362 i‡(!
∑ge
) {

363 i‡(
∑ge_˙t
 < 
mö_∑ge_˙t
)

364 
out_‰ì
;

367 
mem
->
¨r
[mem->
˙t
].
∑ge
 =Öage;

368 
mem
->
¨r
[mem->
˙t
].
‹dî
 = order;

369 
mem
->
˙t
 += 1;

370 i‡(
max_∑ge_˙t
 <(1UL << 
‹dî
))

372 
max_∑ge_˙t
 -1UL << 
‹dî
;

373 
∑ge_˙t
 +1UL << 
‹dî
;

374 i‡(
mem
->
˙t
 >
max_£gs
) {

375 i‡(
∑ge_˙t
 < 
mö_∑ge_˙t
)

376 
out_‰ì
;

381  
mem
;

383 
out_‰ì
:

384 
	`mmc_ã°_‰ì_mem
(
mem
);

385  
NULL
;

386 
	}
}

392 
	$mmc_ã°_m≠_sg
(
mmc_ã°_mem
 *
mem
, 
size
,

393 
sˇâîli°
 *
sgli°
, 
ª≥©
,

394 
max_£gs
, 
max_£g_sz
,

395 *
sg_Àn
, 
mö_sg_Àn
)

397 
sˇâîli°
 *
sg
 = 
NULL
;

398 
i
;

399 
sz
 = 
size
;

401 
	`sg_öô_èbÀ
(
sgli°
, 
max_£gs
);

402 i‡(
mö_sg_Àn
 > 
max_£gs
)

403 
mö_sg_Àn
 = 
max_£gs
;

405 *
sg_Àn
 = 0;

407 
i
 = 0; i < 
mem
->
˙t
; i++) {

408 
Àn
 = 
PAGE_SIZE
 << 
mem
->
¨r
[
i
].
‹dî
;

410 i‡(
mö_sg_Àn
 && (
size
 / mö_sg_À¿< 
Àn
))

411 
Àn
 = 
	`ALIGN
(
size
 / 
mö_sg_Àn
, 512);

412 i‡(
Àn
 > 
sz
)

413 
Àn
 = 
sz
;

414 i‡(
Àn
 > 
max_£g_sz
)

415 
Àn
 = 
max_£g_sz
;

416 i‡(
sg
)

417 
sg
 = 
	`sg_√xt
(sg);

419 
sg
 = 
sgli°
;

420 i‡(!
sg
)

421  -
EINVAL
;

422 
	`sg_£t_∑ge
(
sg
, 
mem
->
¨r
[
i
].
∑ge
, 
Àn
, 0);

423 
sz
 -
Àn
;

424 *
sg_Àn
 += 1;

425 i‡(!
sz
)

428 } 
sz
 && 
ª≥©
);

430 i‡(
sz
)

431  -
EINVAL
;

433 i‡(
sg
)

434 
	`sg_m¨k_íd
(
sg
);

437 
	}
}

443 
	$mmc_ã°_m≠_sg_max_sˇâî
(
mmc_ã°_mem
 *
mem
,

444 
sz
,

445 
sˇâîli°
 *
sgli°
,

446 
max_£gs
,

447 
max_£g_sz
,

448 *
sg_Àn
)

450 
sˇâîli°
 *
sg
 = 
NULL
;

451 
i
 = 
mem
->
˙t
, cnt;

452 
Àn
;

453 *
ba£
, *
addr
, *
œ°_addr
 = 
NULL
;

455 
	`sg_öô_èbÀ
(
sgli°
, 
max_£gs
);

457 *
sg_Àn
 = 0;

458 
sz
) {

459 
ba£
 = 
	`∑ge_addªss
(
mem
->
¨r
[--
i
].
∑ge
);

460 
˙t
 = 1 << 
mem
->
¨r
[
i
].
‹dî
;

461 
sz
 && 
˙t
) {

462 
addr
 = 
ba£
 + 
PAGE_SIZE
 * --
˙t
;

463 i‡(
œ°_addr
 &&Üa°_add∏+ 
PAGE_SIZE
 =
addr
)

465 
œ°_addr
 = 
addr
;

466 
Àn
 = 
PAGE_SIZE
;

467 i‡(
Àn
 > 
max_£g_sz
)

468 
Àn
 = 
max_£g_sz
;

469 i‡(
Àn
 > 
sz
)

470 
Àn
 = 
sz
;

471 i‡(
sg
)

472 
sg
 = 
	`sg_√xt
(sg);

474 
sg
 = 
sgli°
;

475 i‡(!
sg
)

476  -
EINVAL
;

477 
	`sg_£t_∑ge
(
sg
, 
	`vút_to_∑ge
(
addr
), 
Àn
, 0);

478 
sz
 -
Àn
;

479 *
sg_Àn
 += 1;

481 i‡(
i
 == 0)

482 
i
 = 
mem
->
˙t
;

485 i‡(
sg
)

486 
	`sg_m¨k_íd
(
sg
);

489 
	}
}

494 
	$mmc_ã°_øã
(
uöt64_t
 
byãs
, 
time•ec
 *
ts
)

496 
uöt64_t
 
ns
;

498 
ns
 = 
ts
->
tv_£c
;

499 
ns
 *= 1000000000;

500 
ns
 +
ts
->
tv_n£c
;

502 
byãs
 *= 1000000000;

504 
ns
 > 
UINT_MAX
) {

505 
byãs
 >>= 1;

506 
ns
 >>= 1;

509 i‡(!
ns
)

512 
	`do_div
(
byãs
, (
uöt32_t
)
ns
);

514  
byãs
;

515 
	}
}

520 
	$mmc_ã°_ßve_å™s„r_ªsu…
(
mmc_ã°_ˇrd
 *
ã°
,

521 
cou¡
, 
£˘‹s
, 
time•ec
 
ts
,

522 
øã
, 
i›s
)

524 
mmc_ã°_å™s„r_ªsu…
 *
å
;

526 i‡(!
ã°
->
gr
)

529 
å
 = 
	`kmÆloc
((
mmc_ã°_å™s„r_ªsu…
), 
GFP_KERNEL
);

530 i‡(!
å
)

533 
å
->
cou¡
 = count;

534 
å
->
£˘‹s
 = sectors;

535 
å
->
ts
 =Ås;

536 
å
->
øã
 =Ñate;

537 
å
->
i›s
 = iops;

539 
	`li°_add_èû
(&
å
->
lök
, &
ã°
->
gr
->
å_l°
);

540 
	}
}

545 
	$mmc_ã°_¥öt_øã
(
mmc_ã°_ˇrd
 *
ã°
, 
uöt64_t
 
byãs
,

546 
time•ec
 *
ts1
, time•e¯*
ts2
)

548 
øã
, 
i›s
, 
£˘‹s
 = 
byãs
 >> 9;

549 
time•ec
 
ts
;

551 
ts
 = 
	`time•ec_sub
(*
ts2
, *
ts1
);

553 
øã
 = 
	`mmc_ã°_øã
(
byãs
, &
ts
);

554 
i›s
 = 
	`mmc_ã°_øã
(100, &
ts
);

556 
	`¥_öfo
("%s: Transfer of %u sectors (%u%s KiB)Åook %lu.%09lu "

558 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
), 
£˘‹s
, sectors >> 1,

559 (
£˘‹s
 & 1 ? ".5" : ""), ()
ts
.
tv_£c
,

560 ()
ts
.
tv_n£c
, 
øã
 / 1000,Ñate / 1024,

561 
i›s
 / 100, iops % 100);

563 
	`mmc_ã°_ßve_å™s„r_ªsu…
(
ã°
, 1, 
£˘‹s
, 
ts
, 
øã
, 
i›s
);

564 
	}
}

569 
	$mmc_ã°_¥öt_avg_øã
(
mmc_ã°_ˇrd
 *
ã°
, 
uöt64_t
 
byãs
,

570 
cou¡
, 
time•ec
 *
ts1
,

571 
time•ec
 *
ts2
)

573 
øã
, 
i›s
, 
£˘‹s
 = 
byãs
 >> 9;

574 
uöt64_t
 
tŸ
 = 
byãs
 * 
cou¡
;

575 
time•ec
 
ts
;

577 
ts
 = 
	`time•ec_sub
(*
ts2
, *
ts1
);

579 
øã
 = 
	`mmc_ã°_øã
(
tŸ
, &
ts
);

580 
i›s
 = 
	`mmc_ã°_øã
(
cou¡
 * 100, &
ts
);

582 
	`¥_öfo
("%s: Transfer of %u x %u sectors (%u x %u%s KiB)Åook "

585 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
), 
cou¡
, 
£˘‹s
, count,

586 
£˘‹s
 >> 1, (sectors & 1 ? ".5" : ""),

587 ()
ts
.
tv_£c
, (Ès.
tv_n£c
,

588 
øã
 / 1000,Ñ©ê/ 1024, 
i›s
 / 100, iops % 100,

589 
ã°
->
¨ó
.
sg_Àn
);

591 
	`mmc_ã°_ßve_å™s„r_ªsu…
(
ã°
, 
cou¡
, 
£˘‹s
, 
ts
, 
øã
, 
i›s
);

592 
	}
}

597 
	$mmc_ã°_ˇ∑côy
(
mmc_ˇrd
 *
ˇrd
)

599 i‡(!
	`mmc_ˇrd_sd
(
ˇrd
Ë&& 
	`mmc_ˇrd_blockaddr
(card))

600  
ˇrd
->
ext_csd
.
£˘‹s
;

602  
ˇrd
->
csd
.
ˇ∑côy
 << (ˇrd->csd.
ªad_blkbôs
 - 9);

603 
	}
}

613 
	$__mmc_ã°_¥ï¨e
(
mmc_ã°_ˇrd
 *
ã°
, 
wrôe
)

615 
ªt
, 
i
;

617 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 512);

618 i‡(
ªt
)

619  
ªt
;

621 i‡(
wrôe
)

622 
	`mem£t
(
ã°
->
buf„r
, 0xDF, 512);

624 
i
 = 0;i < 512;i++)

625 
ã°
->
buf„r
[
i
] = i;

628 
i
 = 0;ò< 
BUFFER_SIZE
 / 512;i++) {

629 
ªt
 = 
	`mmc_ã°_buf„r_å™s„r
(
ã°
,Åe°->
buf„r
, 
i
, 512, 1);

630 i‡(
ªt
)

631  
ªt
;

635 
	}
}

637 
	$mmc_ã°_¥ï¨e_wrôe
(
mmc_ã°_ˇrd
 *
ã°
)

639  
	`__mmc_ã°_¥ï¨e
(
ã°
, 1);

640 
	}
}

642 
	$mmc_ã°_¥ï¨e_ªad
(
mmc_ã°_ˇrd
 *
ã°
)

644  
	`__mmc_ã°_¥ï¨e
(
ã°
, 0);

645 
	}
}

647 
	$mmc_ã°_˛ónup
(
mmc_ã°_ˇrd
 *
ã°
)

649 
ªt
, 
i
;

651 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 512);

652 i‡(
ªt
)

653  
ªt
;

655 
	`mem£t
(
ã°
->
buf„r
, 0, 512);

657 
i
 = 0;ò< 
BUFFER_SIZE
 / 512;i++) {

658 
ªt
 = 
	`mmc_ã°_buf„r_å™s„r
(
ã°
,Åe°->
buf„r
, 
i
, 512, 1);

659 i‡(
ªt
)

660  
ªt
;

664 
	}
}

673 
	$mmc_ã°_¥ï¨e_brokí_mrq
(
mmc_ã°_ˇrd
 *
ã°
,

674 
mmc_ªque°
 *
mrq
, 
wrôe
)

676 
	`BUG_ON
(!
mrq
 || !mrq->
cmd
 || !mrq->
d©a
);

678 i‡(
mrq
->
d©a
->
blocks
 > 1) {

679 
mrq
->
cmd
->
›code
 = 
wrôe
 ?

680 
MMC_WRITE_BLOCK
 : 
MMC_READ_SINGLE_BLOCK
;

681 
mrq
->
°›
 = 
NULL
;

683 
mrq
->
cmd
->
›code
 = 
MMC_SEND_STATUS
;

684 
mrq
->
cmd
->
¨g
 = 
ã°
->
ˇrd
->
rˇ
 << 16;

686 
	}
}

691 
	$mmc_ã°_check_ªsu…
(
mmc_ã°_ˇrd
 *
ã°
,

692 
mmc_ªque°
 *
mrq
)

694 
ªt
;

696 
	`BUG_ON
(!
mrq
 || !mrq->
cmd
 || !mrq->
d©a
);

698 
ªt
 = 0;

700 i‡(!
ªt
 && 
mrq
->
cmd
->
îr‹
)

701 
ªt
 = 
mrq
->
cmd
->
îr‹
;

702 i‡(!
ªt
 && 
mrq
->
d©a
->
îr‹
)

703 
ªt
 = 
mrq
->
d©a
->
îr‹
;

704 i‡(!
ªt
 && 
mrq
->
°›
 && mrq->°›->
îr‹
)

705 
ªt
 = 
mrq
->
°›
->
îr‹
;

706 i‡(!
ªt
 && 
mrq
->
d©a
->
byãs_x„ªd
 !=

707 
mrq
->
d©a
->
blocks
 * mrq->d©a->
blksz
)

708 
ªt
 = 
RESULT_FAIL
;

710 i‡(
ªt
 =-
EINVAL
)

711 
ªt
 = 
RESULT_UNSUP_HOST
;

713  
ªt
;

714 
	}
}

716 
	$mmc_ã°_check_ªsu…_async
(
mmc_ˇrd
 *
ˇrd
,

717 
mmc_async_ªq
 *
¨eq
)

719 
mmc_ã°_async_ªq
 *
ã°_async
 =

720 
	`c⁄èöî_of
(
¨eq
, 
mmc_ã°_async_ªq
,áreq);

722 
	`mmc_ã°_waô_busy
(
ã°_async
->
ã°
);

724  
	`mmc_ã°_check_ªsu…
(
ã°_async
->
ã°
, 
¨eq
->
mrq
);

725 
	}
}

730 
	$mmc_ã°_check_brokí_ªsu…
(
mmc_ã°_ˇrd
 *
ã°
,

731 
mmc_ªque°
 *
mrq
)

733 
ªt
;

735 
	`BUG_ON
(!
mrq
 || !mrq->
cmd
 || !mrq->
d©a
);

737 
ªt
 = 0;

739 i‡(!
ªt
 && 
mrq
->
cmd
->
îr‹
)

740 
ªt
 = 
mrq
->
cmd
->
îr‹
;

741 i‡(!
ªt
 && 
mrq
->
d©a
->
îr‹
 == 0)

742 
ªt
 = 
RESULT_FAIL
;

743 i‡(!
ªt
 && 
mrq
->
d©a
->
îr‹
 !-
ETIMEDOUT
)

744 
ªt
 = 
mrq
->
d©a
->
îr‹
;

745 i‡(!
ªt
 && 
mrq
->
°›
 && mrq->°›->
îr‹
)

746 
ªt
 = 
mrq
->
°›
->
îr‹
;

747 i‡(
mrq
->
d©a
->
blocks
 > 1) {

748 i‡(!
ªt
 && 
mrq
->
d©a
->
byãs_x„ªd
 > mrq->d©a->
blksz
)

749 
ªt
 = 
RESULT_FAIL
;

751 i‡(!
ªt
 && 
mrq
->
d©a
->
byãs_x„ªd
 > 0)

752 
ªt
 = 
RESULT_FAIL
;

755 i‡(
ªt
 =-
EINVAL
)

756 
ªt
 = 
RESULT_UNSUP_HOST
;

758  
ªt
;

759 
	}
}

764 
	$mmc_ã°_n⁄block_ª£t
(
mmc_ªque°
 *
mrq
,

765 
mmc_comm™d
 *
cmd
,

766 
mmc_comm™d
 *
°›
,

767 
mmc_d©a
 *
d©a
)

769 
	`mem£t
(
mrq
, 0, (
mmc_ªque°
));

770 
	`mem£t
(
cmd
, 0, (
mmc_comm™d
));

771 
	`mem£t
(
d©a
, 0, (
mmc_d©a
));

772 
	`mem£t
(
°›
, 0, (
mmc_comm™d
));

774 
mrq
->
cmd
 = cmd;

775 
mrq
->
d©a
 = data;

776 
mrq
->
°›
 = stop;

777 
	}
}

778 
	$mmc_ã°_n⁄block_å™s„r
(
mmc_ã°_ˇrd
 *
ã°
,

779 
sˇâîli°
 *
sg
, 
sg_Àn
,

780 
dev_addr
, 
blocks
,

781 
blksz
, 
wrôe
, 
cou¡
)

783 
mmc_ªque°
 
mrq1
;

784 
mmc_comm™d
 
cmd1
;

785 
mmc_comm™d
 
°›1
;

786 
mmc_d©a
 
d©a1
;

788 
mmc_ªque°
 
mrq2
;

789 
mmc_comm™d
 
cmd2
;

790 
mmc_comm™d
 
°›2
;

791 
mmc_d©a
 
d©a2
;

793 
mmc_ã°_async_ªq
 
ã°_¨eq
[2];

794 
mmc_async_ªq
 *
d⁄e_¨eq
;

795 
mmc_async_ªq
 *
cur_¨eq
 = &
ã°_¨eq
[0].
¨eq
;

796 
mmc_async_ªq
 *
Ÿhî_¨eq
 = &
ã°_¨eq
[1].
¨eq
;

797 
i
;

798 
ªt
;

800 
ã°_¨eq
[0].
ã°
 =Åest;

801 
ã°_¨eq
[1].
ã°
 =Åest;

803 
	`mmc_ã°_n⁄block_ª£t
(&
mrq1
, &
cmd1
, &
°›1
, &
d©a1
);

804 
	`mmc_ã°_n⁄block_ª£t
(&
mrq2
, &
cmd2
, &
°›2
, &
d©a2
);

806 
cur_¨eq
->
mrq
 = &
mrq1
;

807 
cur_¨eq
->
îr_check
 = 
mmc_ã°_check_ªsu…_async
;

808 
Ÿhî_¨eq
->
mrq
 = &
mrq2
;

809 
Ÿhî_¨eq
->
îr_check
 = 
mmc_ã°_check_ªsu…_async
;

811 
i
 = 0; i < 
cou¡
; i++) {

812 
	`mmc_ã°_¥ï¨e_mrq
(
ã°
, 
cur_¨eq
->
mrq
, 
sg
, 
sg_Àn
, 
dev_addr
,

813 
blocks
, 
blksz
, 
wrôe
);

814 
d⁄e_¨eq
 = 
	`mmc_°¨t_ªq
(
ã°
->
ˇrd
->
ho°
, 
cur_¨eq
, &
ªt
);

816 i‡(
ªt
 || (!
d⁄e_¨eq
 && 
i
 > 0))

817 
îr
;

819 i‡(
d⁄e_¨eq
) {

820 i‡(
d⁄e_¨eq
->
mrq
 =&
mrq2
)

821 
	`mmc_ã°_n⁄block_ª£t
(&
mrq2
, &
cmd2
,

822 &
°›2
, &
d©a2
);

824 
	`mmc_ã°_n⁄block_ª£t
(&
mrq1
, &
cmd1
,

825 &
°›1
, &
d©a1
);

827 
d⁄e_¨eq
 = 
cur_¨eq
;

828 
cur_¨eq
 = 
Ÿhî_¨eq
;

829 
Ÿhî_¨eq
 = 
d⁄e_¨eq
;

830 
dev_addr
 +
blocks
;

833 
d⁄e_¨eq
 = 
	`mmc_°¨t_ªq
(
ã°
->
ˇrd
->
ho°
, 
NULL
, &
ªt
);

835  
ªt
;

836 
îr
:

837  
ªt
;

838 
	}
}

843 
	$mmc_ã°_sim∂e_å™s„r
(
mmc_ã°_ˇrd
 *
ã°
,

844 
sˇâîli°
 *
sg
, 
sg_Àn
, 
dev_addr
,

845 
blocks
, 
blksz
, 
wrôe
)

847 
mmc_ªque°
 
mrq
 = {0};

848 
mmc_comm™d
 
cmd
 = {0};

849 
mmc_comm™d
 
°›
 = {0};

850 
mmc_d©a
 
d©a
 = {0};

852 
mrq
.
cmd
 = &cmd;

853 
mrq
.
d©a
 = &data;

854 
mrq
.
°›
 = &stop;

856 
	`mmc_ã°_¥ï¨e_mrq
(
ã°
, &
mrq
, 
sg
, 
sg_Àn
, 
dev_addr
,

857 
blocks
, 
blksz
, 
wrôe
);

859 
	`mmc_waô_f‹_ªq
(
ã°
->
ˇrd
->
ho°
, &
mrq
);

861 
	`mmc_ã°_waô_busy
(
ã°
);

863  
	`mmc_ã°_check_ªsu…
(
ã°
, &
mrq
);

864 
	}
}

869 
	$mmc_ã°_brokí_å™s„r
(
mmc_ã°_ˇrd
 *
ã°
,

870 
blocks
, 
blksz
, 
wrôe
)

872 
mmc_ªque°
 
mrq
 = {0};

873 
mmc_comm™d
 
cmd
 = {0};

874 
mmc_comm™d
 
°›
 = {0};

875 
mmc_d©a
 
d©a
 = {0};

877 
sˇâîli°
 
sg
;

879 
mrq
.
cmd
 = &cmd;

880 
mrq
.
d©a
 = &data;

881 
mrq
.
°›
 = &stop;

883 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 
blocks
 * 
blksz
);

885 
	`mmc_ã°_¥ï¨e_mrq
(
ã°
, &
mrq
, &
sg
, 1, 0, 
blocks
, 
blksz
, 
wrôe
);

886 
	`mmc_ã°_¥ï¨e_brokí_mrq
(
ã°
, &
mrq
, 
wrôe
);

888 
	`mmc_waô_f‹_ªq
(
ã°
->
ˇrd
->
ho°
, &
mrq
);

890 
	`mmc_ã°_waô_busy
(
ã°
);

892  
	`mmc_ã°_check_brokí_ªsu…
(
ã°
, &
mrq
);

893 
	}
}

900 
	$mmc_ã°_å™s„r
(
mmc_ã°_ˇrd
 *
ã°
,

901 
sˇâîli°
 *
sg
, 
sg_Àn
, 
dev_addr
,

902 
blocks
, 
blksz
, 
wrôe
)

904 
ªt
, 
i
;

905 
Êags
;

907 i‡(
wrôe
) {

908 
i
 = 0;ò< 
blocks
 * 
blksz
;i++)

909 
ã°
->
s¸©ch
[
i
] = i;

911 
	`mem£t
(
ã°
->
s¸©ch
, 0, 
BUFFER_SIZE
);

913 
	`loˇl_úq_ßve
(
Êags
);

914 
	`sg_c›y_‰om_buf„r
(
sg
, 
sg_Àn
, 
ã°
->
s¸©ch
, 
BUFFER_SIZE
);

915 
	`loˇl_úq_ª°‹e
(
Êags
);

917 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 
blksz
);

918 i‡(
ªt
)

919  
ªt
;

921 
ªt
 = 
	`mmc_ã°_sim∂e_å™s„r
(
ã°
, 
sg
, 
sg_Àn
, 
dev_addr
,

922 
blocks
, 
blksz
, 
wrôe
);

923 i‡(
ªt
)

924  
ªt
;

926 i‡(
wrôe
) {

927 
£˘‹s
;

929 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 512);

930 i‡(
ªt
)

931  
ªt
;

933 
£˘‹s
 = (
blocks
 * 
blksz
 + 511) / 512;

934 i‡((
£˘‹s
 * 512Ë=(
blocks
 * 
blksz
))

935 
£˘‹s
++;

937 i‡((
£˘‹s
 * 512Ë> 
BUFFER_SIZE
)

938  -
EINVAL
;

940 
	`mem£t
(
ã°
->
buf„r
, 0, 
£˘‹s
 * 512);

942 
i
 = 0;ò< 
£˘‹s
;i++) {

943 
ªt
 = 
	`mmc_ã°_buf„r_å™s„r
(
ã°
,

944 
ã°
->
buf„r
 + 
i
 * 512,

945 
dev_addr
 + 
i
, 512, 0);

946 i‡(
ªt
)

947  
ªt
;

950 
i
 = 0;ò< 
blocks
 * 
blksz
;i++) {

951 i‡(
ã°
->
buf„r
[
i
] !(
u8
)i)

952  
RESULT_FAIL
;

955 ;
i
 < 
£˘‹s
 * 512;i++) {

956 i‡(
ã°
->
buf„r
[
i
] != 0xDF)

957  
RESULT_FAIL
;

960 
	`loˇl_úq_ßve
(
Êags
);

961 
	`sg_c›y_to_buf„r
(
sg
, 
sg_Àn
, 
ã°
->
s¸©ch
, 
BUFFER_SIZE
);

962 
	`loˇl_úq_ª°‹e
(
Êags
);

963 
i
 = 0;ò< 
blocks
 * 
blksz
;i++) {

964 i‡(
ã°
->
s¸©ch
[
i
] !(
u8
)i)

965  
RESULT_FAIL
;

970 
	}
}

976 
	smmc_ã°_ˇ£
 {

977 c⁄° *
	m«me
;

979 (*
	m¥ï¨e
)(
	mmmc_ã°_ˇrd
 *);

980 (*
	mrun
)(
	mmmc_ã°_ˇrd
 *);

981 (*
	m˛ónup
)(
	mmmc_ã°_ˇrd
 *);

984 
	$mmc_ã°_basic_wrôe
(
mmc_ã°_ˇrd
 *
ã°
)

986 
ªt
;

987 
sˇâîli°
 
sg
;

989 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 512);

990 i‡(
ªt
)

991  
ªt
;

993 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 512);

995 
ªt
 = 
	`mmc_ã°_sim∂e_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 512, 1);

996 i‡(
ªt
)

997  
ªt
;

1000 
	}
}

1002 
	$mmc_ã°_basic_ªad
(
mmc_ã°_ˇrd
 *
ã°
)

1004 
ªt
;

1005 
sˇâîli°
 
sg
;

1007 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 512);

1008 i‡(
ªt
)

1009  
ªt
;

1011 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 512);

1013 
ªt
 = 
	`mmc_ã°_sim∂e_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 512, 0);

1014 i‡(
ªt
)

1015  
ªt
;

1018 
	}
}

1020 
	$mmc_ã°_vîify_wrôe
(
mmc_ã°_ˇrd
 *
ã°
)

1022 
ªt
;

1023 
sˇâîli°
 
sg
;

1025 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 512);

1027 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 512, 1);

1028 i‡(
ªt
)

1029  
ªt
;

1032 
	}
}

1034 
	$mmc_ã°_vîify_ªad
(
mmc_ã°_ˇrd
 *
ã°
)

1036 
ªt
;

1037 
sˇâîli°
 
sg
;

1039 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 512);

1041 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 512, 0);

1042 i‡(
ªt
)

1043  
ªt
;

1046 
	}
}

1048 
	$mmc_ã°_mu…i_wrôe
(
mmc_ã°_ˇrd
 *
ã°
)

1050 
ªt
;

1051 
size
;

1052 
sˇâîli°
 
sg
;

1054 i‡(
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 == 1)

1055  
RESULT_UNSUP_HOST
;

1057 
size
 = 
PAGE_SIZE
 * 2;

1058 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_ªq_size
);

1059 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_£g_size
);

1060 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 * 512);

1062 i‡(
size
 < 1024)

1063  
RESULT_UNSUP_HOST
;

1065 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 
size
);

1067 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 
size
/512, 512, 1);

1068 i‡(
ªt
)

1069  
ªt
;

1072 
	}
}

1074 
	$mmc_ã°_mu…i_ªad
(
mmc_ã°_ˇrd
 *
ã°
)

1076 
ªt
;

1077 
size
;

1078 
sˇâîli°
 
sg
;

1080 i‡(
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 == 1)

1081  
RESULT_UNSUP_HOST
;

1083 
size
 = 
PAGE_SIZE
 * 2;

1084 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_ªq_size
);

1085 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_£g_size
);

1086 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 * 512);

1088 i‡(
size
 < 1024)

1089  
RESULT_UNSUP_HOST
;

1091 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 
size
);

1093 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 
size
/512, 512, 0);

1094 i‡(
ªt
)

1095  
ªt
;

1098 
	}
}

1100 
	$mmc_ã°_pow2_wrôe
(
mmc_ã°_ˇrd
 *
ã°
)

1102 
ªt
, 
i
;

1103 
sˇâîli°
 
sg
;

1105 i‡(!
ã°
->
ˇrd
->
csd
.
wrôe_∑πül
)

1106  
RESULT_UNSUP_CARD
;

1108 
i
 = 1; i < 512;i <<= 1) {

1109 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 
i
);

1110 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 
i
, 1);

1111 i‡(
ªt
)

1112  
ªt
;

1116 
	}
}

1118 
	$mmc_ã°_pow2_ªad
(
mmc_ã°_ˇrd
 *
ã°
)

1120 
ªt
, 
i
;

1121 
sˇâîli°
 
sg
;

1123 i‡(!
ã°
->
ˇrd
->
csd
.
ªad_∑πül
)

1124  
RESULT_UNSUP_CARD
;

1126 
i
 = 1; i < 512;i <<= 1) {

1127 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 
i
);

1128 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 
i
, 0);

1129 i‡(
ªt
)

1130  
ªt
;

1134 
	}
}

1136 
	$mmc_ã°_weúd_wrôe
(
mmc_ã°_ˇrd
 *
ã°
)

1138 
ªt
, 
i
;

1139 
sˇâîli°
 
sg
;

1141 i‡(!
ã°
->
ˇrd
->
csd
.
wrôe_∑πül
)

1142  
RESULT_UNSUP_CARD
;

1144 
i
 = 3; i < 512;i += 7) {

1145 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 
i
);

1146 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 
i
, 1);

1147 i‡(
ªt
)

1148  
ªt
;

1152 
	}
}

1154 
	$mmc_ã°_weúd_ªad
(
mmc_ã°_ˇrd
 *
ã°
)

1156 
ªt
, 
i
;

1157 
sˇâîli°
 
sg
;

1159 i‡(!
ã°
->
ˇrd
->
csd
.
ªad_∑πül
)

1160  
RESULT_UNSUP_CARD
;

1162 
i
 = 3; i < 512;i += 7) {

1163 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
, 
i
);

1164 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 
i
, 0);

1165 i‡(
ªt
)

1166  
ªt
;

1170 
	}
}

1172 
	$mmc_ã°_Æign_wrôe
(
mmc_ã°_ˇrd
 *
ã°
)

1174 
ªt
, 
i
;

1175 
sˇâîli°
 
sg
;

1177 
i
 = 1;i < 4;i++) {

1178 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
 + 
i
, 512);

1179 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 512, 1);

1180 i‡(
ªt
)

1181  
ªt
;

1185 
	}
}

1187 
	$mmc_ã°_Æign_ªad
(
mmc_ã°_ˇrd
 *
ã°
)

1189 
ªt
, 
i
;

1190 
sˇâîli°
 
sg
;

1192 
i
 = 1;i < 4;i++) {

1193 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
 + 
i
, 512);

1194 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 512, 0);

1195 i‡(
ªt
)

1196  
ªt
;

1200 
	}
}

1202 
	$mmc_ã°_Æign_mu…i_wrôe
(
mmc_ã°_ˇrd
 *
ã°
)

1204 
ªt
, 
i
;

1205 
size
;

1206 
sˇâîli°
 
sg
;

1208 i‡(
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 == 1)

1209  
RESULT_UNSUP_HOST
;

1211 
size
 = 
PAGE_SIZE
 * 2;

1212 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_ªq_size
);

1213 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_£g_size
);

1214 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 * 512);

1216 i‡(
size
 < 1024)

1217  
RESULT_UNSUP_HOST
;

1219 
i
 = 1;i < 4;i++) {

1220 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
 + 
i
, 
size
);

1221 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 
size
/512, 512, 1);

1222 i‡(
ªt
)

1223  
ªt
;

1227 
	}
}

1229 
	$mmc_ã°_Æign_mu…i_ªad
(
mmc_ã°_ˇrd
 *
ã°
)

1231 
ªt
, 
i
;

1232 
size
;

1233 
sˇâîli°
 
sg
;

1235 i‡(
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 == 1)

1236  
RESULT_UNSUP_HOST
;

1238 
size
 = 
PAGE_SIZE
 * 2;

1239 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_ªq_size
);

1240 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_£g_size
);

1241 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 * 512);

1243 i‡(
size
 < 1024)

1244  
RESULT_UNSUP_HOST
;

1246 
i
 = 1;i < 4;i++) {

1247 
	`sg_öô_⁄e
(&
sg
, 
ã°
->
buf„r
 + 
i
, 
size
);

1248 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 
size
/512, 512, 0);

1249 i‡(
ªt
)

1250  
ªt
;

1254 
	}
}

1256 
	$mmc_ã°_x„rsize_wrôe
(
mmc_ã°_ˇrd
 *
ã°
)

1258 
ªt
;

1260 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 512);

1261 i‡(
ªt
)

1262  
ªt
;

1264 
ªt
 = 
	`mmc_ã°_brokí_å™s„r
(
ã°
, 1, 512, 1);

1265 i‡(
ªt
)

1266  
ªt
;

1269 
	}
}

1271 
	$mmc_ã°_x„rsize_ªad
(
mmc_ã°_ˇrd
 *
ã°
)

1273 
ªt
;

1275 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 512);

1276 i‡(
ªt
)

1277  
ªt
;

1279 
ªt
 = 
	`mmc_ã°_brokí_å™s„r
(
ã°
, 1, 512, 0);

1280 i‡(
ªt
)

1281  
ªt
;

1284 
	}
}

1286 
	$mmc_ã°_mu…i_x„rsize_wrôe
(
mmc_ã°_ˇrd
 *
ã°
)

1288 
ªt
;

1290 i‡(
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 == 1)

1291  
RESULT_UNSUP_HOST
;

1293 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 512);

1294 i‡(
ªt
)

1295  
ªt
;

1297 
ªt
 = 
	`mmc_ã°_brokí_å™s„r
(
ã°
, 2, 512, 1);

1298 i‡(
ªt
)

1299  
ªt
;

1302 
	}
}

1304 
	$mmc_ã°_mu…i_x„rsize_ªad
(
mmc_ã°_ˇrd
 *
ã°
)

1306 
ªt
;

1308 i‡(
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 == 1)

1309  
RESULT_UNSUP_HOST
;

1311 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 512);

1312 i‡(
ªt
)

1313  
ªt
;

1315 
ªt
 = 
	`mmc_ã°_brokí_å™s„r
(
ã°
, 2, 512, 0);

1316 i‡(
ªt
)

1317  
ªt
;

1320 
	}
}

1322 #ifde‡
CONFIG_HIGHMEM


1324 
	$mmc_ã°_wrôe_high
(
mmc_ã°_ˇrd
 *
ã°
)

1326 
ªt
;

1327 
sˇâîli°
 
sg
;

1329 
	`sg_öô_èbÀ
(&
sg
, 1);

1330 
	`sg_£t_∑ge
(&
sg
, 
ã°
->
highmem
, 512, 0);

1332 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 512, 1);

1333 i‡(
ªt
)

1334  
ªt
;

1337 
	}
}

1339 
	$mmc_ã°_ªad_high
(
mmc_ã°_ˇrd
 *
ã°
)

1341 
ªt
;

1342 
sˇâîli°
 
sg
;

1344 
	`sg_öô_èbÀ
(&
sg
, 1);

1345 
	`sg_£t_∑ge
(&
sg
, 
ã°
->
highmem
, 512, 0);

1347 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 1, 512, 0);

1348 i‡(
ªt
)

1349  
ªt
;

1352 
	}
}

1354 
	$mmc_ã°_mu…i_wrôe_high
(
mmc_ã°_ˇrd
 *
ã°
)

1356 
ªt
;

1357 
size
;

1358 
sˇâîli°
 
sg
;

1360 i‡(
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 == 1)

1361  
RESULT_UNSUP_HOST
;

1363 
size
 = 
PAGE_SIZE
 * 2;

1364 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_ªq_size
);

1365 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_£g_size
);

1366 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 * 512);

1368 i‡(
size
 < 1024)

1369  
RESULT_UNSUP_HOST
;

1371 
	`sg_öô_èbÀ
(&
sg
, 1);

1372 
	`sg_£t_∑ge
(&
sg
, 
ã°
->
highmem
, 
size
, 0);

1374 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 
size
/512, 512, 1);

1375 i‡(
ªt
)

1376  
ªt
;

1379 
	}
}

1381 
	$mmc_ã°_mu…i_ªad_high
(
mmc_ã°_ˇrd
 *
ã°
)

1383 
ªt
;

1384 
size
;

1385 
sˇâîli°
 
sg
;

1387 i‡(
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 == 1)

1388  
RESULT_UNSUP_HOST
;

1390 
size
 = 
PAGE_SIZE
 * 2;

1391 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_ªq_size
);

1392 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_£g_size
);

1393 
size
 = 
	`mö
(size, 
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 * 512);

1395 i‡(
size
 < 1024)

1396  
RESULT_UNSUP_HOST
;

1398 
	`sg_öô_èbÀ
(&
sg
, 1);

1399 
	`sg_£t_∑ge
(&
sg
, 
ã°
->
highmem
, 
size
, 0);

1401 
ªt
 = 
	`mmc_ã°_å™s„r
(
ã°
, &
sg
, 1, 0, 
size
/512, 512, 0);

1402 i‡(
ªt
)

1403  
ªt
;

1406 
	}
}

1410 
	$mmc_ã°_no_highmem
(
mmc_ã°_ˇrd
 *
ã°
)

1412 
	`¥_öfo
("%s: HighmemÇot configured -Åest skipped\n",

1413 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
));

1415 
	}
}

1422 
	$mmc_ã°_¨ó_m≠
(
mmc_ã°_ˇrd
 *
ã°
, 
sz
,

1423 
max_sˇâî
, 
mö_sg_Àn
)

1425 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1426 
îr
;

1428 
t
->
blocks
 = 
sz
 >> 9;

1430 i‡(
max_sˇâî
) {

1431 
îr
 = 
	`mmc_ã°_m≠_sg_max_sˇâî
(
t
->
mem
, 
sz
,Å->
sg
,

1432 
t
->
max_£gs
,Å->
max_£g_sz
,

1433 &
t
->
sg_Àn
);

1435 
îr
 = 
	`mmc_ã°_m≠_sg
(
t
->
mem
, 
sz
,Å->
sg
, 1,Å->
max_£gs
,

1436 
t
->
max_£g_sz
, &t->
sg_Àn
, 
mö_sg_Àn
);

1438 i‡(
îr
)

1439 
	`¥_öfo
("%s: FailedÅo map sgÜist\n",

1440 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
));

1441  
îr
;

1442 
	}
}

1447 
	$mmc_ã°_¨ó_å™s„r
(
mmc_ã°_ˇrd
 *
ã°
,

1448 
dev_addr
, 
wrôe
)

1450 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1452  
	`mmc_ã°_sim∂e_å™s„r
(
ã°
, 
t
->
sg
,Å->
sg_Àn
, 
dev_addr
,

1453 
t
->
blocks
, 512, 
wrôe
);

1454 
	}
}

1459 
	$mmc_ã°_¨ó_io_£q
(
mmc_ã°_ˇrd
 *
ã°
, 
sz
,

1460 
dev_addr
, 
wrôe
,

1461 
max_sˇâî
, 
timed
, 
cou¡
,

1462 
boﬁ
 
n⁄block
, 
mö_sg_Àn
)

1464 
time•ec
 
ts1
, 
ts2
;

1465 
ªt
 = 0;

1466 
i
;

1467 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1473 i‡(
max_sˇâî
) {

1474 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1475 
max_t‰
;

1477 i‡(
t
->
max_£g_sz
 >
PAGE_SIZE
)

1478 
max_t‰
 = 
t
->
max_£gs
 * 
PAGE_SIZE
;

1480 
max_t‰
 = 
t
->
max_£gs
 *Å->
max_£g_sz
;

1481 i‡(
sz
 > 
max_t‰
)

1482 
sz
 = 
max_t‰
;

1485 
ªt
 = 
	`mmc_ã°_¨ó_m≠
(
ã°
, 
sz
, 
max_sˇâî
, 
mö_sg_Àn
);

1486 i‡(
ªt
)

1487  
ªt
;

1489 i‡(
timed
)

1490 
	`gën°imeofday
(&
ts1
);

1491 i‡(
n⁄block
)

1492 
ªt
 = 
	`mmc_ã°_n⁄block_å™s„r
(
ã°
, 
t
->
sg
,Å->
sg_Àn
,

1493 
dev_addr
, 
t
->
blocks
, 512, 
wrôe
, 
cou¡
);

1495 
i
 = 0; i < 
cou¡
 && 
ªt
 == 0; i++) {

1496 
ªt
 = 
	`mmc_ã°_¨ó_å™s„r
(
ã°
, 
dev_addr
, 
wrôe
);

1497 
dev_addr
 +
sz
 >> 9;

1500 i‡(
ªt
)

1501  
ªt
;

1503 i‡(
timed
)

1504 
	`gën°imeofday
(&
ts2
);

1506 i‡(
timed
)

1507 
	`mmc_ã°_¥öt_avg_øã
(
ã°
, 
sz
, 
cou¡
, &
ts1
, &
ts2
);

1510 
	}
}

1512 
	$mmc_ã°_¨ó_io
(
mmc_ã°_ˇrd
 *
ã°
, 
sz
,

1513 
dev_addr
, 
wrôe
, 
max_sˇâî
,

1514 
timed
)

1516  
	`mmc_ã°_¨ó_io_£q
(
ã°
, 
sz
, 
dev_addr
, 
wrôe
, 
max_sˇâî
,

1517 
timed
, 1, 
Ál£
, 0);

1518 
	}
}

1523 
	$mmc_ã°_¨ó_fûl
(
mmc_ã°_ˇrd
 *
ã°
)

1525 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1527  
	`mmc_ã°_¨ó_io
(
ã°
, 
t
->
max_t‰
,Å->
dev_addr
, 1, 0, 0);

1528 
	}
}

1533 
	$mmc_ã°_¨ó_îa£
(
mmc_ã°_ˇrd
 *
ã°
)

1535 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1537 i‡(!
	`mmc_ˇn_îa£
(
ã°
->
ˇrd
))

1540  
	`mmc_îa£
(
ã°
->
ˇrd
, 
t
->
dev_addr
,Å->
max_sz
 >> 9,

1541 
MMC_ERASE_ARG
);

1542 
	}
}

1547 
	$mmc_ã°_¨ó_˛ónup
(
mmc_ã°_ˇrd
 *
ã°
)

1549 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1551 
	`k‰ì
(
t
->
sg
);

1552 
	`mmc_ã°_‰ì_mem
(
t
->
mem
);

1555 
	}
}

1564 
	$mmc_ã°_¨ó_öô
(
mmc_ã°_ˇrd
 *
ã°
, 
îa£
, 
fûl
)

1566 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1567 
mö_sz
 = 64 * 1024, 
sz
;

1568 
ªt
;

1570 
ªt
 = 
	`mmc_ã°_£t_blksize
(
ã°
, 512);

1571 i‡(
ªt
)

1572  
ªt
;

1575 
sz
 = ()
ã°
->
ˇrd
->
¥ef_îa£
 << 9;

1576 
t
->
max_sz
 = 
sz
;

1577 
t
->
max_sz
 < 4 * 1024 * 1024)

1578 
t
->
max_sz
 +
sz
;

1579 
t
->
max_sz
 > 
TEST_AREA_MAX_SIZE
 &&Å->max_sz > 
sz
)

1580 
t
->
max_sz
 -
sz
;

1582 
t
->
max_£gs
 = 
ã°
->
ˇrd
->
ho°
->max_segs;

1583 
t
->
max_£g_sz
 = 
ã°
->
ˇrd
->
ho°
->
max_£g_size
;

1584 
t
->
max_£g_sz
 -=Å->max_seg_sz % 512;

1586 
t
->
max_t‰
 =Å->
max_sz
;

1587 i‡(
t
->
max_t‰
 >> 9 > 
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
)

1588 
t
->
max_t‰
 = 
ã°
->
ˇrd
->
ho°
->
max_blk_cou¡
 << 9;

1589 i‡(
t
->
max_t‰
 > 
ã°
->
ˇrd
->
ho°
->
max_ªq_size
)

1590 
t
->
max_t‰
 = 
ã°
->
ˇrd
->
ho°
->
max_ªq_size
;

1591 i‡(
t
->
max_t‰
 /Å->
max_£g_sz
 >Å->
max_£gs
)

1592 
t
->
max_t‰
 =Å->
max_£gs
 *Å->
max_£g_sz
;

1600 
t
->
mem
 = 
	`mmc_ã°_Æloc_mem
(
mö_sz
,Å->
max_t‰
,Å->
max_£gs
,

1601 
t
->
max_£g_sz
);

1602 i‡(!
t
->
mem
)

1603  -
ENOMEM
;

1605 
t
->
sg
 = 
	`kmÆloc
((
sˇâîli°
Ë*Å->
max_£gs
, 
GFP_KERNEL
);

1606 i‡(!
t
->
sg
) {

1607 
ªt
 = -
ENOMEM
;

1608 
out_‰ì
;

1611 
t
->
dev_addr
 = 
	`mmc_ã°_ˇ∑côy
(
ã°
->
ˇrd
) / 2;

1612 
t
->
dev_addr
 -t->dev_add∏% (t->
max_sz
 >> 9);

1614 i‡(
îa£
) {

1615 
ªt
 = 
	`mmc_ã°_¨ó_îa£
(
ã°
);

1616 i‡(
ªt
)

1617 
out_‰ì
;

1620 i‡(
fûl
) {

1621 
ªt
 = 
	`mmc_ã°_¨ó_fûl
(
ã°
);

1622 i‡(
ªt
)

1623 
out_‰ì
;

1628 
out_‰ì
:

1629 
	`mmc_ã°_¨ó_˛ónup
(
ã°
);

1630  
ªt
;

1631 
	}
}

1636 
	$mmc_ã°_¨ó_¥ï¨e
(
mmc_ã°_ˇrd
 *
ã°
)

1638  
	`mmc_ã°_¨ó_öô
(
ã°
, 0, 0);

1639 
	}
}

1644 
	$mmc_ã°_¨ó_¥ï¨e_îa£
(
mmc_ã°_ˇrd
 *
ã°
)

1646  
	`mmc_ã°_¨ó_öô
(
ã°
, 1, 0);

1647 
	}
}

1652 
	$mmc_ã°_¨ó_¥ï¨e_fûl
(
mmc_ã°_ˇrd
 *
ã°
)

1654  
	`mmc_ã°_¨ó_öô
(
ã°
, 1, 1);

1655 
	}
}

1665 
	$mmc_ã°_be°_≥rf‹m™˚
(
mmc_ã°_ˇrd
 *
ã°
, 
wrôe
,

1666 
max_sˇâî
)

1668 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1670  
	`mmc_ã°_¨ó_io
(
ã°
, 
t
->
max_t‰
,Å->
dev_addr
, 
wrôe
,

1671 
max_sˇâî
, 1);

1672 
	}
}

1677 
	$mmc_ã°_be°_ªad_≥rf‹m™˚
(
mmc_ã°_ˇrd
 *
ã°
)

1679  
	`mmc_ã°_be°_≥rf‹m™˚
(
ã°
, 0, 0);

1680 
	}
}

1685 
	$mmc_ã°_be°_wrôe_≥rf‹m™˚
(
mmc_ã°_ˇrd
 *
ã°
)

1687  
	`mmc_ã°_be°_≥rf‹m™˚
(
ã°
, 1, 0);

1688 
	}
}

1693 
	$mmc_ã°_be°_ªad_≥rf_max_sˇâî
(
mmc_ã°_ˇrd
 *
ã°
)

1695  
	`mmc_ã°_be°_≥rf‹m™˚
(
ã°
, 0, 1);

1696 
	}
}

1701 
	$mmc_ã°_be°_wrôe_≥rf_max_sˇâî
(
mmc_ã°_ˇrd
 *
ã°
)

1703  
	`mmc_ã°_be°_≥rf‹m™˚
(
ã°
, 1, 1);

1704 
	}
}

1709 
	$mmc_ã°_¥ofûe_ªad_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

1711 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1712 
sz
;

1713 
dev_addr
;

1714 
ªt
;

1716 
sz
 = 512; sz < 
t
->
max_t‰
; sz <<= 1) {

1717 
dev_addr
 = 
t
->dev_add∏+ (
sz
 >> 9);

1718 
ªt
 = 
	`mmc_ã°_¨ó_io
(
ã°
, 
sz
, 
dev_addr
, 0, 0, 1);

1719 i‡(
ªt
)

1720  
ªt
;

1722 
sz
 = 
t
->
max_t‰
;

1723 
dev_addr
 = 
t
->dev_addr;

1724  
	`mmc_ã°_¨ó_io
(
ã°
, 
sz
, 
dev_addr
, 0, 0, 1);

1725 
	}
}

1730 
	$mmc_ã°_¥ofûe_wrôe_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

1732 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1733 
sz
;

1734 
dev_addr
;

1735 
ªt
;

1737 
ªt
 = 
	`mmc_ã°_¨ó_îa£
(
ã°
);

1738 i‡(
ªt
)

1739  
ªt
;

1740 
sz
 = 512; sz < 
t
->
max_t‰
; sz <<= 1) {

1741 
dev_addr
 = 
t
->dev_add∏+ (
sz
 >> 9);

1742 
ªt
 = 
	`mmc_ã°_¨ó_io
(
ã°
, 
sz
, 
dev_addr
, 1, 0, 1);

1743 i‡(
ªt
)

1744  
ªt
;

1746 
ªt
 = 
	`mmc_ã°_¨ó_îa£
(
ã°
);

1747 i‡(
ªt
)

1748  
ªt
;

1749 
sz
 = 
t
->
max_t‰
;

1750 
dev_addr
 = 
t
->dev_addr;

1751  
	`mmc_ã°_¨ó_io
(
ã°
, 
sz
, 
dev_addr
, 1, 0, 1);

1752 
	}
}

1757 
	$mmc_ã°_¥ofûe_åim_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

1759 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1760 
sz
;

1761 
dev_addr
;

1762 
time•ec
 
ts1
, 
ts2
;

1763 
ªt
;

1765 i‡(!
	`mmc_ˇn_åim
(
ã°
->
ˇrd
))

1766  
RESULT_UNSUP_CARD
;

1768 i‡(!
	`mmc_ˇn_îa£
(
ã°
->
ˇrd
))

1769  
RESULT_UNSUP_HOST
;

1771 
sz
 = 512; sz < 
t
->
max_sz
; sz <<= 1) {

1772 
dev_addr
 = 
t
->dev_add∏+ (
sz
 >> 9);

1773 
	`gën°imeofday
(&
ts1
);

1774 
ªt
 = 
	`mmc_îa£
(
ã°
->
ˇrd
, 
dev_addr
, 
sz
 >> 9, 
MMC_TRIM_ARG
);

1775 i‡(
ªt
)

1776  
ªt
;

1777 
	`gën°imeofday
(&
ts2
);

1778 
	`mmc_ã°_¥öt_øã
(
ã°
, 
sz
, &
ts1
, &
ts2
);

1780 
dev_addr
 = 
t
->dev_addr;

1781 
	`gën°imeofday
(&
ts1
);

1782 
ªt
 = 
	`mmc_îa£
(
ã°
->
ˇrd
, 
dev_addr
, 
sz
 >> 9, 
MMC_TRIM_ARG
);

1783 i‡(
ªt
)

1784  
ªt
;

1785 
	`gën°imeofday
(&
ts2
);

1786 
	`mmc_ã°_¥öt_øã
(
ã°
, 
sz
, &
ts1
, &
ts2
);

1788 
	}
}

1790 
	$mmc_ã°_£q_ªad_≥rf
(
mmc_ã°_ˇrd
 *
ã°
, 
sz
)

1792 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1793 
dev_addr
, 
i
, 
˙t
;

1794 
time•ec
 
ts1
, 
ts2
;

1795 
ªt
;

1797 
˙t
 = 
t
->
max_sz
 / 
sz
;

1798 
dev_addr
 = 
t
->dev_addr;

1799 
	`gën°imeofday
(&
ts1
);

1800 
i
 = 0; i < 
˙t
; i++) {

1801 
ªt
 = 
	`mmc_ã°_¨ó_io
(
ã°
, 
sz
, 
dev_addr
, 0, 0, 0);

1802 i‡(
ªt
)

1803  
ªt
;

1804 
dev_addr
 +(
sz
 >> 9);

1806 
	`gën°imeofday
(&
ts2
);

1807 
	`mmc_ã°_¥öt_avg_øã
(
ã°
, 
sz
, 
˙t
, &
ts1
, &
ts2
);

1809 
	}
}

1814 
	$mmc_ã°_¥ofûe_£q_ªad_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

1816 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1817 
sz
;

1818 
ªt
;

1820 
sz
 = 512; sz < 
t
->
max_t‰
; sz <<= 1) {

1821 
ªt
 = 
	`mmc_ã°_£q_ªad_≥rf
(
ã°
, 
sz
);

1822 i‡(
ªt
)

1823  
ªt
;

1825 
sz
 = 
t
->
max_t‰
;

1826  
	`mmc_ã°_£q_ªad_≥rf
(
ã°
, 
sz
);

1827 
	}
}

1829 
	$mmc_ã°_£q_wrôe_≥rf
(
mmc_ã°_ˇrd
 *
ã°
, 
sz
)

1831 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1832 
dev_addr
, 
i
, 
˙t
;

1833 
time•ec
 
ts1
, 
ts2
;

1834 
ªt
;

1836 
ªt
 = 
	`mmc_ã°_¨ó_îa£
(
ã°
);

1837 i‡(
ªt
)

1838  
ªt
;

1839 
˙t
 = 
t
->
max_sz
 / 
sz
;

1840 
dev_addr
 = 
t
->dev_addr;

1841 
	`gën°imeofday
(&
ts1
);

1842 
i
 = 0; i < 
˙t
; i++) {

1843 
ªt
 = 
	`mmc_ã°_¨ó_io
(
ã°
, 
sz
, 
dev_addr
, 1, 0, 0);

1844 i‡(
ªt
)

1845  
ªt
;

1846 
dev_addr
 +(
sz
 >> 9);

1848 
	`gën°imeofday
(&
ts2
);

1849 
	`mmc_ã°_¥öt_avg_øã
(
ã°
, 
sz
, 
˙t
, &
ts1
, &
ts2
);

1851 
	}
}

1856 
	$mmc_ã°_¥ofûe_£q_wrôe_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

1858 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1859 
sz
;

1860 
ªt
;

1862 
sz
 = 512; sz < 
t
->
max_t‰
; sz <<= 1) {

1863 
ªt
 = 
	`mmc_ã°_£q_wrôe_≥rf
(
ã°
, 
sz
);

1864 i‡(
ªt
)

1865  
ªt
;

1867 
sz
 = 
t
->
max_t‰
;

1868  
	`mmc_ã°_£q_wrôe_≥rf
(
ã°
, 
sz
);

1869 
	}
}

1874 
	$mmc_ã°_¥ofûe_£q_åim_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

1876 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1877 
sz
;

1878 
dev_addr
, 
i
, 
˙t
;

1879 
time•ec
 
ts1
, 
ts2
;

1880 
ªt
;

1882 i‡(!
	`mmc_ˇn_åim
(
ã°
->
ˇrd
))

1883  
RESULT_UNSUP_CARD
;

1885 i‡(!
	`mmc_ˇn_îa£
(
ã°
->
ˇrd
))

1886  
RESULT_UNSUP_HOST
;

1888 
sz
 = 512; sz <
t
->
max_sz
; sz <<= 1) {

1889 
ªt
 = 
	`mmc_ã°_¨ó_îa£
(
ã°
);

1890 i‡(
ªt
)

1891  
ªt
;

1892 
ªt
 = 
	`mmc_ã°_¨ó_fûl
(
ã°
);

1893 i‡(
ªt
)

1894  
ªt
;

1895 
˙t
 = 
t
->
max_sz
 / 
sz
;

1896 
dev_addr
 = 
t
->dev_addr;

1897 
	`gën°imeofday
(&
ts1
);

1898 
i
 = 0; i < 
˙t
; i++) {

1899 
ªt
 = 
	`mmc_îa£
(
ã°
->
ˇrd
, 
dev_addr
, 
sz
 >> 9,

1900 
MMC_TRIM_ARG
);

1901 i‡(
ªt
)

1902  
ªt
;

1903 
dev_addr
 +(
sz
 >> 9);

1905 
	`gën°imeofday
(&
ts2
);

1906 
	`mmc_ã°_¥öt_avg_øã
(
ã°
, 
sz
, 
˙t
, &
ts1
, &
ts2
);

1909 
	}
}

1911 
	g∫d_√xt
 = 1;

1913 
	$mmc_ã°_∫d_num
(
∫d_˙t
)

1915 
uöt64_t
 
r
;

1917 
∫d_√xt
 =Ñnd_next * 1103515245 + 12345;

1918 
r
 = (
∫d_√xt
 >> 16) & 0x7fff;

1919  (
r
 * 
∫d_˙t
) >> 15;

1920 
	}
}

1922 
	$mmc_ã°_∫d_≥rf
(
mmc_ã°_ˇrd
 *
ã°
, 
wrôe
, 
¥öt
,

1923 
sz
)

1925 
dev_addr
, 
˙t
, 
∫d_addr
, 
ønge1
, 
ønge2
, 
œ°_ó
 = 0, 
ó
;

1926 
ssz
;

1927 
time•ec
 
ts1
, 
ts2
, 
ts
;

1928 
ªt
;

1930 
ssz
 = 
sz
 >> 9;

1932 
∫d_addr
 = 
	`mmc_ã°_ˇ∑côy
(
ã°
->
ˇrd
) / 4;

1933 
ønge1
 = 
∫d_addr
 / 
ã°
->
ˇrd
->
¥ef_îa£
;

1934 
ønge2
 = 
ønge1
 / 
ssz
;

1936 
	`gën°imeofday
(&
ts1
);

1937 
˙t
 = 0; c¡ < 
UINT_MAX
; cnt++) {

1938 
	`gën°imeofday
(&
ts2
);

1939 
ts
 = 
	`time•ec_sub
(
ts2
, 
ts1
);

1940 i‡(
ts
.
tv_£c
 >= 10)

1942 
ó
 = 
	`mmc_ã°_∫d_num
(
ønge1
);

1943 i‡(
ó
 =
œ°_ó
)

1944 
ó
 -= 1;

1945 
œ°_ó
 = 
ó
;

1946 
dev_addr
 = 
∫d_addr
 + 
ã°
->
ˇrd
->
¥ef_îa£
 * 
ó
 +

1947 
ssz
 * 
	`mmc_ã°_∫d_num
(
ønge2
);

1948 
ªt
 = 
	`mmc_ã°_¨ó_io
(
ã°
, 
sz
, 
dev_addr
, 
wrôe
, 0, 0);

1949 i‡(
ªt
)

1950  
ªt
;

1952 i‡(
¥öt
)

1953 
	`mmc_ã°_¥öt_avg_øã
(
ã°
, 
sz
, 
˙t
, &
ts1
, &
ts2
);

1955 
	}
}

1957 
	$mmc_ã°_øndom_≥rf
(
mmc_ã°_ˇrd
 *
ã°
, 
wrôe
)

1959 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

1960 
√xt
;

1961 
sz
;

1962 
ªt
;

1964 
sz
 = 512; sz < 
t
->
max_t‰
; sz <<= 1) {

1970 i‡(
wrôe
) {

1971 
√xt
 = 
∫d_√xt
;

1972 
ªt
 = 
	`mmc_ã°_∫d_≥rf
(
ã°
, 
wrôe
, 0, 
sz
);

1973 i‡(
ªt
)

1974  
ªt
;

1975 
∫d_√xt
 = 
√xt
;

1977 
ªt
 = 
	`mmc_ã°_∫d_≥rf
(
ã°
, 
wrôe
, 1, 
sz
);

1978 i‡(
ªt
)

1979  
ªt
;

1981 
sz
 = 
t
->
max_t‰
;

1982 i‡(
wrôe
) {

1983 
√xt
 = 
∫d_√xt
;

1984 
ªt
 = 
	`mmc_ã°_∫d_≥rf
(
ã°
, 
wrôe
, 0, 
sz
);

1985 i‡(
ªt
)

1986  
ªt
;

1987 
∫d_√xt
 = 
√xt
;

1989  
	`mmc_ã°_∫d_≥rf
(
ã°
, 
wrôe
, 1, 
sz
);

1990 
	}
}

1995 
	$mmc_ã°_øndom_ªad_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

1997  
	`mmc_ã°_øndom_≥rf
(
ã°
, 0);

1998 
	}
}

2003 
	$mmc_ã°_øndom_wrôe_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2005  
	`mmc_ã°_øndom_≥rf
(
ã°
, 1);

2006 
	}
}

2008 
	$mmc_ã°_£q_≥rf
(
mmc_ã°_ˇrd
 *
ã°
, 
wrôe
,

2009 
tŸ_sz
, 
max_sˇâî
)

2011 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

2012 
dev_addr
, 
i
, 
˙t
, 
sz
, 
ssz
;

2013 
time•ec
 
ts1
, 
ts2
;

2014 
ªt
;

2016 
sz
 = 
t
->
max_t‰
;

2022 i‡(
max_sˇâî
) {

2023 
max_t‰
;

2025 i‡(
t
->
max_£g_sz
 >
PAGE_SIZE
)

2026 
max_t‰
 = 
t
->
max_£gs
 * 
PAGE_SIZE
;

2028 
max_t‰
 = 
t
->
max_£gs
 *Å->
max_£g_sz
;

2029 i‡(
sz
 > 
max_t‰
)

2030 
sz
 = 
max_t‰
;

2033 
ssz
 = 
sz
 >> 9;

2034 
dev_addr
 = 
	`mmc_ã°_ˇ∑côy
(
ã°
->
ˇrd
) / 4;

2035 i‡(
tŸ_sz
 > 
dev_addr
 << 9)

2036 
tŸ_sz
 = 
dev_addr
 << 9;

2037 
˙t
 = 
tŸ_sz
 / 
sz
;

2038 
dev_addr
 &= 0xffff0000;

2040 
	`gën°imeofday
(&
ts1
);

2041 
i
 = 0; i < 
˙t
; i++) {

2042 
ªt
 = 
	`mmc_ã°_¨ó_io
(
ã°
, 
sz
, 
dev_addr
, 
wrôe
,

2043 
max_sˇâî
, 0);

2044 i‡(
ªt
)

2045  
ªt
;

2046 
dev_addr
 +
ssz
;

2048 
	`gën°imeofday
(&
ts2
);

2050 
	`mmc_ã°_¥öt_avg_øã
(
ã°
, 
sz
, 
˙t
, &
ts1
, &
ts2
);

2053 
	}
}

2055 
	$mmc_ã°_œrge_£q_≥rf
(
mmc_ã°_ˇrd
 *
ã°
, 
wrôe
)

2057 
ªt
, 
i
;

2059 
i
 = 0; i < 10; i++) {

2060 
ªt
 = 
	`mmc_ã°_£q_≥rf
(
ã°
, 
wrôe
, 10 * 1024 * 1024, 1);

2061 i‡(
ªt
)

2062  
ªt
;

2064 
i
 = 0; i < 5; i++) {

2065 
ªt
 = 
	`mmc_ã°_£q_≥rf
(
ã°
, 
wrôe
, 100 * 1024 * 1024, 1);

2066 i‡(
ªt
)

2067  
ªt
;

2069 
i
 = 0; i < 3; i++) {

2070 
ªt
 = 
	`mmc_ã°_£q_≥rf
(
ã°
, 
wrôe
, 1000 * 1024 * 1024, 1);

2071 i‡(
ªt
)

2072  
ªt
;

2075  
ªt
;

2076 
	}
}

2081 
	$mmc_ã°_œrge_£q_ªad_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2083  
	`mmc_ã°_œrge_£q_≥rf
(
ã°
, 0);

2084 
	}
}

2089 
	$mmc_ã°_œrge_£q_wrôe_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2091  
	`mmc_ã°_œrge_£q_≥rf
(
ã°
, 1);

2092 
	}
}

2094 
	$mmc_ã°_rw_mu…ùÀ
(
mmc_ã°_ˇrd
 *
ã°
,

2095 
mmc_ã°_mu…ùÀ_rw
 *
td©a
,

2096 
ªqsize
, 
size
,

2097 
mö_sg_Àn
)

2099 
dev_addr
;

2100 
mmc_ã°_¨ó
 *
t
 = &
ã°
->
¨ó
;

2101 
ªt
 = 0;

2104 i‡(
size
 > 
	`mmc_ã°_ˇ∑côy
(
ã°
->
ˇrd
) / 2 * 512)

2105 
size
 = 
	`mmc_ã°_ˇ∑côy
(
ã°
->
ˇrd
) / 2 * 512;

2106 i‡(
ªqsize
 > 
t
->
max_t‰
)

2107 
ªqsize
 = 
t
->
max_t‰
;

2108 
dev_addr
 = 
	`mmc_ã°_ˇ∑côy
(
ã°
->
ˇrd
) / 4;

2109 i‡((
dev_addr
 & 0xffff0000))

2110 
dev_addr
 &= 0xffff0000;

2112 
dev_addr
 &= 0xfffff800;

2113 i‡(!
dev_addr
)

2114 
îr
;

2116 i‡(
ªqsize
 > 
size
)

2120 i‡(
	`mmc_ˇn_îa£
(
ã°
->
ˇrd
) &&

2121 
td©a
->
¥ï¨e
 & 
MMC_TEST_PREP_ERASE
) {

2122 
ªt
 = 
	`mmc_îa£
(
ã°
->
ˇrd
, 
dev_addr
,

2123 
size
 / 512, 
MMC_SECURE_ERASE_ARG
);

2124 i‡(
ªt
)

2125 
ªt
 = 
	`mmc_îa£
(
ã°
->
ˇrd
, 
dev_addr
,

2126 
size
 / 512, 
MMC_ERASE_ARG
);

2127 i‡(
ªt
)

2128 
îr
;

2132 
ªt
 = 
	`mmc_ã°_¨ó_io_£q
(
ã°
, 
ªqsize
, 
dev_addr
,

2133 
td©a
->
do_wrôe
, 0, 1, 
size
 / 
ªqsize
,

2134 
td©a
->
do_n⁄block_ªq
, 
mö_sg_Àn
);

2135 i‡(
ªt
)

2136 
îr
;

2138  
ªt
;

2139 
îr
:

2140 
	`¥_öfo
("[%s]Éº‹\n", 
__func__
);

2141  
ªt
;

2142 
	}
}

2144 
	$mmc_ã°_rw_mu…ùÀ_size
(
mmc_ã°_ˇrd
 *
ã°
,

2145 
mmc_ã°_mu…ùÀ_rw
 *
rw
)

2147 
ªt
 = 0;

2148 
i
;

2149 *
¥e_ªq
 = 
ã°
->
ˇrd
->
ho°
->
›s
->pre_req;

2150 *
po°_ªq
 = 
ã°
->
ˇrd
->
ho°
->
›s
->post_req;

2152 i‡(
rw
->
do_n⁄block_ªq
 &&

2153 ((!
¥e_ªq
 && 
po°_ªq
) || (pre_req && !post_req))) {

2154 
	`¥_öfo
("error: only one ofÖre/post is defined\n");

2155  -
EINVAL
;

2158 
i
 = 0 ; i < 
rw
->
Àn
 && 
ªt
 == 0; i++) {

2159 
ªt
 = 
	`mmc_ã°_rw_mu…ùÀ
(
ã°
, 
rw
,Ñw->
bs
[
i
],Ñw->
size
, 0);

2160 i‡(
ªt
)

2163  
ªt
;

2164 
	}
}

2166 
	$mmc_ã°_rw_mu…ùÀ_sg_Àn
(
mmc_ã°_ˇrd
 *
ã°
,

2167 
mmc_ã°_mu…ùÀ_rw
 *
rw
)

2169 
ªt
 = 0;

2170 
i
;

2172 
i
 = 0 ; i < 
rw
->
Àn
 && 
ªt
 == 0; i++) {

2173 
ªt
 = 
	`mmc_ã°_rw_mu…ùÀ
(
ã°
, 
rw
, 512*1024,Ñw->
size
,

2174 
rw
->
sg_Àn
[
i
]);

2175 i‡(
ªt
)

2178  
ªt
;

2179 
	}
}

2184 
	$mmc_ã°_¥ofûe_mu…_wrôe_blockög_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2186 
bs
[] = {1 << 12, 1 << 13, 1 << 14, 1 << 15, 1 << 16,

2188 
mmc_ã°_mu…ùÀ_rw
 
ã°_d©a
 = {

2189 .
bs
 = bs,

2190 .
size
 = 
TEST_AREA_MAX_SIZE
,

2191 .
Àn
 = 
	`ARRAY_SIZE
(
bs
),

2192 .
do_wrôe
 = 
åue
,

2193 .
do_n⁄block_ªq
 = 
Ál£
,

2194 .
¥ï¨e
 = 
MMC_TEST_PREP_ERASE
,

2197  
	`mmc_ã°_rw_mu…ùÀ_size
(
ã°
, &
ã°_d©a
);

2198 
	}
};

2203 
	$mmc_ã°_¥ofûe_mu…_wrôe_n⁄block_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2205 
bs
[] = {1 << 12, 1 << 13, 1 << 14, 1 << 15, 1 << 16,

2207 
mmc_ã°_mu…ùÀ_rw
 
ã°_d©a
 = {

2208 .
bs
 = bs,

2209 .
size
 = 
TEST_AREA_MAX_SIZE
,

2210 .
Àn
 = 
	`ARRAY_SIZE
(
bs
),

2211 .
do_wrôe
 = 
åue
,

2212 .
do_n⁄block_ªq
 = 
åue
,

2213 .
¥ï¨e
 = 
MMC_TEST_PREP_ERASE
,

2216  
	`mmc_ã°_rw_mu…ùÀ_size
(
ã°
, &
ã°_d©a
);

2217 
	}
}

2222 
	$mmc_ã°_¥ofûe_mu…_ªad_blockög_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2224 
bs
[] = {1 << 12, 1 << 13, 1 << 14, 1 << 15, 1 << 16,

2226 
mmc_ã°_mu…ùÀ_rw
 
ã°_d©a
 = {

2227 .
bs
 = bs,

2228 .
size
 = 
TEST_AREA_MAX_SIZE
,

2229 .
Àn
 = 
	`ARRAY_SIZE
(
bs
),

2230 .
do_wrôe
 = 
Ál£
,

2231 .
do_n⁄block_ªq
 = 
Ál£
,

2232 .
¥ï¨e
 = 
MMC_TEST_PREP_NONE
,

2235  
	`mmc_ã°_rw_mu…ùÀ_size
(
ã°
, &
ã°_d©a
);

2236 
	}
}

2241 
	$mmc_ã°_¥ofûe_mu…_ªad_n⁄block_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2243 
bs
[] = {1 << 12, 1 << 13, 1 << 14, 1 << 15, 1 << 16,

2245 
mmc_ã°_mu…ùÀ_rw
 
ã°_d©a
 = {

2246 .
bs
 = bs,

2247 .
size
 = 
TEST_AREA_MAX_SIZE
,

2248 .
Àn
 = 
	`ARRAY_SIZE
(
bs
),

2249 .
do_wrôe
 = 
Ál£
,

2250 .
do_n⁄block_ªq
 = 
åue
,

2251 .
¥ï¨e
 = 
MMC_TEST_PREP_NONE
,

2254  
	`mmc_ã°_rw_mu…ùÀ_size
(
ã°
, &
ã°_d©a
);

2255 
	}
}

2260 
	$mmc_ã°_¥ofûe_sgÀn_wr_blockög_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2262 
sg_Àn
[] = {1, 1 << 3, 1 << 4, 1 << 5, 1 << 6,

2264 
mmc_ã°_mu…ùÀ_rw
 
ã°_d©a
 = {

2265 .
sg_Àn
 = sg_len,

2266 .
size
 = 
TEST_AREA_MAX_SIZE
,

2267 .
Àn
 = 
	`ARRAY_SIZE
(
sg_Àn
),

2268 .
do_wrôe
 = 
åue
,

2269 .
do_n⁄block_ªq
 = 
Ál£
,

2270 .
¥ï¨e
 = 
MMC_TEST_PREP_ERASE
,

2273  
	`mmc_ã°_rw_mu…ùÀ_sg_Àn
(
ã°
, &
ã°_d©a
);

2274 
	}
};

2279 
	$mmc_ã°_¥ofûe_sgÀn_wr_n⁄block_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2281 
sg_Àn
[] = {1, 1 << 3, 1 << 4, 1 << 5, 1 << 6,

2283 
mmc_ã°_mu…ùÀ_rw
 
ã°_d©a
 = {

2284 .
sg_Àn
 = sg_len,

2285 .
size
 = 
TEST_AREA_MAX_SIZE
,

2286 .
Àn
 = 
	`ARRAY_SIZE
(
sg_Àn
),

2287 .
do_wrôe
 = 
åue
,

2288 .
do_n⁄block_ªq
 = 
åue
,

2289 .
¥ï¨e
 = 
MMC_TEST_PREP_ERASE
,

2292  
	`mmc_ã°_rw_mu…ùÀ_sg_Àn
(
ã°
, &
ã°_d©a
);

2293 
	}
}

2298 
	$mmc_ã°_¥ofûe_sgÀn_r_blockög_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2300 
sg_Àn
[] = {1, 1 << 3, 1 << 4, 1 << 5, 1 << 6,

2302 
mmc_ã°_mu…ùÀ_rw
 
ã°_d©a
 = {

2303 .
sg_Àn
 = sg_len,

2304 .
size
 = 
TEST_AREA_MAX_SIZE
,

2305 .
Àn
 = 
	`ARRAY_SIZE
(
sg_Àn
),

2306 .
do_wrôe
 = 
Ál£
,

2307 .
do_n⁄block_ªq
 = 
Ál£
,

2308 .
¥ï¨e
 = 
MMC_TEST_PREP_NONE
,

2311  
	`mmc_ã°_rw_mu…ùÀ_sg_Àn
(
ã°
, &
ã°_d©a
);

2312 
	}
}

2317 
	$mmc_ã°_¥ofûe_sgÀn_r_n⁄block_≥rf
(
mmc_ã°_ˇrd
 *
ã°
)

2319 
sg_Àn
[] = {1, 1 << 3, 1 << 4, 1 << 5, 1 << 6,

2321 
mmc_ã°_mu…ùÀ_rw
 
ã°_d©a
 = {

2322 .
sg_Àn
 = sg_len,

2323 .
size
 = 
TEST_AREA_MAX_SIZE
,

2324 .
Àn
 = 
	`ARRAY_SIZE
(
sg_Àn
),

2325 .
do_wrôe
 = 
Ál£
,

2326 .
do_n⁄block_ªq
 = 
åue
,

2327 .
¥ï¨e
 = 
MMC_TEST_PREP_NONE
,

2330  
	`mmc_ã°_rw_mu…ùÀ_sg_Àn
(
ã°
, &
ã°_d©a
);

2331 
	}
}

2336 
	$mmc_ã°_hw_ª£t
(
mmc_ã°_ˇrd
 *
ã°
)

2338 
mmc_ˇrd
 *
ˇrd
 = 
ã°
->card;

2339 
mmc_ho°
 *
ho°
 = 
ˇrd
->host;

2340 
îr
;

2342 
îr
 = 
	`mmc_hw_ª£t_check
(
ho°
);

2343 i‡(!
îr
)

2344  
RESULT_OK
;

2346 i‡(
îr
 =-
ENOSYS
)

2347  
RESULT_FAIL
;

2349 i‡(
îr
 !-
EOPNOTSUPP
)

2350  
îr
;

2352 i‡(!
	`mmc_ˇn_ª£t
(
ˇrd
))

2353  
RESULT_UNSUP_CARD
;

2355  
RESULT_UNSUP_HOST
;

2356 
	}
}

2358 c⁄° 
mmc_ã°_ˇ£
 
	gmmc_ã°_ˇ£s
[] = {

2360 .
«me
 = "Basic write (no data verification)",

2361 .
	grun
 = 
mmc_ã°_basic_wrôe
,

2365 .
	g«me
 = "BasicÑead (no data verification)",

2366 .
	grun
 = 
mmc_ã°_basic_ªad
,

2370 .
	g«me
 = "Basic write (with data verification)",

2371 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_wrôe
,

2372 .
	grun
 = 
mmc_ã°_vîify_wrôe
,

2373 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2377 .
	g«me
 = "BasicÑead (with data verification)",

2378 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_ªad
,

2379 .
	grun
 = 
mmc_ã°_vîify_ªad
,

2380 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2384 .
	g«me
 = "Multi-block write",

2385 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_wrôe
,

2386 .
	grun
 = 
mmc_ã°_mu…i_wrôe
,

2387 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2391 .
	g«me
 = "Multi-blockÑead",

2392 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_ªad
,

2393 .
	grun
 = 
mmc_ã°_mu…i_ªad
,

2394 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2398 .
	g«me
 = "Power ofÅwo block writes",

2399 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_wrôe
,

2400 .
	grun
 = 
mmc_ã°_pow2_wrôe
,

2401 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2405 .
	g«me
 = "Power ofÅwo blockÑeads",

2406 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_ªad
,

2407 .
	grun
 = 
mmc_ã°_pow2_ªad
,

2408 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2412 .
	g«me
 = "Weird sized block writes",

2413 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_wrôe
,

2414 .
	grun
 = 
mmc_ã°_weúd_wrôe
,

2415 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2419 .
	g«me
 = "Weird sized blockÑeads",

2420 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_ªad
,

2421 .
	grun
 = 
mmc_ã°_weúd_ªad
,

2422 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2426 .
	g«me
 = "Badlyáligned write",

2427 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_wrôe
,

2428 .
	grun
 = 
mmc_ã°_Æign_wrôe
,

2429 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2433 .
	g«me
 = "BadlyálignedÑead",

2434 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_ªad
,

2435 .
	grun
 = 
mmc_ã°_Æign_ªad
,

2436 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2440 .
	g«me
 = "Badlyáligned multi-block write",

2441 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_wrôe
,

2442 .
	grun
 = 
mmc_ã°_Æign_mu…i_wrôe
,

2443 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2447 .
	g«me
 = "Badlyáligned multi-blockÑead",

2448 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_ªad
,

2449 .
	grun
 = 
mmc_ã°_Æign_mu…i_ªad
,

2450 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2454 .
	g«me
 = "Correct xfer_sizeát write (start failure)",

2455 .
	grun
 = 
mmc_ã°_x„rsize_wrôe
,

2459 .
	g«me
 = "Correct xfer_sizeátÑead (start failure)",

2460 .
	grun
 = 
mmc_ã°_x„rsize_ªad
,

2464 .
	g«me
 = "Correct xfer_sizeát write (midway failure)",

2465 .
	grun
 = 
mmc_ã°_mu…i_x„rsize_wrôe
,

2469 .
	g«me
 = "Correct xfer_sizeátÑead (midway failure)",

2470 .
	grun
 = 
mmc_ã°_mu…i_x„rsize_ªad
,

2473 #ifde‡
CONFIG_HIGHMEM


2476 .
	g«me
 = "Highmem write",

2477 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_wrôe
,

2478 .
	grun
 = 
mmc_ã°_wrôe_high
,

2479 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2483 .
	g«me
 = "HighmemÑead",

2484 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_ªad
,

2485 .
	grun
 = 
mmc_ã°_ªad_high
,

2486 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2490 .
	g«me
 = "Multi-block highmem write",

2491 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_wrôe
,

2492 .
	grun
 = 
mmc_ã°_mu…i_wrôe_high
,

2493 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2497 .
	g«me
 = "Multi-block highmemÑead",

2498 .
	g¥ï¨e
 = 
mmc_ã°_¥ï¨e_ªad
,

2499 .
	grun
 = 
mmc_ã°_mu…i_ªad_high
,

2500 .
	g˛ónup
 = 
mmc_ã°_˛ónup
,

2506 .
	g«me
 = "Highmem write",

2507 .
	grun
 = 
mmc_ã°_no_highmem
,

2511 .
	g«me
 = "HighmemÑead",

2512 .
	grun
 = 
mmc_ã°_no_highmem
,

2516 .
	g«me
 = "Multi-block highmem write",

2517 .
	grun
 = 
mmc_ã°_no_highmem
,

2521 .
	g«me
 = "Multi-block highmemÑead",

2522 .
	grun
 = 
mmc_ã°_no_highmem
,

2528 .
	g«me
 = "Best-caseÑeadÖerformance",

2529 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e_fûl
,

2530 .
	grun
 = 
mmc_ã°_be°_ªad_≥rf‹m™˚
,

2531 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2535 .
	g«me
 = "Best-case writeÖerformance",

2536 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e_îa£
,

2537 .
	grun
 = 
mmc_ã°_be°_wrôe_≥rf‹m™˚
,

2538 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2542 .
	g«me
 = "Best-caseÑeadÖerformance into scatteredÖages",

2543 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e_fûl
,

2544 .
	grun
 = 
mmc_ã°_be°_ªad_≥rf_max_sˇâî
,

2545 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2549 .
	g«me
 = "Best-case writeÖerformance from scatteredÖages",

2550 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e_îa£
,

2551 .
	grun
 = 
mmc_ã°_be°_wrôe_≥rf_max_sˇâî
,

2552 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2556 .
	g«me
 = "SingleÑeadÖerformance byÅransfer size",

2557 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e_fûl
,

2558 .
	grun
 = 
mmc_ã°_¥ofûe_ªad_≥rf
,

2559 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2563 .
	g«me
 = "Single writeÖerformance byÅransfer size",

2564 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2565 .
	grun
 = 
mmc_ã°_¥ofûe_wrôe_≥rf
,

2566 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2570 .
	g«me
 = "SingleÅrimÖerformance byÅransfer size",

2571 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e_fûl
,

2572 .
	grun
 = 
mmc_ã°_¥ofûe_åim_≥rf
,

2573 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2577 .
	g«me
 = "ConsecutiveÑeadÖerformance byÅransfer size",

2578 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e_fûl
,

2579 .
	grun
 = 
mmc_ã°_¥ofûe_£q_ªad_≥rf
,

2580 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2584 .
	g«me
 = "Consecutive writeÖerformance byÅransfer size",

2585 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2586 .
	grun
 = 
mmc_ã°_¥ofûe_£q_wrôe_≥rf
,

2587 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2591 .
	g«me
 = "ConsecutiveÅrimÖerformance byÅransfer size",

2592 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2593 .
	grun
 = 
mmc_ã°_¥ofûe_£q_åim_≥rf
,

2594 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2598 .
	g«me
 = "RandomÑeadÖerformance byÅransfer size",

2599 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2600 .
	grun
 = 
mmc_ã°_øndom_ªad_≥rf
,

2601 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2605 .
	g«me
 = "Random writeÖerformance byÅransfer size",

2606 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2607 .
	grun
 = 
mmc_ã°_øndom_wrôe_≥rf
,

2608 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2612 .
	g«me
 = "Large sequentialÑead into scatteredÖages",

2613 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2614 .
	grun
 = 
mmc_ã°_œrge_£q_ªad_≥rf
,

2615 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2619 .
	g«me
 = "Large sequential write from scatteredÖages",

2620 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2621 .
	grun
 = 
mmc_ã°_œrge_£q_wrôe_≥rf
,

2622 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2626 .
	g«me
 = "WriteÖerformance with blockingÑeq 4kÅo 4MB",

2627 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2628 .
	grun
 = 
mmc_ã°_¥ofûe_mu…_wrôe_blockög_≥rf
,

2629 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2633 .
	g«me
 = "WriteÖerformance withÇon-blockingÑeq 4kÅo 4MB",

2634 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2635 .
	grun
 = 
mmc_ã°_¥ofûe_mu…_wrôe_n⁄block_≥rf
,

2636 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2640 .
	g«me
 = "ReadÖerformance with blockingÑeq 4kÅo 4MB",

2641 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2642 .
	grun
 = 
mmc_ã°_¥ofûe_mu…_ªad_blockög_≥rf
,

2643 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2647 .
	g«me
 = "ReadÖerformance withÇon-blockingÑeq 4kÅo 4MB",

2648 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2649 .
	grun
 = 
mmc_ã°_¥ofûe_mu…_ªad_n⁄block_≥rf
,

2650 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2654 .
	g«me
 = "WriteÖerformance blockingÑeq 1Åo 512 sgÉlems",

2655 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2656 .
	grun
 = 
mmc_ã°_¥ofûe_sgÀn_wr_blockög_≥rf
,

2657 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2661 .
	g«me
 = "WriteÖerformanceÇon-blockingÑeq 1Åo 512 sgÉlems",

2662 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2663 .
	grun
 = 
mmc_ã°_¥ofûe_sgÀn_wr_n⁄block_≥rf
,

2664 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2668 .
	g«me
 = "ReadÖerformance blockingÑeq 1Åo 512 sgÉlems",

2669 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2670 .
	grun
 = 
mmc_ã°_¥ofûe_sgÀn_r_blockög_≥rf
,

2671 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2675 .
	g«me
 = "ReadÖerformanceÇon-blockingÑeq 1Åo 512 sgÉlems",

2676 .
	g¥ï¨e
 = 
mmc_ã°_¨ó_¥ï¨e
,

2677 .
	grun
 = 
mmc_ã°_¥ofûe_sgÀn_r_n⁄block_≥rf
,

2678 .
	g˛ónup
 = 
mmc_ã°_¨ó_˛ónup
,

2682 .
	g«me
 = "eMMC hardwareÑeset",

2683 .
	grun
 = 
mmc_ã°_hw_ª£t
,

2687 
DEFINE_MUTEX
(
mmc_ã°_lock
);

2689 
LIST_HEAD
(
mmc_ã°_ªsu…
);

2691 
	$mmc_ã°_run
(
mmc_ã°_ˇrd
 *
ã°
, 
ã°ˇ£
)

2693 
i
, 
ªt
;

2695 
	`¥_öfo
("%s: StartingÅests of card %s...\n",

2696 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
), 
	`mmc_ˇrd_id
(test->card));

2698 
	`mmc_˛aim_ho°
(
ã°
->
ˇrd
->
ho°
);

2700 
i
 = 0;ò< 
	`ARRAY_SIZE
(
mmc_ã°_ˇ£s
);i++) {

2701 
mmc_ã°_gíîÆ_ªsu…
 *
gr
;

2703 i‡(
ã°ˇ£
 && ((
i
 + 1) !=Åestcase))

2706 
	`¥_öfo
("%s: Test case %d. %s...\n",

2707 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
), 
i
 + 1,

2708 
mmc_ã°_ˇ£s
[
i
].
«me
);

2710 i‡(
mmc_ã°_ˇ£s
[
i
].
¥ï¨e
) {

2711 
ªt
 = 
mmc_ã°_ˇ£s
[
i
].
	`¥ï¨e
(
ã°
);

2712 i‡(
ªt
) {

2713 
	`¥_öfo
("%s: Result: Prepare "

2715 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
),

2716 
ªt
);

2721 
gr
 = 
	`kzÆloc
((
mmc_ã°_gíîÆ_ªsu…
),

2722 
GFP_KERNEL
);

2723 i‡(
gr
) {

2724 
	`INIT_LIST_HEAD
(&
gr
->
å_l°
);

2727 
gr
->
ˇrd
 = 
ã°
->card;

2728 
gr
->
ã°ˇ£
 = 
i
;

2731 
	`li°_add_èû
(&
gr
->
lök
, &
mmc_ã°_ªsu…
);

2737 
ã°
->
gr
 = gr;

2740 
ªt
 = 
mmc_ã°_ˇ£s
[
i
].
	`run
(
ã°
);

2741 
ªt
) {

2742 
RESULT_OK
:

2743 
	`¥_öfo
("%s: Result: OK\n",

2744 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
));

2746 
RESULT_FAIL
:

2747 
	`¥_öfo
("%s: Result: FAILED\n",

2748 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
));

2750 
RESULT_UNSUP_HOST
:

2751 
	`¥_öfo
("%s: Result: UNSUPPORTED "

2753 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
));

2755 
RESULT_UNSUP_CARD
:

2756 
	`¥_öfo
("%s: Result: UNSUPPORTED "

2758 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
));

2761 
	`¥_öfo
("%s: Result: ERROR (%d)\n",

2762 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
), 
ªt
);

2766 i‡(
gr
)

2767 
gr
->
ªsu…
 = 
ªt
;

2769 i‡(
mmc_ã°_ˇ£s
[
i
].
˛ónup
) {

2770 
ªt
 = 
mmc_ã°_ˇ£s
[
i
].
	`˛ónup
(
ã°
);

2771 i‡(
ªt
) {

2772 
	`¥_öfo
("%s: Warning: Cleanup "

2774 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
),

2775 
ªt
);

2780 
	`mmc_ªÀa£_ho°
(
ã°
->
ˇrd
->
ho°
);

2782 
	`¥_öfo
("%s: Tests completed.\n",

2783 
	`mmc_ho°«me
(
ã°
->
ˇrd
->
ho°
));

2784 
	}
}

2786 
	$mmc_ã°_‰ì_ªsu…
(
mmc_ˇrd
 *
ˇrd
)

2788 
mmc_ã°_gíîÆ_ªsu…
 *
gr
, *
grs
;

2790 
	`muãx_lock
(&
mmc_ã°_lock
);

2792 
	`li°_f‹_óch_íåy_ß„
(
gr
, 
grs
, &
mmc_ã°_ªsu…
, 
lök
) {

2793 
mmc_ã°_å™s„r_ªsu…
 *
å
, *
ås
;

2795 i‡(
ˇrd
 && 
gr
->card != card)

2798 
	`li°_f‹_óch_íåy_ß„
(
å
, 
ås
, &
gr
->
å_l°
, 
lök
) {

2799 
	`li°_dñ
(&
å
->
lök
);

2800 
	`k‰ì
(
å
);

2803 
	`li°_dñ
(&
gr
->
lök
);

2804 
	`k‰ì
(
gr
);

2807 
	`muãx_u∆ock
(&
mmc_ã°_lock
);

2808 
	}
}

2810 
LIST_HEAD
(
mmc_ã°_fûe_ã°
);

2812 
	$mtf_ã°_show
(
£q_fûe
 *
sf
, *
d©a
)

2814 
mmc_ˇrd
 *
ˇrd
 = (mmc_ˇrd *)
sf
->
¥iv©e
;

2815 
mmc_ã°_gíîÆ_ªsu…
 *
gr
;

2817 
	`muãx_lock
(&
mmc_ã°_lock
);

2819 
	`li°_f‹_óch_íåy
(
gr
, &
mmc_ã°_ªsu…
, 
lök
) {

2820 
mmc_ã°_å™s„r_ªsu…
 *
å
;

2822 i‡(
gr
->
ˇrd
 != card)

2825 
	`£q_¥ötf
(
sf
, "Te° %d: %d\n", 
gr
->
ã°ˇ£
 + 1, gr->
ªsu…
);

2827 
	`li°_f‹_óch_íåy
(
å
, &
gr
->
å_l°
, 
lök
) {

2828 
	`£q_¥ötf
(
sf
, "%u %d %lu.%09lu %u %u.%02u\n",

2829 
å
->
cou¡
,År->
£˘‹s
,

2830 ()
å
->
ts
.
tv_£c
,

2831 ()
å
->
ts
.
tv_n£c
,

2832 
å
->
øã
,År->
i›s
 / 100,År->iops % 100);

2836 
	`muãx_u∆ock
(&
mmc_ã°_lock
);

2839 
	}
}

2841 
	$mtf_ã°_›í
(
öode
 *öode, 
fûe
 *file)

2843  
	`sögÀ_›í
(
fûe
, 
mtf_ã°_show
, 
öode
->
i_¥iv©e
);

2844 
	}
}

2846 
ssize_t
 
	$mtf_ã°_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf
,

2847 
size_t
 
cou¡
, 
loff_t
 *
pos
)

2849 
£q_fûe
 *
sf
 = (£q_fûê*)
fûe
->
¥iv©e_d©a
;

2850 
mmc_ˇrd
 *
ˇrd
 = (mmc_ˇrd *)
sf
->
¥iv©e
;

2851 
mmc_ã°_ˇrd
 *
ã°
;

2852 
ã°ˇ£
;

2853 
ªt
;

2855 
ªt
 = 
	`k°πﬁ_‰om_u£r
(
buf
, 
cou¡
, 10, &
ã°ˇ£
);

2856 i‡(
ªt
)

2857  
ªt
;

2859 
ã°
 = 
	`kzÆloc
((
mmc_ã°_ˇrd
), 
GFP_KERNEL
);

2860 i‡(!
ã°
)

2861  -
ENOMEM
;

2867 
	`mmc_ã°_‰ì_ªsu…
(
ˇrd
);

2869 
ã°
->
ˇrd
 = card;

2871 
ã°
->
buf„r
 = 
	`kzÆloc
(
BUFFER_SIZE
, 
GFP_KERNEL
);

2872 #ifde‡
CONFIG_HIGHMEM


2873 
ã°
->
highmem
 = 
	`Æloc_∑ges
(
GFP_KERNEL
 | 
__GFP_HIGHMEM
, 
BUFFER_ORDER
);

2876 #ifde‡
CONFIG_HIGHMEM


2877 i‡(
ã°
->
buf„r
 &&Åe°->
highmem
) {

2879 i‡(
ã°
->
buf„r
) {

2881 
	`muãx_lock
(&
mmc_ã°_lock
);

2882 
	`mmc_ã°_run
(
ã°
, 
ã°ˇ£
);

2883 
	`muãx_u∆ock
(&
mmc_ã°_lock
);

2886 #ifde‡
CONFIG_HIGHMEM


2887 
	`__‰ì_∑ges
(
ã°
->
highmem
, 
BUFFER_ORDER
);

2889 
	`k‰ì
(
ã°
->
buf„r
);

2890 
	`k‰ì
(
ã°
);

2892  
cou¡
;

2893 
	}
}

2895 c⁄° 
fûe_›î©i⁄s
 
	gmmc_ã°_f›s_ã°
 = {

2896 .
›í
 = 
mtf_ã°_›í
,

2897 .
	gªad
 = 
£q_ªad
,

2898 .
	gwrôe
 = 
mtf_ã°_wrôe
,

2899 .
	gŒ£ek
 = 
£q_l£ek
,

2900 .
	gªÀa£
 = 
sögÀ_ªÀa£
,

2903 
	$mtf_ã°li°_show
(
£q_fûe
 *
sf
, *
d©a
)

2905 
i
;

2907 
	`muãx_lock
(&
mmc_ã°_lock
);

2909 
i
 = 0; i < 
	`ARRAY_SIZE
(
mmc_ã°_ˇ£s
); i++)

2910 
	`£q_¥ötf
(
sf
, "%d:\t%s\n", 
i
+1, 
mmc_ã°_ˇ£s
[i].
«me
);

2912 
	`muãx_u∆ock
(&
mmc_ã°_lock
);

2915 
	}
}

2917 
	$mtf_ã°li°_›í
(
öode
 *öode, 
fûe
 *file)

2919  
	`sögÀ_›í
(
fûe
, 
mtf_ã°li°_show
, 
öode
->
i_¥iv©e
);

2920 
	}
}

2922 c⁄° 
fûe_›î©i⁄s
 
	gmmc_ã°_f›s_ã°li°
 = {

2923 .
›í
 = 
mtf_ã°li°_›í
,

2924 .
	gªad
 = 
£q_ªad
,

2925 .
	gŒ£ek
 = 
£q_l£ek
,

2926 .
	gªÀa£
 = 
sögÀ_ªÀa£
,

2929 
	$mmc_ã°_‰ì_dbgfs_fûe
(
mmc_ˇrd
 *
ˇrd
)

2931 
mmc_ã°_dbgfs_fûe
 *
df
, *
dfs
;

2933 
	`muãx_lock
(&
mmc_ã°_lock
);

2935 
	`li°_f‹_óch_íåy_ß„
(
df
, 
dfs
, &
mmc_ã°_fûe_ã°
, 
lök
) {

2936 i‡(
ˇrd
 && 
df
->card != card)

2938 
	`debugfs_ªmove
(
df
->
fûe
);

2939 
	`li°_dñ
(&
df
->
lök
);

2940 
	`k‰ì
(
df
);

2943 
	`muãx_u∆ock
(&
mmc_ã°_lock
);

2944 
	}
}

2946 
	$__mmc_ã°_ªgi°î_dbgfs_fûe
(
mmc_ˇrd
 *
ˇrd
,

2947 c⁄° *
«me
, 
umode_t
 
mode
, c⁄° 
fûe_›î©i⁄s
 *
f›s
)

2949 
díåy
 *
fûe
 = 
NULL
;

2950 
mmc_ã°_dbgfs_fûe
 *
df
;

2952 i‡(
ˇrd
->
debugfs_roŸ
)

2953 
fûe
 = 
	`debugfs_¸óã_fûe
(
«me
, 
mode
, 
ˇrd
->
debugfs_roŸ
,

2954 
ˇrd
, 
f›s
);

2956 i‡(
	`IS_ERR_OR_NULL
(
fûe
)) {

2957 
	`dev_îr
(&
ˇrd
->
dev
,

2959 
«me
);

2960  -
ENODEV
;

2963 
df
 = 
	`kmÆloc
((
mmc_ã°_dbgfs_fûe
), 
GFP_KERNEL
);

2964 i‡(!
df
) {

2965 
	`debugfs_ªmove
(
fûe
);

2966 
	`dev_îr
(&
ˇrd
->
dev
,

2968  -
ENOMEM
;

2971 
df
->
ˇrd
 = card;

2972 
df
->
fûe
 = file;

2974 
	`li°_add
(&
df
->
lök
, &
mmc_ã°_fûe_ã°
);

2976 
	}
}

2978 
	$mmc_ã°_ªgi°î_dbgfs_fûe
(
mmc_ˇrd
 *
ˇrd
)

2980 
ªt
;

2982 
	`muãx_lock
(&
mmc_ã°_lock
);

2984 
ªt
 = 
	`__mmc_ã°_ªgi°î_dbgfs_fûe
(
ˇrd
, "ã°", 
S_IWUSR
 | 
S_IRUGO
,

2985 &
mmc_ã°_f›s_ã°
);

2986 i‡(
ªt
)

2987 
îr
;

2989 
ªt
 = 
	`__mmc_ã°_ªgi°î_dbgfs_fûe
(
ˇrd
, "ã°li°", 
S_IRUGO
,

2990 &
mmc_ã°_f›s_ã°li°
);

2991 i‡(
ªt
)

2992 
îr
;

2994 
îr
:

2995 
	`muãx_u∆ock
(&
mmc_ã°_lock
);

2997  
ªt
;

2998 
	}
}

3000 
	$mmc_ã°_¥obe
(
mmc_ˇrd
 *
ˇrd
)

3002 
ªt
;

3004 i‡(!
	`mmc_ˇrd_mmc
(
ˇrd
Ë&& !
	`mmc_ˇrd_sd
(card))

3005  -
ENODEV
;

3007 
ªt
 = 
	`mmc_ã°_ªgi°î_dbgfs_fûe
(
ˇrd
);

3008 i‡(
ªt
)

3009  
ªt
;

3011 
	`dev_öfo
(&
ˇrd
->
dev
, "Card claimed forÅesting.\n");

3014 
	}
}

3016 
	$mmc_ã°_ªmove
(
mmc_ˇrd
 *
ˇrd
)

3018 
	`mmc_ã°_‰ì_ªsu…
(
ˇrd
);

3019 
	`mmc_ã°_‰ì_dbgfs_fûe
(
ˇrd
);

3020 
	}
}

3022 
	$mmc_ã°_shutdown
(
mmc_ˇrd
 *
ˇrd
)

3024 
	}
}

3026 
mmc_drivî
 
	gmmc_drivî
 = {

3027 .
drv
 = {

3028 .
«me
 = "mmc_test",

3030 .
	g¥obe
 = 
mmc_ã°_¥obe
,

3031 .
	gªmove
 = 
mmc_ã°_ªmove
,

3032 .
	gshutdown
 = 
mmc_ã°_shutdown
,

3035 
__öô
 
	$mmc_ã°_öô
()

3037  
	`mmc_ªgi°î_drivî
(&
mmc_drivî
);

3038 
	}
}

3040 
__exô
 
	$mmc_ã°_exô
()

3043 
	`mmc_ã°_‰ì_ªsu…
(
NULL
);

3044 
	`mmc_ã°_‰ì_dbgfs_fûe
(
NULL
);

3046 
	`mmc_uƒegi°î_drivî
(&
mmc_drivî
);

3047 
	}
}

3049 
moduÀ_öô
(
mmc_ã°_öô
);

3050 
moduÀ_exô
(
mmc_ã°_exô
);

3052 
MODULE_LICENSE
("GPL");

3053 
MODULE_DESCRIPTION
("Multimedia Card (MMC) hostÅest driver");

3054 
MODULE_AUTHOR
("Pierre Ossman");

	@queue.c

12 
	~<löux/¶ab.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/blkdev.h
>

15 
	~<löux/‰ìzî.h
>

16 
	~<löux/kthªad.h
>

17 
	~<löux/sˇâîli°.h
>

18 
	~<löux/dma-m≠pög.h
>

20 
	~<löux/mmc/ˇrd.h
>

21 
	~<löux/mmc/ho°.h
>

22 
	~"queue.h
"

24 
	#MMC_QUEUE_BOUNCESZ
 65536

	)

29 
	$mmc_¥ï_ªque°
(
ªque°_queue
 *
q
, 
ªque°
 *
ªq
)

31 
mmc_queue
 *
mq
 = 
q
->
queued©a
;

36 i‡(
ªq
->
cmd_ty≥
 !
REQ_TYPE_FS
 && !‘eq->
cmd_Êags
 & 
REQ_DISCARD
)) {

37 
	`blk_dump_rq_Êags
(
ªq
, "MMC badÑequest");

38  
BLKPREP_KILL
;

41 i‡(
mq
 && 
	`mmc_ˇrd_ªmoved
(mq->
ˇrd
))

42  
BLKPREP_KILL
;

44 
ªq
->
cmd_Êags
 |
REQ_DONTPREP
;

46  
BLKPREP_OK
;

47 
	}
}

49 
	$mmc_queue_thªad
(*
d
)

51 
mmc_queue
 *
mq
 = 
d
;

52 
ªque°_queue
 *
q
 = 
mq
->
queue
;

54 
cuºít
->
Êags
 |
PF_MEMALLOC
;

56 
	`down
(&
mq
->
thªad_£m
);

58 
ªque°
 *
ªq
 = 
NULL
;

59 
mmc_queue_ªq
 *
tmp
;

60 
cmd_Êags
 = 0;

62 
	`•ö_lock_úq
(
q
->
queue_lock
);

63 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

64 
ªq
 = 
	`blk_„tch_ªque°
(
q
);

65 
mq
->
mqrq_cur
->
ªq
 =Ñeq;

66 
	`•ö_u∆ock_úq
(
q
->
queue_lock
);

68 i‡(
ªq
 || 
mq
->
mqrq_¥ev
->req) {

69 
	`£t_cuºít_°©e
(
TASK_RUNNING
);

70 
cmd_Êags
 = 
ªq
 ?Ñeq->cmd_flags : 0;

71 
mq
->
	`issue_‚
(mq, 
ªq
);

72 i‡(
mq
->
Êags
 & 
MMC_QUEUE_NEW_REQUEST
) {

73 
mq
->
Êags
 &~
MMC_QUEUE_NEW_REQUEST
;

84 i‡(
cmd_Êags
 & 
MMC_REQ_SPECIAL_MASK
)

85 
mq
->
mqrq_cur
->
ªq
 = 
NULL
;

87 
mq
->
mqrq_¥ev
->
brq
.
mrq
.
d©a
 = 
NULL
;

88 
mq
->
mqrq_¥ev
->
ªq
 = 
NULL
;

89 
tmp
 = 
mq
->
mqrq_¥ev
;

90 
mq
->
mqrq_¥ev
 = mq->
mqrq_cur
;

91 
mq
->
mqrq_cur
 = 
tmp
;

93 i‡(
	`kthªad_should_°›
()) {

94 
	`£t_cuºít_°©e
(
TASK_RUNNING
);

97 
	`up
(&
mq
->
thªad_£m
);

98 
	`scheduÀ
();

99 
	`down
(&
mq
->
thªad_£m
);

102 
	`up
(&
mq
->
thªad_£m
);

105 
	}
}

113 
	$mmc_ªque°_‚
(
ªque°_queue
 *
q
)

115 
mmc_queue
 *
mq
 = 
q
->
queued©a
;

116 
ªque°
 *
ªq
;

117 
Êags
;

118 
mmc_c⁄ãxt_öfo
 *
˙tx
;

120 i‡(!
mq
) {

121 (
ªq
 = 
	`blk_„tch_ªque°
(
q
)Ë!
NULL
) {

122 
ªq
->
cmd_Êags
 |
REQ_QUIET
;

123 
	`__blk_íd_ªque°_Æl
(
ªq
, -
EIO
);

128 
˙tx
 = &
mq
->
ˇrd
->
ho°
->
c⁄ãxt_öfo
;

129 i‡(!
mq
->
mqrq_cur
->
ªq
 && mq->
mqrq_¥ev
->req) {

135 
	`•ö_lock_úqßve
(&
˙tx
->
lock
, 
Êags
);

136 i‡(
˙tx
->
is_waôög_œ°_ªq
) {

137 
˙tx
->
is_√w_ªq
 = 
åue
;

138 
	`wake_up_öãºu±ibÀ
(&
˙tx
->
waô
);

140 
	`•ö_u∆ock_úqª°‹e
(&
˙tx
->
lock
, 
Êags
);

141 } i‡(!
mq
->
mqrq_cur
->
ªq
 && !mq->
mqrq_¥ev
->req)

142 
	`wake_up_¥o˚ss
(
mq
->
thªad
);

143 
	}
}

145 
sˇâîli°
 *
	$mmc_Æloc_sg
(
sg_Àn
, *
îr
)

147 
sˇâîli°
 *
sg
;

149 
sg
 = 
	`kmÆloc
((
sˇâîli°
)*
sg_Àn
, 
GFP_KERNEL
);

150 i‡(!
sg
)

151 *
îr
 = -
ENOMEM
;

153 *
îr
 = 0;

154 
	`sg_öô_èbÀ
(
sg
, 
sg_Àn
);

157  
sg
;

158 
	}
}

160 
	$mmc_queue_£tup_disˇrd
(
ªque°_queue
 *
q
,

161 
mmc_ˇrd
 *
ˇrd
)

163 
max_disˇrd
;

165 
max_disˇrd
 = 
	`mmc_ˇlc_max_disˇrd
(
ˇrd
);

166 i‡(!
max_disˇrd
)

169 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_DISCARD
, 
q
);

170 
q
->
limôs
.
max_disˇrd_£˘‹s
 = 
max_disˇrd
;

171 i‡(
ˇrd
->
îa£d_byã
 =0 && !
	`mmc_ˇn_disˇrd
(card))

172 
q
->
limôs
.
disˇrd_zî€s_d©a
 = 1;

173 
q
->
limôs
.
disˇrd_gønuœrôy
 = 
ˇrd
->
¥ef_îa£
 << 9;

175 i‡(
ˇrd
->
¥ef_îa£
 > 
max_disˇrd
)

176 
q
->
limôs
.
disˇrd_gønuœrôy
 = 0;

177 i‡(
	`mmc_ˇn_£cuª_îa£_åim
(
ˇrd
))

178 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_SECDISCARD
, 
q
);

179 
	}
}

190 
	$mmc_öô_queue
(
mmc_queue
 *
mq
, 
mmc_ˇrd
 *
ˇrd
,

191 
•ölock_t
 *
lock
, c⁄° *
sub«me
)

193 
mmc_ho°
 *
ho°
 = 
ˇrd
->host;

194 
u64
 
limô
 = 
BLK_BOUNCE_HIGH
;

195 
ªt
;

196 
mmc_queue_ªq
 *
mqrq_cur
 = &
mq
->
mqrq
[0];

197 
mmc_queue_ªq
 *
mqrq_¥ev
 = &
mq
->
mqrq
[1];

199 i‡(
	`mmc_dev
(
ho°
)->
dma_mask
 && *mmc_dev(host)->dma_mask)

200 
limô
 = (
u64
)
	`dma_max_p‚
(
	`mmc_dev
(
ho°
)Ë<< 
PAGE_SHIFT
;

202 
mq
->
ˇrd
 = card;

203 
mq
->
queue
 = 
	`blk_öô_queue
(
mmc_ªque°_‚
, 
lock
);

204 i‡(!
mq
->
queue
)

205  -
ENOMEM
;

207 
mq
->
mqrq_cur
 = mqrq_cur;

208 
mq
->
mqrq_¥ev
 = mqrq_prev;

209 
mq
->
queue
->
queued©a
 = mq;

211 
	`blk_queue_¥ï_rq
(
mq
->
queue
, 
mmc_¥ï_ªque°
);

212 
	`queue_Êag_£t_u∆ocked
(
QUEUE_FLAG_NONROT
, 
mq
->
queue
);

213 i‡(
	`mmc_ˇn_îa£
(
ˇrd
))

214 
	`mmc_queue_£tup_disˇrd
(
mq
->
queue
, 
ˇrd
);

216 #ifde‡
CONFIG_MMC_BLOCK_BOUNCE


217 i‡(
ho°
->
max_£gs
 == 1) {

218 
boun˚sz
;

220 
boun˚sz
 = 
MMC_QUEUE_BOUNCESZ
;

222 i‡(
boun˚sz
 > 
ho°
->
max_ªq_size
)

223 
boun˚sz
 = 
ho°
->
max_ªq_size
;

224 i‡(
boun˚sz
 > 
ho°
->
max_£g_size
)

225 
boun˚sz
 = 
ho°
->
max_£g_size
;

226 i‡(
boun˚sz
 > (
ho°
->
max_blk_cou¡
 * 512))

227 
boun˚sz
 = 
ho°
->
max_blk_cou¡
 * 512;

229 i‡(
boun˚sz
 > 512) {

230 
mqrq_cur
->
boun˚_buf
 = 
	`kmÆloc
(
boun˚sz
, 
GFP_KERNEL
);

231 i‡(!
mqrq_cur
->
boun˚_buf
) {

232 
	`¥_w¨nög
("%s: unableÅo "

234 
	`mmc_ˇrd_«me
(
ˇrd
));

236 
mqrq_¥ev
->
boun˚_buf
 = 
	`kmÆloc
(
boun˚sz
, 
GFP_KERNEL
);

237 i‡(!
mqrq_¥ev
->
boun˚_buf
) {

238 
	`¥_w¨nög
("%s: unableÅo "

240 
	`mmc_ˇrd_«me
(
ˇrd
));

241 
	`k‰ì
(
mqrq_cur
->
boun˚_buf
);

242 
mqrq_cur
->
boun˚_buf
 = 
NULL
;

246 i‡(
mqrq_cur
->
boun˚_buf
 && 
mqrq_¥ev
->bounce_buf) {

247 
	`blk_queue_boun˚_limô
(
mq
->
queue
, 
BLK_BOUNCE_ANY
);

248 
	`blk_queue_max_hw_£˘‹s
(
mq
->
queue
, 
boun˚sz
 / 512);

249 
	`blk_queue_max_£gmíts
(
mq
->
queue
, 
boun˚sz
 / 512);

250 
	`blk_queue_max_£gmít_size
(
mq
->
queue
, 
boun˚sz
);

252 
mqrq_cur
->
sg
 = 
	`mmc_Æloc_sg
(1, &
ªt
);

253 i‡(
ªt
)

254 
˛ónup_queue
;

256 
mqrq_cur
->
boun˚_sg
 =

257 
	`mmc_Æloc_sg
(
boun˚sz
 / 512, &
ªt
);

258 i‡(
ªt
)

259 
˛ónup_queue
;

261 
mqrq_¥ev
->
sg
 = 
	`mmc_Æloc_sg
(1, &
ªt
);

262 i‡(
ªt
)

263 
˛ónup_queue
;

265 
mqrq_¥ev
->
boun˚_sg
 =

266 
	`mmc_Æloc_sg
(
boun˚sz
 / 512, &
ªt
);

267 i‡(
ªt
)

268 
˛ónup_queue
;

273 i‡(!
mqrq_cur
->
boun˚_buf
 && !
mqrq_¥ev
->bounce_buf) {

274 
	`blk_queue_boun˚_limô
(
mq
->
queue
, 
limô
);

275 
	`blk_queue_max_hw_£˘‹s
(
mq
->
queue
,

276 
	`mö
(
ho°
->
max_blk_cou¡
, ho°->
max_ªq_size
 / 512));

277 
	`blk_queue_max_£gmíts
(
mq
->
queue
, 
ho°
->
max_£gs
);

278 
	`blk_queue_max_£gmít_size
(
mq
->
queue
, 
ho°
->
max_£g_size
);

280 
mqrq_cur
->
sg
 = 
	`mmc_Æloc_sg
(
ho°
->
max_£gs
, &
ªt
);

281 i‡(
ªt
)

282 
˛ónup_queue
;

285 
mqrq_¥ev
->
sg
 = 
	`mmc_Æloc_sg
(
ho°
->
max_£gs
, &
ªt
);

286 i‡(
ªt
)

287 
˛ónup_queue
;

290 
	`£ma_öô
(&
mq
->
thªad_£m
, 1);

292 
mq
->
thªad
 = 
	`kthªad_run
(
mmc_queue_thªad
, mq, "mmcqd/%d%s",

293 
ho°
->
ödex
, 
sub«me
 ? subname : "");

295 i‡(
	`IS_ERR
(
mq
->
thªad
)) {

296 
ªt
 = 
	`PTR_ERR
(
mq
->
thªad
);

297 
‰ì_boun˚_sg
;

301 
‰ì_boun˚_sg
:

302 
	`k‰ì
(
mqrq_cur
->
boun˚_sg
);

303 
mqrq_cur
->
boun˚_sg
 = 
NULL
;

304 
	`k‰ì
(
mqrq_¥ev
->
boun˚_sg
);

305 
mqrq_¥ev
->
boun˚_sg
 = 
NULL
;

307 
˛ónup_queue
:

308 
	`k‰ì
(
mqrq_cur
->
sg
);

309 
mqrq_cur
->
sg
 = 
NULL
;

310 
	`k‰ì
(
mqrq_cur
->
boun˚_buf
);

311 
mqrq_cur
->
boun˚_buf
 = 
NULL
;

313 
	`k‰ì
(
mqrq_¥ev
->
sg
);

314 
mqrq_¥ev
->
sg
 = 
NULL
;

315 
	`k‰ì
(
mqrq_¥ev
->
boun˚_buf
);

316 
mqrq_¥ev
->
boun˚_buf
 = 
NULL
;

318 
	`blk_˛ónup_queue
(
mq
->
queue
);

319  
ªt
;

320 
	}
}

322 
	$mmc_˛ónup_queue
(
mmc_queue
 *
mq
)

324 
ªque°_queue
 *
q
 = 
mq
->
queue
;

325 
Êags
;

326 
mmc_queue_ªq
 *
mqrq_cur
 = 
mq
->mqrq_cur;

327 
mmc_queue_ªq
 *
mqrq_¥ev
 = 
mq
->mqrq_prev;

330 
	`mmc_queue_ªsume
(
mq
);

333 
	`kthªad_°›
(
mq
->
thªad
);

336 
	`•ö_lock_úqßve
(
q
->
queue_lock
, 
Êags
);

337 
q
->
queued©a
 = 
NULL
;

338 
	`blk_°¨t_queue
(
q
);

339 
	`•ö_u∆ock_úqª°‹e
(
q
->
queue_lock
, 
Êags
);

341 
	`k‰ì
(
mqrq_cur
->
boun˚_sg
);

342 
mqrq_cur
->
boun˚_sg
 = 
NULL
;

344 
	`k‰ì
(
mqrq_cur
->
sg
);

345 
mqrq_cur
->
sg
 = 
NULL
;

347 
	`k‰ì
(
mqrq_cur
->
boun˚_buf
);

348 
mqrq_cur
->
boun˚_buf
 = 
NULL
;

350 
	`k‰ì
(
mqrq_¥ev
->
boun˚_sg
);

351 
mqrq_¥ev
->
boun˚_sg
 = 
NULL
;

353 
	`k‰ì
(
mqrq_¥ev
->
sg
);

354 
mqrq_¥ev
->
sg
 = 
NULL
;

356 
	`k‰ì
(
mqrq_¥ev
->
boun˚_buf
);

357 
mqrq_¥ev
->
boun˚_buf
 = 
NULL
;

359 
mq
->
ˇrd
 = 
NULL
;

360 
	}
}

361 
EXPORT_SYMBOL
(
mmc_˛ónup_queue
);

363 
	$mmc_∑cked_öô
(
mmc_queue
 *
mq
, 
mmc_ˇrd
 *
ˇrd
)

365 
mmc_queue_ªq
 *
mqrq_cur
 = &
mq
->
mqrq
[0];

366 
mmc_queue_ªq
 *
mqrq_¥ev
 = &
mq
->
mqrq
[1];

367 
ªt
 = 0;

370 
mqrq_cur
->
∑cked
 = 
	`kzÆloc
((
mmc_∑cked
), 
GFP_KERNEL
);

371 i‡(!
mqrq_cur
->
∑cked
) {

372 
	`¥_w¨n
("%s: unableÅoállocateÖacked cmd for mqrq_cur\n",

373 
	`mmc_ˇrd_«me
(
ˇrd
));

374 
ªt
 = -
ENOMEM
;

375 
out
;

378 
mqrq_¥ev
->
∑cked
 = 
	`kzÆloc
((
mmc_∑cked
), 
GFP_KERNEL
);

379 i‡(!
mqrq_¥ev
->
∑cked
) {

380 
	`¥_w¨n
("%s: unableÅoállocateÖacked cmd for mqrq_prev\n",

381 
	`mmc_ˇrd_«me
(
ˇrd
));

382 
	`k‰ì
(
mqrq_cur
->
∑cked
);

383 
mqrq_cur
->
∑cked
 = 
NULL
;

384 
ªt
 = -
ENOMEM
;

385 
out
;

388 
	`INIT_LIST_HEAD
(&
mqrq_cur
->
∑cked
->
li°
);

389 
	`INIT_LIST_HEAD
(&
mqrq_¥ev
->
∑cked
->
li°
);

391 
out
:

392  
ªt
;

393 
	}
}

395 
	$mmc_∑cked_˛ón
(
mmc_queue
 *
mq
)

397 
mmc_queue_ªq
 *
mqrq_cur
 = &
mq
->
mqrq
[0];

398 
mmc_queue_ªq
 *
mqrq_¥ev
 = &
mq
->
mqrq
[1];

400 
	`k‰ì
(
mqrq_cur
->
∑cked
);

401 
mqrq_cur
->
∑cked
 = 
NULL
;

402 
	`k‰ì
(
mqrq_¥ev
->
∑cked
);

403 
mqrq_¥ev
->
∑cked
 = 
NULL
;

404 
	}
}

414 
	$mmc_queue_su•íd
(
mmc_queue
 *
mq
)

416 
ªque°_queue
 *
q
 = 
mq
->
queue
;

417 
Êags
;

419 i‡(!(
mq
->
Êags
 & 
MMC_QUEUE_SUSPENDED
)) {

420 
mq
->
Êags
 |
MMC_QUEUE_SUSPENDED
;

422 
	`•ö_lock_úqßve
(
q
->
queue_lock
, 
Êags
);

423 
	`blk_°›_queue
(
q
);

424 
	`•ö_u∆ock_úqª°‹e
(
q
->
queue_lock
, 
Êags
);

426 
	`down
(&
mq
->
thªad_£m
);

428 
	}
}

434 
	$mmc_queue_ªsume
(
mmc_queue
 *
mq
)

436 
ªque°_queue
 *
q
 = 
mq
->
queue
;

437 
Êags
;

439 i‡(
mq
->
Êags
 & 
MMC_QUEUE_SUSPENDED
) {

440 
mq
->
Êags
 &~
MMC_QUEUE_SUSPENDED
;

442 
	`up
(&
mq
->
thªad_£m
);

444 
	`•ö_lock_úqßve
(
q
->
queue_lock
, 
Êags
);

445 
	`blk_°¨t_queue
(
q
);

446 
	`•ö_u∆ock_úqª°‹e
(
q
->
queue_lock
, 
Êags
);

448 
	}
}

450 
	$mmc_queue_∑cked_m≠_sg
(
mmc_queue
 *
mq
,

451 
mmc_∑cked
 *
∑cked
,

452 
sˇâîli°
 *
sg
,

453 
mmc_∑cked_ty≥
 
cmd_ty≥
)

455 
sˇâîli°
 *
__sg
 = 
sg
;

456 
sg_Àn
 = 0;

457 
ªque°
 *
ªq
;

459 i‡(
	`mmc_∑cked_wr
(
cmd_ty≥
)) {

460 
hdr_sz
 = 
	`mmc_œrge_£˘‹
(
mq
->
ˇrd
) ? 4096 : 512;

461 
max_£g_sz
 = 
	`queue_max_£gmít_size
(
mq
->
queue
);

462 
Àn
, 
ªmaö
, 
off£t
 = 0;

463 
u8
 *
buf
 = (u8 *)
∑cked
->
cmd_hdr
;

465 
ªmaö
 = 
hdr_sz
;

467 
Àn
 = 
	`mö
(
ªmaö
, 
max_£g_sz
);

468 
	`sg_£t_buf
(
__sg
, 
buf
 + 
off£t
, 
Àn
);

469 
off£t
 +
Àn
;

470 
ªmaö
 -
Àn
;

471 (
__sg
++)->
∑ge_lök
 &= ~0x02;

472 
sg_Àn
++;

473 } 
ªmaö
);

476 
	`li°_f‹_óch_íåy
(
ªq
, &
∑cked
->
li°
, 
queuñi°
) {

477 
sg_Àn
 +
	`blk_rq_m≠_sg
(
mq
->
queue
, 
ªq
, 
__sg
);

478 
__sg
 = 
sg
 + (
sg_Àn
 - 1);

479 (
__sg
++)->
∑ge_lök
 &= ~0x02;

481 
	`sg_m¨k_íd
(
sg
 + (
sg_Àn
 - 1));

482  
sg_Àn
;

483 
	}
}

488 
	$mmc_queue_m≠_sg
(
mmc_queue
 *
mq
, 
mmc_queue_ªq
 *
mqrq
)

490 
sg_Àn
;

491 
size_t
 
buÊí
;

492 
sˇâîli°
 *
sg
;

493 
mmc_∑cked_ty≥
 
cmd_ty≥
;

494 
i
;

496 
cmd_ty≥
 = 
mqrq
->cmd_type;

498 i‡(!
mqrq
->
boun˚_buf
) {

499 i‡(
	`mmc_∑cked_cmd
(
cmd_ty≥
))

500  
	`mmc_queue_∑cked_m≠_sg
(
mq
, 
mqrq
->
∑cked
,

501 
mqrq
->
sg
, 
cmd_ty≥
);

503  
	`blk_rq_m≠_sg
(
mq
->
queue
, 
mqrq
->
ªq
, mqrq->
sg
);

506 
	`BUG_ON
(!
mqrq
->
boun˚_sg
);

508 i‡(
	`mmc_∑cked_cmd
(
cmd_ty≥
))

509 
sg_Àn
 = 
	`mmc_queue_∑cked_m≠_sg
(
mq
, 
mqrq
->
∑cked
,

510 
mqrq
->
boun˚_sg
, 
cmd_ty≥
);

512 
sg_Àn
 = 
	`blk_rq_m≠_sg
(
mq
->
queue
, 
mqrq
->
ªq
, mqrq->
boun˚_sg
);

514 
mqrq
->
boun˚_sg_Àn
 = 
sg_Àn
;

516 
buÊí
 = 0;

517 
	`f‹_óch_sg
(
mqrq
->
boun˚_sg
, 
sg
, 
sg_Àn
, 
i
)

518 
buÊí
 +
sg
->
Àngth
;

520 
	`sg_öô_⁄e
(
mqrq
->
sg
, mqrq->
boun˚_buf
, 
buÊí
);

523 
	}
}

529 
	$mmc_queue_boun˚_¥e
(
mmc_queue_ªq
 *
mqrq
)

531 i‡(!
mqrq
->
boun˚_buf
)

534 i‡(
	`rq_d©a_dú
(
mqrq
->
ªq
Ë!
WRITE
)

537 
	`sg_c›y_to_buf„r
(
mqrq
->
boun˚_sg
, mqrq->
boun˚_sg_Àn
,

538 
mqrq
->
boun˚_buf
, mqrq->
sg
[0].
Àngth
);

539 
	}
}

545 
	$mmc_queue_boun˚_po°
(
mmc_queue_ªq
 *
mqrq
)

547 i‡(!
mqrq
->
boun˚_buf
)

550 i‡(
	`rq_d©a_dú
(
mqrq
->
ªq
Ë!
READ
)

553 
	`sg_c›y_‰om_buf„r
(
mqrq
->
boun˚_sg
, mqrq->
boun˚_sg_Àn
,

554 
mqrq
->
boun˚_buf
, mqrq->
sg
[0].
Àngth
);

555 
	}
}

	@queue.h

1 #i‚de‡
MMC_QUEUE_H


2 
	#MMC_QUEUE_H


	)

4 
	#MMC_REQ_SPECIAL_MASK
 (
REQ_DISCARD
 | 
REQ_FLUSH
)

	)

6 
	gªque°
;

7 
	gèsk_°ru˘
;

9 
	smmc_blk_ªque°
 {

10 
mmc_ªque°
 
	mmrq
;

11 
mmc_comm™d
 
	msbc
;

12 
mmc_comm™d
 
	mcmd
;

13 
mmc_comm™d
 
	m°›
;

14 
mmc_d©a
 
	md©a
;

17 
	emmc_∑cked_ty≥
 {

18 
	mMMC_PACKED_NONE
 = 0,

19 
	mMMC_PACKED_WRITE
,

22 
	#mmc_∑cked_cmd
(
ty≥
Ë(—y≥Ë!
MMC_PACKED_NONE
)

	)

23 
	#mmc_∑cked_wr
(
ty≥
Ë(—y≥Ë=
MMC_PACKED_WRITE
)

	)

25 
	smmc_∑cked
 {

26 
li°_hód
 
	mli°
;

27 
u32
 
	mcmd_hdr
[1024];

28 
	mblocks
;

29 
u8
 
	mƒ_íåõs
;

30 
u8
 
	mªåõs
;

31 
s16
 
	midx_Áûuª
;

34 
	smmc_queue_ªq
 {

35 
ªque°
 *
	mªq
;

36 
mmc_blk_ªque°
 
	mbrq
;

37 
sˇâîli°
 *
	msg
;

38 *
	mboun˚_buf
;

39 
sˇâîli°
 *
	mboun˚_sg
;

40 
	mboun˚_sg_Àn
;

41 
mmc_async_ªq
 
	mmmc_a˘ive
;

42 
mmc_∑cked_ty≥
 
	mcmd_ty≥
;

43 
mmc_∑cked
 *
	m∑cked
;

46 
	smmc_queue
 {

47 
mmc_ˇrd
 *
	mˇrd
;

48 
èsk_°ru˘
 *
	mthªad
;

49 
£m≠h‹e
 
	mthªad_£m
;

50 
	mÊags
;

51 
	#MMC_QUEUE_SUSPENDED
 (1 << 0)

	)

52 
	#MMC_QUEUE_NEW_REQUEST
 (1 << 1)

	)

54 (*
	missue_‚
)(
	mmmc_queue
 *, 
	mªque°
 *);

55 *
	md©a
;

56 
ªque°_queue
 *
	mqueue
;

57 
mmc_queue_ªq
 
	mmqrq
[2];

58 
mmc_queue_ªq
 *
	mmqrq_cur
;

59 
mmc_queue_ªq
 *
	mmqrq_¥ev
;

62 
mmc_öô_queue
(
mmc_queue
 *, 
mmc_ˇrd
 *, 
•ölock_t
 *,

64 
mmc_˛ónup_queue
(
mmc_queue
 *);

65 
mmc_queue_su•íd
(
mmc_queue
 *);

66 
mmc_queue_ªsume
(
mmc_queue
 *);

68 
mmc_queue_m≠_sg
(
mmc_queue
 *,

69 
mmc_queue_ªq
 *);

70 
mmc_queue_boun˚_¥e
(
mmc_queue_ªq
 *);

71 
mmc_queue_boun˚_po°
(
mmc_queue_ªq
 *);

73 
mmc_∑cked_öô
(
mmc_queue
 *, 
mmc_ˇrd
 *);

74 
mmc_∑cked_˛ón
(
mmc_queue
 *);

	@sdio_uart.c

29 
	~<löux/moduÀ.h
>

30 
	~<löux/öô.h
>

31 
	~<löux/kî√l.h
>

32 
	~<löux/sched.h
>

33 
	~<löux/muãx.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/£rül_ªg.h
>

36 
	~<löux/cúc_buf.h
>

37 
	~<löux/ây.h
>

38 
	~<löux/ây_Êù.h
>

39 
	~<löux/kfifo.h
>

40 
	~<löux/¶ab.h
>

42 
	~<löux/mmc/c‹e.h
>

43 
	~<löux/mmc/ˇrd.h
>

44 
	~<löux/mmc/sdio_func.h
>

45 
	~<löux/mmc/sdio_ids.h
>

48 
	#UART_NR
 8

	)

51 
	#FIFO_SIZE
 
PAGE_SIZE


	)

52 
	#WAKEUP_CHARS
 256

	)

54 
	su¨t_icou¡
 {

55 
__u32
 
	m˘s
;

56 
__u32
 
	md§
;

57 
__u32
 
	m∫g
;

58 
__u32
 
	mdcd
;

59 
__u32
 
	mrx
;

60 
__u32
 
	mtx
;

61 
__u32
 
	m‰ame
;

62 
__u32
 
	movîrun
;

63 
__u32
 
	m∑rôy
;

64 
__u32
 
	mbrk
;

67 
	ssdio_u¨t_p‹t
 {

68 
ây_p‹t
 
	mp‹t
;

69 
	mödex
;

70 
sdio_func
 *
	mfunc
;

71 
muãx
 
	mfunc_lock
;

72 
èsk_°ru˘
 *
	mö_sdio_u¨t_úq
;

73 
	mªgs_off£t
;

74 
kfifo
 
	mxmô_fifo
;

75 
•ölock_t
 
	mwrôe_lock
;

76 
u¨t_icou¡
 
	micou¡
;

77 
	mu¨t˛k
;

78 
	mm˘æ
;

79 
	mrx_m˘æ
;

80 
	mªad_°©us_mask
;

81 
	mign‹e_°©us_mask
;

82 
	mx_ch¨
;

83 
	mõr
;

84 
	ml¸
;

87 
sdio_u¨t_p‹t
 *
	gsdio_u¨t_èbÀ
[
UART_NR
];

88 
DEFINE_SPINLOCK
(
sdio_u¨t_èbÀ_lock
);

90 
	$sdio_u¨t_add_p‹t
(
sdio_u¨t_p‹t
 *
p‹t
)

92 
ödex
, 
ªt
 = -
EBUSY
;

94 
	`muãx_öô
(&
p‹t
->
func_lock
);

95 
	`•ö_lock_öô
(&
p‹t
->
wrôe_lock
);

96 i‡(
	`kfifo_Æloc
(&
p‹t
->
xmô_fifo
, 
FIFO_SIZE
, 
GFP_KERNEL
))

97  -
ENOMEM
;

99 
	`•ö_lock
(&
sdio_u¨t_èbÀ_lock
);

100 
ödex
 = 0; index < 
UART_NR
; index++) {

101 i‡(!
sdio_u¨t_èbÀ
[
ödex
]) {

102 
p‹t
->
ödex
 = index;

103 
sdio_u¨t_èbÀ
[
ödex
] = 
p‹t
;

104 
ªt
 = 0;

108 
	`•ö_u∆ock
(&
sdio_u¨t_èbÀ_lock
);

110  
ªt
;

111 
	}
}

113 
sdio_u¨t_p‹t
 *
	$sdio_u¨t_p‹t_gë
(
ödex
)

115 
sdio_u¨t_p‹t
 *
p‹t
;

117 i‡(
ödex
 >
UART_NR
)

118  
NULL
;

120 
	`•ö_lock
(&
sdio_u¨t_èbÀ_lock
);

121 
p‹t
 = 
sdio_u¨t_èbÀ
[
ödex
];

122 i‡(
p‹t
)

123 
	`ây_p‹t_gë
(&
p‹t
->port);

124 
	`•ö_u∆ock
(&
sdio_u¨t_èbÀ_lock
);

126  
p‹t
;

127 
	}
}

129 
	$sdio_u¨t_p‹t_put
(
sdio_u¨t_p‹t
 *
p‹t
)

131 
	`ây_p‹t_put
(&
p‹t
->port);

132 
	}
}

134 
	$sdio_u¨t_p‹t_ªmove
(
sdio_u¨t_p‹t
 *
p‹t
)

136 
sdio_func
 *
func
;

138 
	`BUG_ON
(
sdio_u¨t_èbÀ
[
p‹t
->
ödex
] !=Öort);

140 
	`•ö_lock
(&
sdio_u¨t_èbÀ_lock
);

141 
sdio_u¨t_èbÀ
[
p‹t
->
ödex
] = 
NULL
;

142 
	`•ö_u∆ock
(&
sdio_u¨t_èbÀ_lock
);

151 
	`muãx_lock
(&
p‹t
->p‹t.
muãx
);

152 
	`muãx_lock
(&
p‹t
->
func_lock
);

153 
func
 = 
p‹t
->func;

154 
	`sdio_˛aim_ho°
(
func
);

155 
p‹t
->
func
 = 
NULL
;

156 
	`muãx_u∆ock
(&
p‹t
->
func_lock
);

158 
	`ây_p‹t_ây_h™gup
(&
p‹t
->p‹t, 
Ál£
);

159 
	`muãx_u∆ock
(&
p‹t
->p‹t.
muãx
);

160 
	`sdio_ªÀa£_úq
(
func
);

161 
	`sdio_dißbÀ_func
(
func
);

162 
	`sdio_ªÀa£_ho°
(
func
);

164 
	`sdio_u¨t_p‹t_put
(
p‹t
);

165 
	}
}

167 
	$sdio_u¨t_˛aim_func
(
sdio_u¨t_p‹t
 *
p‹t
)

169 
	`muãx_lock
(&
p‹t
->
func_lock
);

170 i‡(
	`u∆ikñy
(!
p‹t
->
func
)) {

171 
	`muãx_u∆ock
(&
p‹t
->
func_lock
);

172  -
ENODEV
;

174 i‡(
	`likñy
(
p‹t
->
ö_sdio_u¨t_úq
 !
cuºít
))

175 
	`sdio_˛aim_ho°
(
p‹t
->
func
);

176 
	`muãx_u∆ock
(&
p‹t
->
func_lock
);

178 
	}
}

180 
ölöe
 
	$sdio_u¨t_ªÀa£_func
(
sdio_u¨t_p‹t
 *
p‹t
)

182 i‡(
	`likñy
(
p‹t
->
ö_sdio_u¨t_úq
 !
cuºít
))

183 
	`sdio_ªÀa£_ho°
(
p‹t
->
func
);

184 
	}
}

186 
ölöe
 
	$sdio_ö
(
sdio_u¨t_p‹t
 *
p‹t
, 
off£t
)

188 
c
;

189 
c
 = 
	`sdio_ªadb
(
p‹t
->
func
,Ö‹t->
ªgs_off£t
 + 
off£t
, 
NULL
);

190  
c
;

191 
	}
}

193 
ölöe
 
	$sdio_out
(
sdio_u¨t_p‹t
 *
p‹t
, 
off£t
, 
vÆue
)

195 
	`sdio_wrôeb
(
p‹t
->
func
, 
vÆue
,Ö‹t->
ªgs_off£t
 + 
off£t
, 
NULL
);

196 
	}
}

198 
	$sdio_u¨t_gë_m˘æ
(
sdio_u¨t_p‹t
 *
p‹t
)

200 
°©us
;

201 
ªt
;

205 
°©us
 = 
	`sdio_ö
(
p‹t
, 
UART_MSR
);

207 
ªt
 = 0;

208 i‡(
°©us
 & 
UART_MSR_DCD
)

209 
ªt
 |
TIOCM_CAR
;

210 i‡(
°©us
 & 
UART_MSR_RI
)

211 
ªt
 |
TIOCM_RNG
;

212 i‡(
°©us
 & 
UART_MSR_DSR
)

213 
ªt
 |
TIOCM_DSR
;

214 i‡(
°©us
 & 
UART_MSR_CTS
)

215 
ªt
 |
TIOCM_CTS
;

216  
ªt
;

217 
	}
}

219 
	$sdio_u¨t_wrôe_m˘æ
(
sdio_u¨t_p‹t
 *
p‹t
,

220 
m˘æ
)

222 
m¸
 = 0;

224 i‡(
m˘æ
 & 
TIOCM_RTS
)

225 
m¸
 |
UART_MCR_RTS
;

226 i‡(
m˘æ
 & 
TIOCM_DTR
)

227 
m¸
 |
UART_MCR_DTR
;

228 i‡(
m˘æ
 & 
TIOCM_OUT1
)

229 
m¸
 |
UART_MCR_OUT1
;

230 i‡(
m˘æ
 & 
TIOCM_OUT2
)

231 
m¸
 |
UART_MCR_OUT2
;

232 i‡(
m˘æ
 & 
TIOCM_LOOP
)

233 
m¸
 |
UART_MCR_LOOP
;

235 
	`sdio_out
(
p‹t
, 
UART_MCR
, 
m¸
);

236 
	}
}

238 
ölöe
 
	$sdio_u¨t_upd©e_m˘æ
(
sdio_u¨t_p‹t
 *
p‹t
,

239 
£t
, 
˛ór
)

241 
ﬁd
;

243 
ﬁd
 = 
p‹t
->
m˘æ
;

244 
p‹t
->
m˘æ
 = (
ﬁd
 & ~
˛ór
Ë| 
£t
;

245 i‡(
ﬁd
 !
p‹t
->
m˘æ
)

246 
	`sdio_u¨t_wrôe_m˘æ
(
p‹t
,Ö‹t->
m˘æ
);

247 
	}
}

249 
	#sdio_u¨t_£t_m˘æ
(
p‹t
, 
x
Ë
	`sdio_u¨t_upd©e_m˘æ
’‹t, x, 0)

	)

250 
	#sdio_u¨t_˛ór_m˘æ
(
p‹t
, 
x
Ë
	`sdio_u¨t_upd©e_m˘æ
’‹t, 0, x)

	)

252 
	$sdio_u¨t_ch™ge_•ìd
(
sdio_u¨t_p‹t
 *
p‹t
,

253 
kãrmios
 *
ãrmios
,

254 
kãrmios
 *
ﬁd
)

256 
cvÆ
, 
f¸
 = 0;

257 
baud
, 
quŸ
;

259 
ãrmios
->
c_cÊag
 & 
CSIZE
) {

260 
CS5
:

261 
cvÆ
 = 
UART_LCR_WLEN5
;

263 
CS6
:

264 
cvÆ
 = 
UART_LCR_WLEN6
;

266 
CS7
:

267 
cvÆ
 = 
UART_LCR_WLEN7
;

270 
CS8
:

271 
cvÆ
 = 
UART_LCR_WLEN8
;

275 i‡(
ãrmios
->
c_cÊag
 & 
CSTOPB
)

276 
cvÆ
 |
UART_LCR_STOP
;

277 i‡(
ãrmios
->
c_cÊag
 & 
PARENB
)

278 
cvÆ
 |
UART_LCR_PARITY
;

279 i‡(!(
ãrmios
->
c_cÊag
 & 
PARODD
))

280 
cvÆ
 |
UART_LCR_EPAR
;

283 
baud
 = 
	`ây_ãrmios_baud_øã
(
ãrmios
);

284 i‡(
baud
 == 0)

285 
baud
 = 9600;

286 i‡(
baud
 <
p‹t
->
u¨t˛k
)

292 
ãrmios
->
c_cÊag
 &~
CBAUD
;

293 i‡(
ﬁd
) {

294 
ãrmios
->
c_cÊag
 |
ﬁd
->c_cÊag & 
CBAUD
;

295 
ﬁd
 = 
NULL
;

297 
ãrmios
->
c_cÊag
 |
B9600
;

299 
quŸ
 = (2 * 
p‹t
->
u¨t˛k
 + 
baud
) / (2 * baud);

301 i‡(
baud
 < 2400)

302 
f¸
 = 
UART_FCR_ENABLE_FIFO
 | 
UART_FCR_TRIGGER_1
;

304 
f¸
 = 
UART_FCR_ENABLE_FIFO
 | 
UART_FCR_R_TRIG_10
;

306 
p‹t
->
ªad_°©us_mask
 = 
UART_LSR_OE
 | 
UART_LSR_THRE
 | 
UART_LSR_DR
;

307 i‡(
ãrmios
->
c_iÊag
 & 
INPCK
)

308 
p‹t
->
ªad_°©us_mask
 |
UART_LSR_FE
 | 
UART_LSR_PE
;

309 i‡(
ãrmios
->
c_iÊag
 & (
BRKINT
 | 
PARMRK
))

310 
p‹t
->
ªad_°©us_mask
 |
UART_LSR_BI
;

315 
p‹t
->
ign‹e_°©us_mask
 = 0;

316 i‡(
ãrmios
->
c_iÊag
 & 
IGNPAR
)

317 
p‹t
->
ign‹e_°©us_mask
 |
UART_LSR_PE
 | 
UART_LSR_FE
;

318 i‡(
ãrmios
->
c_iÊag
 & 
IGNBRK
) {

319 
p‹t
->
ign‹e_°©us_mask
 |
UART_LSR_BI
;

324 i‡(
ãrmios
->
c_iÊag
 & 
IGNPAR
)

325 
p‹t
->
ign‹e_°©us_mask
 |
UART_LSR_OE
;

331 i‡((
ãrmios
->
c_cÊag
 & 
CREAD
) == 0)

332 
p‹t
->
ign‹e_°©us_mask
 |
UART_LSR_DR
;

337 
p‹t
->
õr
 &~
UART_IER_MSI
;

338 i‡((
ãrmios
->
c_cÊag
 & 
CRTSCTS
Ë|| !—îmios->c_cÊag & 
CLOCAL
))

339 
p‹t
->
õr
 |
UART_IER_MSI
;

341 
p‹t
->
l¸
 = 
cvÆ
;

343 
	`sdio_out
(
p‹t
, 
UART_IER
,Ö‹t->
õr
);

344 
	`sdio_out
(
p‹t
, 
UART_LCR
, 
cvÆ
 | 
UART_LCR_DLAB
);

345 
	`sdio_out
(
p‹t
, 
UART_DLL
, 
quŸ
 & 0xff);

346 
	`sdio_out
(
p‹t
, 
UART_DLM
, 
quŸ
 >> 8);

347 
	`sdio_out
(
p‹t
, 
UART_LCR
, 
cvÆ
);

348 
	`sdio_out
(
p‹t
, 
UART_FCR
, 
f¸
);

350 
	`sdio_u¨t_wrôe_m˘æ
(
p‹t
,Ö‹t->
m˘æ
);

351 
	}
}

353 
	$sdio_u¨t_°¨t_tx
(
sdio_u¨t_p‹t
 *
p‹t
)

355 i‡(!(
p‹t
->
õr
 & 
UART_IER_THRI
)) {

356 
p‹t
->
õr
 |
UART_IER_THRI
;

357 
	`sdio_out
(
p‹t
, 
UART_IER
,Ö‹t->
õr
);

359 
	}
}

361 
	$sdio_u¨t_°›_tx
(
sdio_u¨t_p‹t
 *
p‹t
)

363 i‡(
p‹t
->
õr
 & 
UART_IER_THRI
) {

364 
p‹t
->
õr
 &~
UART_IER_THRI
;

365 
	`sdio_out
(
p‹t
, 
UART_IER
,Ö‹t->
õr
);

367 
	}
}

369 
	$sdio_u¨t_°›_rx
(
sdio_u¨t_p‹t
 *
p‹t
)

371 
p‹t
->
õr
 &~
UART_IER_RLSI
;

372 
p‹t
->
ªad_°©us_mask
 &~
UART_LSR_DR
;

373 
	`sdio_out
(
p‹t
, 
UART_IER
,Ö‹t->
õr
);

374 
	}
}

376 
	$sdio_u¨t_ª˚ive_ch¨s
(
sdio_u¨t_p‹t
 *
p‹t
,

377 *
°©us
)

379 
ch
, 
Êag
;

380 
max_cou¡
 = 256;

383 
ch
 = 
	`sdio_ö
(
p‹t
, 
UART_RX
);

384 
Êag
 = 
TTY_NORMAL
;

385 
p‹t
->
icou¡
.
rx
++;

387 i‡(
	`u∆ikñy
(*
°©us
 & (
UART_LSR_BI
 | 
UART_LSR_PE
 |

388 
UART_LSR_FE
 | 
UART_LSR_OE
))) {

392 i‡(*
°©us
 & 
UART_LSR_BI
) {

393 *
°©us
 &~(
UART_LSR_FE
 | 
UART_LSR_PE
);

394 
p‹t
->
icou¡
.
brk
++;

395 } i‡(*
°©us
 & 
UART_LSR_PE
)

396 
p‹t
->
icou¡
.
∑rôy
++;

397 i‡(*
°©us
 & 
UART_LSR_FE
)

398 
p‹t
->
icou¡
.
‰ame
++;

399 i‡(*
°©us
 & 
UART_LSR_OE
)

400 
p‹t
->
icou¡
.
ovîrun
++;

405 *
°©us
 &
p‹t
->
ªad_°©us_mask
;

406 i‡(*
°©us
 & 
UART_LSR_BI
)

407 
Êag
 = 
TTY_BREAK
;

408 i‡(*
°©us
 & 
UART_LSR_PE
)

409 
Êag
 = 
TTY_PARITY
;

410 i‡(*
°©us
 & 
UART_LSR_FE
)

411 
Êag
 = 
TTY_FRAME
;

414 i‡((*
°©us
 & 
p‹t
->
ign‹e_°©us_mask
 & ~
UART_LSR_OE
) == 0)

415 
	`ây_ö£π_Êù_ch¨
(&
p‹t
->p‹t, 
ch
, 
Êag
);

421 i‡(*
°©us
 & ~
p‹t
->
ign‹e_°©us_mask
 & 
UART_LSR_OE
)

422 
	`ây_ö£π_Êù_ch¨
(&
p‹t
->p‹t, 0, 
TTY_OVERRUN
);

424 *
°©us
 = 
	`sdio_ö
(
p‹t
, 
UART_LSR
);

425 } (*
°©us
 & 
UART_LSR_DR
Ë&& (
max_cou¡
-- > 0));

427 
	`ây_Êù_buf„r_push
(&
p‹t
->port);

428 
	}
}

430 
	$sdio_u¨t_å™smô_ch¨s
(
sdio_u¨t_p‹t
 *
p‹t
)

432 
kfifo
 *
xmô
 = &
p‹t
->
xmô_fifo
;

433 
cou¡
;

434 
ây_°ru˘
 *
ây
;

435 
u8
 
iobuf
[16];

436 
Àn
;

438 i‡(
p‹t
->
x_ch¨
) {

439 
	`sdio_out
(
p‹t
, 
UART_TX
,Ö‹t->
x_ch¨
);

440 
p‹t
->
icou¡
.
tx
++;

441 
p‹t
->
x_ch¨
 = 0;

445 
ây
 = 
	`ây_p‹t_ây_gë
(&
p‹t
->port);

447 i‡(
ây
 =
NULL
 || !
	`kfifo_Àn
(
xmô
) ||

448 
ây
->
°›≥d
 ||Åty->
hw_°›≥d
) {

449 
	`sdio_u¨t_°›_tx
(
p‹t
);

450 
	`ây_kªf_put
(
ây
);

454 
Àn
 = 
	`kfifo_out_locked
(
xmô
, 
iobuf
, 16, &
p‹t
->
wrôe_lock
);

455 
cou¡
 = 0; cou¡ < 
Àn
; count++) {

456 
	`sdio_out
(
p‹t
, 
UART_TX
, 
iobuf
[
cou¡
]);

457 
p‹t
->
icou¡
.
tx
++;

460 
Àn
 = 
	`kfifo_Àn
(
xmô
);

461 i‡(
Àn
 < 
WAKEUP_CHARS
) {

462 
	`ây_wakeup
(
ây
);

463 i‡(
Àn
 == 0)

464 
	`sdio_u¨t_°›_tx
(
p‹t
);

466 
	`ây_kªf_put
(
ây
);

467 
	}
}

469 
	$sdio_u¨t_check_modem_°©us
(
sdio_u¨t_p‹t
 *
p‹t
)

471 
°©us
;

472 
ây_°ru˘
 *
ây
;

474 
°©us
 = 
	`sdio_ö
(
p‹t
, 
UART_MSR
);

476 i‡((
°©us
 & 
UART_MSR_ANY_DELTA
) == 0)

479 i‡(
°©us
 & 
UART_MSR_TERI
)

480 
p‹t
->
icou¡
.
∫g
++;

481 i‡(
°©us
 & 
UART_MSR_DDSR
)

482 
p‹t
->
icou¡
.
d§
++;

483 i‡(
°©us
 & 
UART_MSR_DDCD
) {

484 
p‹t
->
icou¡
.
dcd
++;

486 i‡(
°©us
 & 
UART_MSR_DCD
)

487 
	`wake_up_öãºu±ibÀ
(&
p‹t
->p‹t.
›í_waô
);

490 
	`ây_p‹t_ây_h™gup
(&
p‹t
->p‹t, 
Ál£
);

493 i‡(
°©us
 & 
UART_MSR_DCTS
) {

494 
p‹t
->
icou¡
.
˘s
++;

495 
ây
 = 
	`ây_p‹t_ây_gë
(&
p‹t
->port);

496 i‡(
ây
 && (ây->
ãrmios
.
c_cÊag
 & 
CRTSCTS
)) {

497 
˘s
 = (
°©us
 & 
UART_MSR_CTS
);

498 i‡(
ây
->
hw_°›≥d
) {

499 i‡(
˘s
) {

500 
ây
->
hw_°›≥d
 = 0;

501 
	`sdio_u¨t_°¨t_tx
(
p‹t
);

502 
	`ây_wakeup
(
ây
);

505 i‡(!
˘s
) {

506 
ây
->
hw_°›≥d
 = 1;

507 
	`sdio_u¨t_°›_tx
(
p‹t
);

511 
	`ây_kªf_put
(
ây
);

513 
	}
}

518 
	$sdio_u¨t_úq
(
sdio_func
 *
func
)

520 
sdio_u¨t_p‹t
 *
p‹t
 = 
	`sdio_gë_drvd©a
(
func
);

521 
iú
, 
l§
;

531 i‡(
	`u∆ikñy
(
p‹t
->
ö_sdio_u¨t_úq
 =
cuºít
))

534 
iú
 = 
	`sdio_ö
(
p‹t
, 
UART_IIR
);

535 i‡(
iú
 & 
UART_IIR_NO_INT
)

538 
p‹t
->
ö_sdio_u¨t_úq
 = 
cuºít
;

539 
l§
 = 
	`sdio_ö
(
p‹t
, 
UART_LSR
);

540 i‡(
l§
 & 
UART_LSR_DR
)

541 
	`sdio_u¨t_ª˚ive_ch¨s
(
p‹t
, &
l§
);

542 
	`sdio_u¨t_check_modem_°©us
(
p‹t
);

543 i‡(
l§
 & 
UART_LSR_THRE
)

544 
	`sdio_u¨t_å™smô_ch¨s
(
p‹t
);

545 
p‹t
->
ö_sdio_u¨t_úq
 = 
NULL
;

546 
	}
}

548 
	$u¨t_ˇºõr_øi£d
(
ây_p‹t
 *
ç‹t
)

550 
sdio_u¨t_p‹t
 *
p‹t
 =

551 
	`c⁄èöî_of
(
ç‹t
, 
sdio_u¨t_p‹t
, 
p‹t
);

552 
ªt
 = 
	`sdio_u¨t_˛aim_func
(
p‹t
);

553 i‡(
ªt
)

555 
ªt
 = 
	`sdio_u¨t_gë_m˘æ
(
p‹t
);

556 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

557 i‡(
ªt
 & 
TIOCM_CAR
)

560 
	}
}

571 
	$u¨t_då_πs
(
ây_p‹t
 *
ç‹t
, 
⁄off
)

573 
sdio_u¨t_p‹t
 *
p‹t
 =

574 
	`c⁄èöî_of
(
ç‹t
, 
sdio_u¨t_p‹t
, 
p‹t
);

575 
ªt
 = 
	`sdio_u¨t_˛aim_func
(
p‹t
);

576 i‡(
ªt
)

578 i‡(
⁄off
 == 0)

579 
	`sdio_u¨t_˛ór_m˘æ
(
p‹t
, 
TIOCM_DTR
 | 
TIOCM_RTS
);

581 
	`sdio_u¨t_£t_m˘æ
(
p‹t
, 
TIOCM_DTR
 | 
TIOCM_RTS
);

582 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

583 
	}
}

600 
	$sdio_u¨t_a˘iv©e
(
ây_p‹t
 *
ç‹t
, 
ây_°ru˘
 *
ây
)

602 
sdio_u¨t_p‹t
 *
p‹t
 =

603 
	`c⁄èöî_of
(
ç‹t
, 
sdio_u¨t_p‹t
, 
p‹t
);

604 
ªt
;

610 
	`£t_bô
(
TTY_IO_ERROR
, &
ây
->
Êags
);

612 
	`kfifo_ª£t
(&
p‹t
->
xmô_fifo
);

614 
ªt
 = 
	`sdio_u¨t_˛aim_func
(
p‹t
);

615 i‡(
ªt
)

616  
ªt
;

617 
ªt
 = 
	`sdio_íabÀ_func
(
p‹t
->
func
);

618 i‡(
ªt
)

619 
îr1
;

620 
ªt
 = 
	`sdio_˛aim_úq
(
p‹t
->
func
, 
sdio_u¨t_úq
);

621 i‡(
ªt
)

622 
îr2
;

628 
	`sdio_out
(
p‹t
, 
UART_FCR
, 
UART_FCR_ENABLE_FIFO
);

629 
	`sdio_out
(
p‹t
, 
UART_FCR
, 
UART_FCR_ENABLE_FIFO
 |

630 
UART_FCR_CLEAR_RCVR
 | 
UART_FCR_CLEAR_XMIT
);

631 
	`sdio_out
(
p‹t
, 
UART_FCR
, 0);

636 (Ë
	`sdio_ö
(
p‹t
, 
UART_LSR
);

637 (Ë
	`sdio_ö
(
p‹t
, 
UART_RX
);

638 (Ë
	`sdio_ö
(
p‹t
, 
UART_IIR
);

639 (Ë
	`sdio_ö
(
p‹t
, 
UART_MSR
);

644 
	`sdio_out
(
p‹t
, 
UART_LCR
, 
UART_LCR_WLEN8
);

646 
p‹t
->
õr
 = 
UART_IER_RLSI
|
UART_IER_RDI
|
UART_IER_RTOIE
|
UART_IER_UUE
;

647 
p‹t
->
m˘æ
 = 
TIOCM_OUT2
;

649 
	`sdio_u¨t_ch™ge_•ìd
(
p‹t
, &
ây
->
ãrmios
, 
NULL
);

651 i‡(
ây
->
ãrmios
.
c_cÊag
 & 
CBAUD
)

652 
	`sdio_u¨t_£t_m˘æ
(
p‹t
, 
TIOCM_RTS
 | 
TIOCM_DTR
);

654 i‡(
ây
->
ãrmios
.
c_cÊag
 & 
CRTSCTS
)

655 i‡(!(
	`sdio_u¨t_gë_m˘æ
(
p‹t
Ë& 
TIOCM_CTS
))

656 
ây
->
hw_°›≥d
 = 1;

658 
	`˛ór_bô
(
TTY_IO_ERROR
, &
ây
->
Êags
);

661 
	`sdio_u¨t_úq
(
p‹t
->
func
);

663 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

666 
îr2
:

667 
	`sdio_dißbÀ_func
(
p‹t
->
func
);

668 
îr1
:

669 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

670  
ªt
;

671 
	}
}

683 
	$sdio_u¨t_shutdown
(
ây_p‹t
 *
ç‹t
)

685 
sdio_u¨t_p‹t
 *
p‹t
 =

686 
	`c⁄èöî_of
(
ç‹t
, 
sdio_u¨t_p‹t
, 
p‹t
);

687 
ªt
;

689 
ªt
 = 
	`sdio_u¨t_˛aim_func
(
p‹t
);

690 i‡(
ªt
)

693 
	`sdio_u¨t_°›_rx
(
p‹t
);

696 
	`sdio_ªÀa£_úq
(
p‹t
->
func
);

697 
p‹t
->
õr
 = 0;

698 
	`sdio_out
(
p‹t
, 
UART_IER
, 0);

700 
	`sdio_u¨t_˛ór_m˘æ
(
p‹t
, 
TIOCM_OUT2
);

703 
p‹t
->
l¸
 &~
UART_LCR_SBC
;

704 
	`sdio_out
(
p‹t
, 
UART_LCR
,Ö‹t->
l¸
);

705 
	`sdio_out
(
p‹t
, 
UART_FCR
, 
UART_FCR_ENABLE_FIFO
 |

706 
UART_FCR_CLEAR_RCVR
 |

707 
UART_FCR_CLEAR_XMIT
);

708 
	`sdio_out
(
p‹t
, 
UART_FCR
, 0);

710 
	`sdio_dißbÀ_func
(
p‹t
->
func
);

712 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

713 
	}
}

715 
	$sdio_u¨t_p‹t_de°roy
(
ây_p‹t
 *
ç‹t
)

717 
sdio_u¨t_p‹t
 *
p‹t
 =

718 
	`c⁄èöî_of
(
ç‹t
, 
sdio_u¨t_p‹t
, 
p‹t
);

719 
	`kfifo_‰ì
(&
p‹t
->
xmô_fifo
);

720 
	`k‰ì
(
p‹t
);

721 
	}
}

732 
	$sdio_u¨t_ö°Æl
(
ây_drivî
 *
drivî
, 
ây_°ru˘
 *
ây
)

734 
idx
 = 
ây
->
ödex
;

735 
sdio_u¨t_p‹t
 *
p‹t
 = 
	`sdio_u¨t_p‹t_gë
(
idx
);

736 
ªt
 = 
	`ây_°™d¨d_ö°Æl
(
drivî
, 
ây
);

738 i‡(
ªt
 == 0)

740 
ây
->
drivî_d©a
 = 
p‹t
;

742 
	`sdio_u¨t_p‹t_put
(
p‹t
);

743  
ªt
;

744 
	}
}

754 
	$sdio_u¨t_˛ónup
(
ây_°ru˘
 *
ây
)

756 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

757 
ây
->
drivî_d©a
 = 
NULL
;

758 
	`sdio_u¨t_p‹t_put
(
p‹t
);

759 
	}
}

765 
	$sdio_u¨t_›í
(
ây_°ru˘
 *
ây
, 
fûe
 *
fûp
)

767 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

768  
	`ây_p‹t_›í
(&
p‹t
->p‹t, 
ây
, 
fûp
);

769 
	}
}

771 
	$sdio_u¨t_˛o£
(
ây_°ru˘
 *
ây
, 
fûe
 * 
fûp
)

773 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

774 
	`ây_p‹t_˛o£
(&
p‹t
->p‹t, 
ây
, 
fûp
);

775 
	}
}

777 
	$sdio_u¨t_h™gup
(
ây_°ru˘
 *
ây
)

779 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

780 
	`ây_p‹t_h™gup
(&
p‹t
->port);

781 
	}
}

783 
	$sdio_u¨t_wrôe
(
ây_°ru˘
 *
ây
, c⁄° *
buf
,

784 
cou¡
)

786 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

787 
ªt
;

789 i‡(!
p‹t
->
func
)

790  -
ENODEV
;

792 
ªt
 = 
	`kfifo_ö_locked
(&
p‹t
->
xmô_fifo
, 
buf
, 
cou¡
, &p‹t->
wrôe_lock
);

793 i‡(!(
p‹t
->
õr
 & 
UART_IER_THRI
)) {

794 
îr
 = 
	`sdio_u¨t_˛aim_func
(
p‹t
);

795 i‡(!
îr
) {

796 
	`sdio_u¨t_°¨t_tx
(
p‹t
);

797 
	`sdio_u¨t_úq
(
p‹t
->
func
);

798 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

800 
ªt
 = 
îr
;

803  
ªt
;

804 
	}
}

806 
	$sdio_u¨t_wrôe_room
(
ây_°ru˘
 *
ây
)

808 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

809  
FIFO_SIZE
 - 
	`kfifo_Àn
(&
p‹t
->
xmô_fifo
);

810 
	}
}

812 
	$sdio_u¨t_ch¨s_ö_buf„r
(
ây_°ru˘
 *
ây
)

814 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

815  
	`kfifo_Àn
(&
p‹t
->
xmô_fifo
);

816 
	}
}

818 
	$sdio_u¨t_£nd_xch¨
(
ây_°ru˘
 *
ây
, 
ch
)

820 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

822 
p‹t
->
x_ch¨
 = 
ch
;

823 i‡(
ch
 && !(
p‹t
->
õr
 & 
UART_IER_THRI
)) {

824 i‡(
	`sdio_u¨t_˛aim_func
(
p‹t
) != 0)

826 
	`sdio_u¨t_°¨t_tx
(
p‹t
);

827 
	`sdio_u¨t_úq
(
p‹t
->
func
);

828 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

830 
	}
}

832 
	$sdio_u¨t_thrŸée
(
ây_°ru˘
 *
ây
)

834 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

836 i‡(!
	`I_IXOFF
(
ây
Ë&& !—ty->
ãrmios
.
c_cÊag
 & 
CRTSCTS
))

839 i‡(
	`sdio_u¨t_˛aim_func
(
p‹t
) != 0)

842 i‡(
	`I_IXOFF
(
ây
)) {

843 
p‹t
->
x_ch¨
 = 
	`STOP_CHAR
(
ây
);

844 
	`sdio_u¨t_°¨t_tx
(
p‹t
);

847 i‡(
ây
->
ãrmios
.
c_cÊag
 & 
CRTSCTS
)

848 
	`sdio_u¨t_˛ór_m˘æ
(
p‹t
, 
TIOCM_RTS
);

850 
	`sdio_u¨t_úq
(
p‹t
->
func
);

851 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

852 
	}
}

854 
	$sdio_u¨t_u¡hrŸée
(
ây_°ru˘
 *
ây
)

856 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

858 i‡(!
	`I_IXOFF
(
ây
Ë&& !—ty->
ãrmios
.
c_cÊag
 & 
CRTSCTS
))

861 i‡(
	`sdio_u¨t_˛aim_func
(
p‹t
) != 0)

864 i‡(
	`I_IXOFF
(
ây
)) {

865 i‡(
p‹t
->
x_ch¨
) {

866 
p‹t
->
x_ch¨
 = 0;

868 
p‹t
->
x_ch¨
 = 
	`START_CHAR
(
ây
);

869 
	`sdio_u¨t_°¨t_tx
(
p‹t
);

873 i‡(
ây
->
ãrmios
.
c_cÊag
 & 
CRTSCTS
)

874 
	`sdio_u¨t_£t_m˘æ
(
p‹t
, 
TIOCM_RTS
);

876 
	`sdio_u¨t_úq
(
p‹t
->
func
);

877 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

878 
	}
}

880 
	$sdio_u¨t_£t_ãrmios
(
ây_°ru˘
 *
ây
,

881 
kãrmios
 *
ﬁd_ãrmios
)

883 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

884 
cÊag
 = 
ây
->
ãrmios
.
c_cÊag
;

886 i‡(
	`sdio_u¨t_˛aim_func
(
p‹t
) != 0)

889 
	`sdio_u¨t_ch™ge_•ìd
(
p‹t
, &
ây
->
ãrmios
, 
ﬁd_ãrmios
);

892 i‡((
ﬁd_ãrmios
->
c_cÊag
 & 
CBAUD
Ë&& !(
cÊag
 & CBAUD))

893 
	`sdio_u¨t_˛ór_m˘æ
(
p‹t
, 
TIOCM_RTS
 | 
TIOCM_DTR
);

896 i‡(!(
ﬁd_ãrmios
->
c_cÊag
 & 
CBAUD
Ë&& (
cÊag
 & CBAUD)) {

897 
mask
 = 
TIOCM_DTR
;

898 i‡(!(
cÊag
 & 
CRTSCTS
Ë|| !
	`ã°_bô
(
TTY_THROTTLED
, &
ây
->
Êags
))

899 
mask
 |
TIOCM_RTS
;

900 
	`sdio_u¨t_£t_m˘æ
(
p‹t
, 
mask
);

904 i‡((
ﬁd_ãrmios
->
c_cÊag
 & 
CRTSCTS
Ë&& !(
cÊag
 & CRTSCTS)) {

905 
ây
->
hw_°›≥d
 = 0;

906 
	`sdio_u¨t_°¨t_tx
(
p‹t
);

910 i‡(!(
ﬁd_ãrmios
->
c_cÊag
 & 
CRTSCTS
Ë&& (
cÊag
 & CRTSCTS)) {

911 i‡(!(
	`sdio_u¨t_gë_m˘æ
(
p‹t
Ë& 
TIOCM_CTS
)) {

912 
ây
->
hw_°›≥d
 = 1;

913 
	`sdio_u¨t_°›_tx
(
p‹t
);

917 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

918 
	}
}

920 
	$sdio_u¨t_bªak_˘l
(
ây_°ru˘
 *
ây
, 
bªak_°©e
)

922 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

923 
ªsu…
;

925 
ªsu…
 = 
	`sdio_u¨t_˛aim_func
(
p‹t
);

926 i‡(
ªsu…
 != 0)

927  
ªsu…
;

929 i‡(
bªak_°©e
 == -1)

930 
p‹t
->
l¸
 |
UART_LCR_SBC
;

932 
p‹t
->
l¸
 &~
UART_LCR_SBC
;

933 
	`sdio_out
(
p‹t
, 
UART_LCR
,Ö‹t->
l¸
);

935 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

937 
	}
}

939 
	$sdio_u¨t_tiocmgë
(
ây_°ru˘
 *
ây
)

941 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

942 
ªsu…
;

944 
ªsu…
 = 
	`sdio_u¨t_˛aim_func
(
p‹t
);

945 i‡(!
ªsu…
) {

946 
ªsu…
 = 
p‹t
->
m˘æ
 | 
	`sdio_u¨t_gë_m˘æ
(port);

947 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

950  
ªsu…
;

951 
	}
}

953 
	$sdio_u¨t_tiocm£t
(
ây_°ru˘
 *
ây
,

954 
£t
, 
˛ór
)

956 
sdio_u¨t_p‹t
 *
p‹t
 = 
ây
->
drivî_d©a
;

957 
ªsu…
;

959 
ªsu…
 = 
	`sdio_u¨t_˛aim_func
(
p‹t
);

960 i‡(!
ªsu…
) {

961 
	`sdio_u¨t_upd©e_m˘æ
(
p‹t
, 
£t
, 
˛ór
);

962 
	`sdio_u¨t_ªÀa£_func
(
p‹t
);

965  
ªsu…
;

966 
	}
}

968 
	$sdio_u¨t_¥oc_show
(
£q_fûe
 *
m
, *
v
)

970 
i
;

972 
	`£q_¥ötf
(
m
, "serinfo:1.0 driver%s%sÑevision:%s\n",

974 
i
 = 0; i < 
UART_NR
; i++) {

975 
sdio_u¨t_p‹t
 *
p‹t
 = 
	`sdio_u¨t_p‹t_gë
(
i
);

976 i‡(
p‹t
) {

977 
	`£q_¥ötf
(
m
, "%d: u¨t:SDIO", 
i
);

978 i‡(
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

979 
	`£q_¥ötf
(
m
, "Åx:%dÑx:%d",

980 
p‹t
->
icou¡
.
tx
,Ö‹t->icou¡.
rx
);

981 i‡(
p‹t
->
icou¡
.
‰ame
)

982 
	`£q_¥ötf
(
m
, " fe:%d",

983 
p‹t
->
icou¡
.
‰ame
);

984 i‡(
p‹t
->
icou¡
.
∑rôy
)

985 
	`£q_¥ötf
(
m
, "Öe:%d",

986 
p‹t
->
icou¡
.
∑rôy
);

987 i‡(
p‹t
->
icou¡
.
brk
)

988 
	`£q_¥ötf
(
m
, " brk:%d",

989 
p‹t
->
icou¡
.
brk
);

990 i‡(
p‹t
->
icou¡
.
ovîrun
)

991 
	`£q_¥ötf
(
m
, " oe:%d",

992 
p‹t
->
icou¡
.
ovîrun
);

993 i‡(
p‹t
->
icou¡
.
˘s
)

994 
	`£q_¥ötf
(
m
, " cts:%d",

995 
p‹t
->
icou¡
.
˘s
);

996 i‡(
p‹t
->
icou¡
.
d§
)

997 
	`£q_¥ötf
(
m
, " dsr:%d",

998 
p‹t
->
icou¡
.
d§
);

999 i‡(
p‹t
->
icou¡
.
∫g
)

1000 
	`£q_¥ötf
(
m
, "Ñng:%d",

1001 
p‹t
->
icou¡
.
∫g
);

1002 i‡(
p‹t
->
icou¡
.
dcd
)

1003 
	`£q_¥ötf
(
m
, " dcd:%d",

1004 
p‹t
->
icou¡
.
dcd
);

1006 
	`sdio_u¨t_p‹t_put
(
p‹t
);

1007 
	`£q_putc
(
m
, '\n');

1011 
	}
}

1013 
	$sdio_u¨t_¥oc_›í
(
öode
 *öode, 
fûe
 *file)

1015  
	`sögÀ_›í
(
fûe
, 
sdio_u¨t_¥oc_show
, 
NULL
);

1016 
	}
}

1018 c⁄° 
fûe_›î©i⁄s
 
	gsdio_u¨t_¥oc_f›s
 = {

1019 .
ow√r
 = 
THIS_MODULE
,

1020 .
	g›í
 = 
sdio_u¨t_¥oc_›í
,

1021 .
	gªad
 = 
£q_ªad
,

1022 .
	gŒ£ek
 = 
£q_l£ek
,

1023 .
	gªÀa£
 = 
sögÀ_ªÀa£
,

1026 c⁄° 
ây_p‹t_›î©i⁄s
 
	gsdio_u¨t_p‹t_›s
 = {

1027 .
då_πs
 = 
u¨t_då_πs
,

1028 .
	gˇºõr_øi£d
 = 
u¨t_ˇºõr_øi£d
,

1029 .
	gshutdown
 = 
sdio_u¨t_shutdown
,

1030 .
	ga˘iv©e
 = 
sdio_u¨t_a˘iv©e
,

1031 .
	gde°ru˘
 = 
sdio_u¨t_p‹t_de°roy
,

1034 c⁄° 
ây_›î©i⁄s
 
	gsdio_u¨t_›s
 = {

1035 .
›í
 = 
sdio_u¨t_›í
,

1036 .
	g˛o£
 = 
sdio_u¨t_˛o£
,

1037 .
	gwrôe
 = 
sdio_u¨t_wrôe
,

1038 .
	gwrôe_room
 = 
sdio_u¨t_wrôe_room
,

1039 .
	gch¨s_ö_buf„r
 = 
sdio_u¨t_ch¨s_ö_buf„r
,

1040 .
	g£nd_xch¨
 = 
sdio_u¨t_£nd_xch¨
,

1041 .
	gthrŸée
 = 
sdio_u¨t_thrŸée
,

1042 .
	gu¡hrŸée
 = 
sdio_u¨t_u¡hrŸée
,

1043 .
	g£t_ãrmios
 = 
sdio_u¨t_£t_ãrmios
,

1044 .
	gh™gup
 = 
sdio_u¨t_h™gup
,

1045 .
	gbªak_˘l
 = 
sdio_u¨t_bªak_˘l
,

1046 .
	gtiocmgë
 = 
sdio_u¨t_tiocmgë
,

1047 .
	gtiocm£t
 = 
sdio_u¨t_tiocm£t
,

1048 .
	gö°Æl
 = 
sdio_u¨t_ö°Æl
,

1049 .
	g˛ónup
 = 
sdio_u¨t_˛ónup
,

1050 .
	g¥oc_f›s
 = &
sdio_u¨t_¥oc_f›s
,

1053 
ây_drivî
 *
	gsdio_u¨t_ây_drivî
;

1055 
	$sdio_u¨t_¥obe
(
sdio_func
 *
func
,

1056 c⁄° 
sdio_devi˚_id
 *
id
)

1058 
sdio_u¨t_p‹t
 *
p‹t
;

1059 
ªt
;

1061 
p‹t
 = 
	`kzÆloc
((
sdio_u¨t_p‹t
), 
GFP_KERNEL
);

1062 i‡(!
p‹t
)

1063  -
ENOMEM
;

1065 i‡(
func
->
˛ass
 =
SDIO_CLASS_UART
) {

1066 
	`¥_w¨nög
("%s:Çeed info on UART class basic setup\n",

1067 
	`sdio_func_id
(
func
));

1068 
	`k‰ì
(
p‹t
);

1069  -
ENOSYS
;

1070 } i‡(
func
->
˛ass
 =
SDIO_CLASS_GPS
) {

1075 
sdio_func_tu∂e
 *
çl
;

1076 
çl
 = 
func
->
tu∂es
;Å∂;Å∂ =Å∂->
√xt
) {

1077 i‡(
çl
->
code
 != 0x91)

1079 i‡(
çl
->
size
 < 10)

1081 i‡(
çl
->
d©a
[1] == 0)

1084 i‡(!
çl
) {

1085 
	`¥_w¨nög
(

1087 
	`sdio_func_id
(
func
));

1088 
	`k‰ì
(
p‹t
);

1089  -
EINVAL
;

1091 
	`¥_debug
("%s: Register ID = 0x%02x, Exp ID = 0x%02x\n",

1092 
	`sdio_func_id
(
func
), 
çl
->
d©a
[2],Åpl->data[3]);

1093 
p‹t
->
ªgs_off£t
 = (
çl
->
d©a
[4] << 0) |

1094 (
çl
->
d©a
[5] << 8) |

1095 (
çl
->
d©a
[6] << 16);

1096 
	`¥_debug
("%s:Ñegs offset = 0x%x\n",

1097 
	`sdio_func_id
(
func
), 
p‹t
->
ªgs_off£t
);

1098 
p‹t
->
u¨t˛k
 = 
çl
->
d©a
[7] * 115200;

1099 i‡(
p‹t
->
u¨t˛k
 == 0)

1100 
p‹t
->
u¨t˛k
 = 115200;

1101 
	`¥_debug
("%s: clk %d baudcode %u 4800-div %u\n",

1102 
	`sdio_func_id
(
func
), 
p‹t
->
u¨t˛k
,

1103 
çl
->
d©a
[7],Åpl->data[8] | (tpl->data[9] << 8));

1105 
	`k‰ì
(
p‹t
);

1106  -
EINVAL
;

1109 
p‹t
->
func
 = func;

1110 
	`sdio_£t_drvd©a
(
func
, 
p‹t
);

1111 
	`ây_p‹t_öô
(&
p‹t
->port);

1112 
p‹t
->p‹t.
›s
 = &
sdio_u¨t_p‹t_›s
;

1114 
ªt
 = 
	`sdio_u¨t_add_p‹t
(
p‹t
);

1115 i‡(
ªt
) {

1116 
	`k‰ì
(
p‹t
);

1118 
devi˚
 *
dev
;

1119 
dev
 = 
	`ây_p‹t_ªgi°î_devi˚
(&
p‹t
->port,

1120 
sdio_u¨t_ây_drivî
, 
p‹t
->
ödex
, &
func
->
dev
);

1121 i‡(
	`IS_ERR
(
dev
)) {

1122 
	`sdio_u¨t_p‹t_ªmove
(
p‹t
);

1123 
ªt
 = 
	`PTR_ERR
(
dev
);

1127  
ªt
;

1128 
	}
}

1130 
	$sdio_u¨t_ªmove
(
sdio_func
 *
func
)

1132 
sdio_u¨t_p‹t
 *
p‹t
 = 
	`sdio_gë_drvd©a
(
func
);

1134 
	`ây_uƒegi°î_devi˚
(
sdio_u¨t_ây_drivî
, 
p‹t
->
ödex
);

1135 
	`sdio_u¨t_p‹t_ªmove
(
p‹t
);

1136 
	}
}

1138 c⁄° 
sdio_devi˚_id
 
	gsdio_u¨t_ids
[] = {

1139 { 
SDIO_DEVICE_CLASS
(
SDIO_CLASS_UART
) },

1140 { 
SDIO_DEVICE_CLASS
(
SDIO_CLASS_GPS
) },

1144 
MODULE_DEVICE_TABLE
(
sdio
, 
sdio_u¨t_ids
);

1146 
sdio_drivî
 
	gsdio_u¨t_drivî
 = {

1147 .
¥obe
 = 
sdio_u¨t_¥obe
,

1148 .
	gªmove
 = 
sdio_u¨t_ªmove
,

1149 .
	g«me
 = "sdio_uart",

1150 .
	gid_èbÀ
 = 
sdio_u¨t_ids
,

1153 
__öô
 
	$sdio_u¨t_öô
()

1155 
ªt
;

1156 
ây_drivî
 *
ây_drv
;

1158 
sdio_u¨t_ây_drivî
 = 
ây_drv
 = 
	`Æloc_ây_drivî
(
UART_NR
);

1159 i‡(!
ây_drv
)

1160  -
ENOMEM
;

1162 
ây_drv
->
drivî_«me
 = "sdio_uart";

1163 
ây_drv
->
«me
 = "ttySDIO";

1164 
ây_drv
->
maj‹
 = 0;

1165 
ây_drv
->
mö‹_°¨t
 = 0;

1166 
ây_drv
->
ty≥
 = 
TTY_DRIVER_TYPE_SERIAL
;

1167 
ây_drv
->
subty≥
 = 
SERIAL_TYPE_NORMAL
;

1168 
ây_drv
->
Êags
 = 
TTY_DRIVER_REAL_RAW
 | 
TTY_DRIVER_DYNAMIC_DEV
;

1169 
ây_drv
->
öô_ãrmios
 = 
ây_°d_ãrmios
;

1170 
ây_drv
->
öô_ãrmios
.
c_cÊag
 = 
B4800
 | 
CS8
 | 
CREAD
 | 
HUPCL
 | 
CLOCAL
;

1171 
ây_drv
->
öô_ãrmios
.
c_i•ìd
 = 4800;

1172 
ây_drv
->
öô_ãrmios
.
c_o•ìd
 = 4800;

1173 
	`ây_£t_›î©i⁄s
(
ây_drv
, &
sdio_u¨t_›s
);

1175 
ªt
 = 
	`ây_ªgi°î_drivî
(
ây_drv
);

1176 i‡(
ªt
)

1177 
îr1
;

1179 
ªt
 = 
	`sdio_ªgi°î_drivî
(&
sdio_u¨t_drivî
);

1180 i‡(
ªt
)

1181 
îr2
;

1185 
îr2
:

1186 
	`ây_uƒegi°î_drivî
(
ây_drv
);

1187 
îr1
:

1188 
	`put_ây_drivî
(
ây_drv
);

1189  
ªt
;

1190 
	}
}

1192 
__exô
 
	$sdio_u¨t_exô
()

1194 
	`sdio_uƒegi°î_drivî
(&
sdio_u¨t_drivî
);

1195 
	`ây_uƒegi°î_drivî
(
sdio_u¨t_ây_drivî
);

1196 
	`put_ây_drivî
(
sdio_u¨t_ây_drivî
);

1197 
	}
}

1199 
moduÀ_öô
(
sdio_u¨t_öô
);

1200 
moduÀ_exô
(
sdio_u¨t_exô
);

1202 
MODULE_AUTHOR
("Nicolas Pitre");

1203 
MODULE_LICENSE
("GPL");

	@/usr/include/linux/capability.h

13 #i‚de‡
_LINUX_CAPABILITY_H


14 
	#_LINUX_CAPABILITY_H


	)

16 
	~<löux/ty≥s.h
>

18 
	gèsk_°ru˘
;

31 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

32 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

34 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

35 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

37 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

38 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

40 
	s__u£r_ˇp_hódî_°ru˘
 {

41 
__u32
 
	mvîsi⁄
;

42 
	mpid
;

43 } *
	tˇp_u£r_hódî_t
;

45 
	s__u£r_ˇp_d©a_°ru˘
 {

46 
__u32
 
	mef„˘ive
;

47 
__u32
 
	m≥rmôãd
;

48 
__u32
 
	möhîôabÀ
;

49 } *
	tˇp_u£r_d©a_t
;

52 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

53 
	#VFS_CAP_REVISION_SHIFT
 24

	)

54 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

55 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

57 
	#VFS_CAP_REVISION_1
 0x01000000

	)

58 
	#VFS_CAP_U32_1
 1

	)

59 
	#XATTR_CAPS_SZ_1
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

61 
	#VFS_CAP_REVISION_2
 0x02000000

	)

62 
	#VFS_CAP_U32_2
 2

	)

63 
	#XATTR_CAPS_SZ_2
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

65 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_2


	)

66 
	#VFS_CAP_U32
 
VFS_CAP_U32_2


	)

67 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_2


	)

69 
	svfs_ˇp_d©a
 {

70 
__À32
 
	mmagic_ëc
;

72 
__À32
 
	m≥rmôãd
;

73 
__À32
 
	möhîôabÀ
;

74 } 
	md©a
[
VFS_CAP_U32
];

83 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

84 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

96 
	#CAP_CHOWN
 0

	)

102 
	#CAP_DAC_OVERRIDE
 1

	)

108 
	#CAP_DAC_READ_SEARCH
 2

	)

114 
	#CAP_FOWNER
 3

	)

123 
	#CAP_FSETID
 4

	)

129 
	#CAP_KILL
 5

	)

135 
	#CAP_SETGID
 6

	)

140 
	#CAP_SETUID
 7

	)

157 
	#CAP_SETPCAP
 8

	)

161 
	#CAP_LINUX_IMMUTABLE
 9

	)

166 
	#CAP_NET_BIND_SERVICE
 10

	)

170 
	#CAP_NET_BROADCAST
 11

	)

186 
	#CAP_NET_ADMIN
 12

	)

192 
	#CAP_NET_RAW
 13

	)

198 
	#CAP_IPC_LOCK
 14

	)

202 
	#CAP_IPC_OWNER
 15

	)

205 
	#CAP_SYS_MODULE
 16

	)

210 
	#CAP_SYS_RAWIO
 17

	)

214 
	#CAP_SYS_CHROOT
 18

	)

218 
	#CAP_SYS_PTRACE
 19

	)

222 
	#CAP_SYS_PACCT
 20

	)

261 
	#CAP_SYS_ADMIN
 21

	)

265 
	#CAP_SYS_BOOT
 22

	)

274 
	#CAP_SYS_NICE
 23

	)

288 
	#CAP_SYS_RESOURCE
 24

	)

294 
	#CAP_SYS_TIME
 25

	)

299 
	#CAP_SYS_TTY_CONFIG
 26

	)

303 
	#CAP_MKNOD
 27

	)

307 
	#CAP_LEASE
 28

	)

311 
	#CAP_AUDIT_WRITE
 29

	)

315 
	#CAP_AUDIT_CONTROL
 30

	)

317 
	#CAP_SETFCAP
 31

	)

325 
	#CAP_MAC_OVERRIDE
 32

	)

334 
	#CAP_MAC_ADMIN
 33

	)

338 
	#CAP_SYSLOG
 34

	)

342 
	#CAP_WAKE_ALARM
 35

	)

346 
	#CAP_BLOCK_SUSPEND
 36

	)

350 
	#CAP_AUDIT_READ
 37

	)

353 
	#CAP_LAST_CAP
 
CAP_AUDIT_READ


	)

355 
	#ˇp_vÆid
(
x
Ë((xË>0 && (xË<
CAP_LAST_CAP
)

	)

361 
	#CAP_TO_INDEX
(
x
Ë((xË>> 5Ë

	)

362 
	#CAP_TO_MASK
(
x
Ë(1 << ((xË& 31)Ë

	)

	@/usr/include/linux/errno.h

1 
	~<asm/î∫o.h
>

	@/usr/include/linux/fs.h

1 #i‚de‡
_LINUX_FS_H


2 
	#_LINUX_FS_H


	)

9 
	~<löux/limôs.h
>

10 
	~<löux/io˘l.h
>

11 
	~<löux/ty≥s.h
>

24 #unde‡
NR_OPEN


25 
	#INR_OPEN_CUR
 1024

	)

26 
	#INR_OPEN_MAX
 4096

	)

28 
	#BLOCK_SIZE_BITS
 10

	)

29 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

31 
	#SEEK_SET
 0

	)

32 
	#SEEK_CUR
 1

	)

33 
	#SEEK_END
 2

	)

34 
	#SEEK_DATA
 3

	)

35 
	#SEEK_HOLE
 4

	)

36 
	#SEEK_MAX
 
SEEK_HOLE


	)

38 
	#RENAME_NOREPLACE
 (1 << 0Ë

	)

39 
	#RENAME_EXCHANGE
 (1 << 1Ë

	)

40 
	#RENAME_WHITEOUT
 (1 << 2Ë

	)

42 
	sf°rim_ønge
 {

43 
__u64
 
	m°¨t
;

44 
__u64
 
	mÀn
;

45 
__u64
 
	mmöÀn
;

49 
	sfûes_°©_°ru˘
 {

50 
	mƒ_fûes
;

51 
	mƒ_‰ì_fûes
;

52 
	mmax_fûes
;

55 
	söodes_°©_t
 {

56 
	mƒ_öodes
;

57 
	mƒ_unu£d
;

58 
	mdummy
[5];

62 
	#NR_FILE
 8192

	)

68 
	#MS_RDONLY
 1

	)

69 
	#MS_NOSUID
 2

	)

70 
	#MS_NODEV
 4

	)

71 
	#MS_NOEXEC
 8

	)

72 
	#MS_SYNCHRONOUS
 16

	)

73 
	#MS_REMOUNT
 32

	)

74 
	#MS_MANDLOCK
 64

	)

75 
	#MS_DIRSYNC
 128

	)

76 
	#MS_NOATIME
 1024

	)

77 
	#MS_NODIRATIME
 2048

	)

78 
	#MS_BIND
 4096

	)

79 
	#MS_MOVE
 8192

	)

80 
	#MS_REC
 16384

	)

81 
	#MS_VERBOSE
 32768

	)

83 
	#MS_SILENT
 32768

	)

84 
	#MS_POSIXACL
 (1<<16Ë

	)

85 
	#MS_UNBINDABLE
 (1<<17Ë

	)

86 
	#MS_PRIVATE
 (1<<18Ë

	)

87 
	#MS_SLAVE
 (1<<19Ë

	)

88 
	#MS_SHARED
 (1<<20Ë

	)

89 
	#MS_RELATIME
 (1<<21Ë

	)

90 
	#MS_KERNMOUNT
 (1<<22Ë

	)

91 
	#MS_I_VERSION
 (1<<23Ë

	)

92 
	#MS_STRICTATIME
 (1<<24Ë

	)

93 
	#MS_LAZYTIME
 (1<<25Ë

	)

96 
	#MS_SUBMOUNT
 (1<<26)

	)

97 
	#MS_NOSEC
 (1<<28)

	)

98 
	#MS_BORN
 (1<<29)

	)

99 
	#MS_ACTIVE
 (1<<30)

	)

100 
	#MS_NOUSER
 (1<<31)

	)

105 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

106 
MS_LAZYTIME
)

	)

111 
	#MS_MGC_VAL
 0xC0ED0000

	)

112 
	#MS_MGC_MSK
 0xffff0000

	)

117 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

118 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

119 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

120 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

121 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

122 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

123 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

124 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

125 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

126 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

127 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

128 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

130 
	#BLKPG
 
	`_IO
(0x12,105)

	)

134 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

135 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

140 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

141 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

142 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

143 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

144 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

145 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

146 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

147 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

148 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

149 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

150 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

151 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

152 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

153 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

154 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

155 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

157 
	#BMAP_IOCTL
 1

	)

158 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

159 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

160 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

161 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

162 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

164 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

165 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

166 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

167 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

168 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

169 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

170 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

171 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

172 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

177 
	#FS_SECRM_FL
 0x00000001

	)

178 
	#FS_UNRM_FL
 0x00000002

	)

179 
	#FS_COMPR_FL
 0x00000004

	)

180 
	#FS_SYNC_FL
 0x00000008

	)

181 
	#FS_IMMUTABLE_FL
 0x00000010

	)

182 
	#FS_APPEND_FL
 0x00000020

	)

183 
	#FS_NODUMP_FL
 0x00000040

	)

184 
	#FS_NOATIME_FL
 0x00000080

	)

186 
	#FS_DIRTY_FL
 0x00000100

	)

187 
	#FS_COMPRBLK_FL
 0x00000200

	)

188 
	#FS_NOCOMP_FL
 0x00000400

	)

189 
	#FS_ECOMPR_FL
 0x00000800

	)

191 
	#FS_BTREE_FL
 0x00001000

	)

192 
	#FS_INDEX_FL
 0x00001000

	)

193 
	#FS_IMAGIC_FL
 0x00002000

	)

194 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

195 
	#FS_NOTAIL_FL
 0x00008000

	)

196 
	#FS_DIRSYNC_FL
 0x00010000

	)

197 
	#FS_TOPDIR_FL
 0x00020000

	)

198 
	#FS_EXTENT_FL
 0x00080000

	)

199 
	#FS_DIRECTIO_FL
 0x00100000

	)

200 
	#FS_NOCOW_FL
 0x00800000

	)

201 
	#FS_PROJINHERIT_FL
 0x20000000

	)

202 
	#FS_RESERVED_FL
 0x80000000

	)

204 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

205 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

208 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

209 
	#SYNC_FILE_RANGE_WRITE
 2

	)

210 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

	@/usr/include/linux/hdreg.h

1 #i‚de‡
_LINUX_HDREG_H


2 
	#_LINUX_HDREG_H


	)

4 
	~<löux/ty≥s.h
>

10 
	#HDIO_DRIVE_CMD_HDR_SIZE
 (4 * (
__u8
))

	)

11 
	#HDIO_DRIVE_HOB_HDR_SIZE
 (8 * (
__u8
))

	)

12 
	#HDIO_DRIVE_TASK_HDR_SIZE
 (8 * (
__u8
))

	)

14 
	#IDE_DRIVE_TASK_NO_DATA
 0

	)

15 
	#IDE_DRIVE_TASK_INVALID
 -1

	)

16 
	#IDE_DRIVE_TASK_SET_XFER
 1

	)

17 
	#IDE_DRIVE_TASK_IN
 2

	)

18 
	#IDE_DRIVE_TASK_OUT
 3

	)

19 
	#IDE_DRIVE_TASK_RAW_WRITE
 4

	)

24 
	#IDE_TASKFILE_STD_IN_FLAGS
 0xFE

	)

25 
	#IDE_HOB_STD_IN_FLAGS
 0x3C

	)

26 
	#IDE_TASKFILE_STD_OUT_FLAGS
 0xFE

	)

27 
	#IDE_HOB_STD_OUT_FLAGS
 0x3C

	)

29 
	tèsk_i‹eg_t
;

30 
	tßè_i‹eg_t
;

32 
	uide_ªg_vÆid_s
 {

33 
	mÆl
 : 16;

35 
	md©a
 : 1;

36 
	mîr‹_„©uª
 : 1;

37 
	m£˘‹
 : 1;

38 
	mn£˘‹
 : 1;

39 
	mlcyl
 : 1;

40 
	mhcyl
 : 1;

41 
	m£À˘
 : 1;

42 
	m°©us_comm™d
 : 1;

44 
	md©a_hob
 : 1;

45 
	mîr‹_„©uª_hob
 : 1;

46 
	m£˘‹_hob
 : 1;

47 
	mn£˘‹_hob
 : 1;

48 
	mlcyl_hob
 : 1;

49 
	mhcyl_hob
 : 1;

50 
	m£À˘_hob
 : 1;

51 
	mc⁄åﬁ_hob
 : 1;

52 } 
	mb
;

53 } 
	tide_ªg_vÆid_t
;

55 
	side_èsk_ªque°_s
 {

56 
__u8
 
	mio_p‹ts
[8];

57 
__u8
 
	mhob_p‹ts
[8];

58 
ide_ªg_vÆid_t
 
	mout_Êags
;

59 
ide_ªg_vÆid_t
 
	mö_Êags
;

60 
	md©a_pha£
;

61 
	mªq_cmd
;

62 
	mout_size
;

63 
	mö_size
;

64 } 
	tide_èsk_ªque°_t
;

66 
	side_io˘l_ªque°_s
 {

67 
ide_èsk_ªque°_t
 *
	mèsk_ªque°
;

68 *
	mout_buf„r
;

69 *
	mö_buf„r
;

70 } 
	tide_io˘l_ªque°_t
;

72 
	shd_drive_cmd_hdr
 {

73 
__u8
 
	mcomm™d
;

74 
__u8
 
	m£˘‹_numbî
;

75 
__u8
 
	m„©uª
;

76 
__u8
 
	m£˘‹_cou¡
;

79 
	shd_drive_èsk_hdr
 {

80 
__u8
 
	md©a
;

81 
__u8
 
	m„©uª
;

82 
__u8
 
	m£˘‹_cou¡
;

83 
__u8
 
	m£˘‹_numbî
;

84 
__u8
 
	mlow_cylödî
;

85 
__u8
 
	mhigh_cylödî
;

86 
__u8
 
	mdevi˚_hód
;

87 
__u8
 
	mcomm™d
;

88 } 
	tèsk_°ru˘_t
;

90 
	shd_drive_hob_hdr
 {

91 
__u8
 
	md©a
;

92 
__u8
 
	m„©uª
;

93 
__u8
 
	m£˘‹_cou¡
;

94 
__u8
 
	m£˘‹_numbî
;

95 
__u8
 
	mlow_cylödî
;

96 
__u8
 
	mhigh_cylödî
;

97 
__u8
 
	mdevi˚_hód
;

98 
__u8
 
	mc⁄åﬁ
;

99 } 
	thob_°ru˘_t
;

101 
	#TASKFILE_NO_DATA
 0x0000

	)

103 
	#TASKFILE_IN
 0x0001

	)

104 
	#TASKFILE_MULTI_IN
 0x0002

	)

106 
	#TASKFILE_OUT
 0x0004

	)

107 
	#TASKFILE_MULTI_OUT
 0x0008

	)

108 
	#TASKFILE_IN_OUT
 0x0010

	)

110 
	#TASKFILE_IN_DMA
 0x0020

	)

111 
	#TASKFILE_OUT_DMA
 0x0040

	)

112 
	#TASKFILE_IN_DMAQ
 0x0080

	)

113 
	#TASKFILE_OUT_DMAQ
 0x0100

	)

115 
	#TASKFILE_P_IN
 0x0200

	)

116 
	#TASKFILE_P_OUT
 0x0400

	)

117 
	#TASKFILE_P_IN_DMA
 0x0800

	)

118 
	#TASKFILE_P_OUT_DMA
 0x1000

	)

119 
	#TASKFILE_P_IN_DMAQ
 0x2000

	)

120 
	#TASKFILE_P_OUT_DMAQ
 0x4000

	)

121 
	#TASKFILE_48
 0x8000

	)

122 
	#TASKFILE_INVALID
 0x7fff

	)

125 
	#WIN_NOP
 0x00

	)

129 
	#CFA_REQ_EXT_ERROR_CODE
 0x03

	)

133 
	#WIN_SRST
 0x08

	)

134 
	#WIN_DEVICE_RESET
 0x08

	)

138 
	#WIN_RECAL
 0x10

	)

139 
	#WIN_RESTORE
 
WIN_RECAL


	)

143 
	#WIN_READ
 0x20

	)

144 
	#WIN_READ_ONCE
 0x21

	)

145 
	#WIN_READ_LONG
 0x22

	)

146 
	#WIN_READ_LONG_ONCE
 0x23

	)

147 
	#WIN_READ_EXT
 0x24

	)

148 
	#WIN_READDMA_EXT
 0x25

	)

149 
	#WIN_READDMA_QUEUED_EXT
 0x26

	)

150 
	#WIN_READ_NATIVE_MAX_EXT
 0x27

	)

154 
	#WIN_MULTREAD_EXT
 0x29

	)

158 
	#WIN_WRITE
 0x30

	)

159 
	#WIN_WRITE_ONCE
 0x31

	)

160 
	#WIN_WRITE_LONG
 0x32

	)

161 
	#WIN_WRITE_LONG_ONCE
 0x33

	)

162 
	#WIN_WRITE_EXT
 0x34

	)

163 
	#WIN_WRITEDMA_EXT
 0x35

	)

164 
	#WIN_WRITEDMA_QUEUED_EXT
 0x36

	)

165 
	#WIN_SET_MAX_EXT
 0x37

	)

166 
	#CFA_WRITE_SECT_WO_ERASE
 0x38

	)

167 
	#WIN_MULTWRITE_EXT
 0x39

	)

171 
	#WIN_WRITE_VERIFY
 0x3C

	)

175 
	#WIN_VERIFY
 0x40

	)

176 
	#WIN_VERIFY_ONCE
 0x41

	)

177 
	#WIN_VERIFY_EXT
 0x42

	)

181 
	#WIN_FORMAT
 0x50

	)

185 
	#WIN_INIT
 0x60

	)

189 
	#WIN_SEEK
 0x70

	)

191 
	#CFA_TRANSLATE_SECTOR
 0x87

	)

192 
	#WIN_DIAGNOSE
 0x90

	)

193 
	#WIN_SPECIFY
 0x91

	)

194 
	#WIN_DOWNLOAD_MICROCODE
 0x92

	)

195 
	#WIN_STANDBYNOW2
 0x94

	)

196 
	#WIN_STANDBY2
 0x96

	)

197 
	#WIN_SETIDLE2
 0x97

	)

198 
	#WIN_CHECKPOWERMODE2
 0x98

	)

199 
	#WIN_SLEEPNOW2
 0x99

	)

203 
	#WIN_PACKETCMD
 0xA0

	)

204 
	#WIN_PIDENTIFY
 0xA1

	)

205 
	#WIN_QUEUED_SERVICE
 0xA2

	)

206 
	#WIN_SMART
 0xB0

	)

207 
	#CFA_ERASE_SECTORS
 0xC0

	)

208 
	#WIN_MULTREAD
 0xC4

	)

209 
	#WIN_MULTWRITE
 0xC5

	)

210 
	#WIN_SETMULT
 0xC6

	)

211 
	#WIN_READDMA_QUEUED
 0xC7

	)

212 
	#WIN_READDMA
 0xC8

	)

213 
	#WIN_READDMA_ONCE
 0xC9

	)

214 
	#WIN_WRITEDMA
 0xCA

	)

215 
	#WIN_WRITEDMA_ONCE
 0xCB

	)

216 
	#WIN_WRITEDMA_QUEUED
 0xCC

	)

217 
	#CFA_WRITE_MULTI_WO_ERASE
 0xCD

	)

218 
	#WIN_GETMEDIASTATUS
 0xDA

	)

219 
	#WIN_ACKMEDIACHANGE
 0xDB

	)

220 
	#WIN_POSTBOOT
 0xDC

	)

221 
	#WIN_PREBOOT
 0xDD

	)

222 
	#WIN_DOORLOCK
 0xDE

	)

223 
	#WIN_DOORUNLOCK
 0xDF

	)

224 
	#WIN_STANDBYNOW1
 0xE0

	)

225 
	#WIN_IDLEIMMEDIATE
 0xE1

	)

226 
	#WIN_STANDBY
 0xE2

	)

227 
	#WIN_SETIDLE1
 0xE3

	)

228 
	#WIN_READ_BUFFER
 0xE4

	)

229 
	#WIN_CHECKPOWERMODE1
 0xE5

	)

230 
	#WIN_SLEEPNOW1
 0xE6

	)

231 
	#WIN_FLUSH_CACHE
 0xE7

	)

232 
	#WIN_WRITE_BUFFER
 0xE8

	)

233 
	#WIN_WRITE_SAME
 0xE9

	)

235 
	#WIN_FLUSH_CACHE_EXT
 0xEA

	)

236 
	#WIN_IDENTIFY
 0xEC

	)

237 
	#WIN_MEDIAEJECT
 0xED

	)

238 
	#WIN_IDENTIFY_DMA
 0xEE

	)

239 
	#WIN_SETFEATURES
 0xEF

	)

240 
	#EXABYTE_ENABLE_NEST
 0xF0

	)

241 
	#WIN_SECURITY_SET_PASS
 0xF1

	)

242 
	#WIN_SECURITY_UNLOCK
 0xF2

	)

243 
	#WIN_SECURITY_ERASE_PREPARE
 0xF3

	)

244 
	#WIN_SECURITY_ERASE_UNIT
 0xF4

	)

245 
	#WIN_SECURITY_FREEZE_LOCK
 0xF5

	)

246 
	#WIN_SECURITY_DISABLE
 0xF6

	)

247 
	#WIN_READ_NATIVE_MAX
 0xF8

	)

248 
	#WIN_SET_MAX
 0xF9

	)

249 
	#DISABLE_SEAGATE
 0xFB

	)

253 
	#SMART_READ_VALUES
 0xD0

	)

254 
	#SMART_READ_THRESHOLDS
 0xD1

	)

255 
	#SMART_AUTOSAVE
 0xD2

	)

256 
	#SMART_SAVE
 0xD3

	)

257 
	#SMART_IMMEDIATE_OFFLINE
 0xD4

	)

258 
	#SMART_READ_LOG_SECTOR
 0xD5

	)

259 
	#SMART_WRITE_LOG_SECTOR
 0xD6

	)

260 
	#SMART_WRITE_THRESHOLDS
 0xD7

	)

261 
	#SMART_ENABLE
 0xD8

	)

262 
	#SMART_DISABLE
 0xD9

	)

263 
	#SMART_STATUS
 0xDA

	)

264 
	#SMART_AUTO_OFFLINE
 0xDB

	)

268 
	#SMART_LCYL_PASS
 0x4F

	)

269 
	#SMART_HCYL_PASS
 0xC2

	)

272 
	#SETFEATURES_EN_8BIT
 0x01

	)

273 
	#SETFEATURES_EN_WCACHE
 0x02

	)

274 
	#SETFEATURES_DIS_DEFECT
 0x04

	)

275 
	#SETFEATURES_EN_APM
 0x05

	)

276 
	#SETFEATURES_EN_SAME_R
 0x22

	)

277 
	#SETFEATURES_DIS_MSN
 0x31

	)

278 
	#SETFEATURES_DIS_RETRY
 0x33

	)

279 
	#SETFEATURES_EN_AAM
 0x42

	)

280 
	#SETFEATURES_RW_LONG
 0x44

	)

281 
	#SETFEATURES_SET_CACHE
 0x54

	)

282 
	#SETFEATURES_DIS_RLA
 0x55

	)

283 
	#SETFEATURES_EN_RI
 0x5D

	)

284 
	#SETFEATURES_EN_SI
 0x5E

	)

285 
	#SETFEATURES_DIS_RPOD
 0x66

	)

286 
	#SETFEATURES_DIS_ECC
 0x77

	)

287 
	#SETFEATURES_DIS_8BIT
 0x81

	)

288 
	#SETFEATURES_DIS_WCACHE
 0x82

	)

289 
	#SETFEATURES_EN_DEFECT
 0x84

	)

290 
	#SETFEATURES_DIS_APM
 0x85

	)

291 
	#SETFEATURES_EN_ECC
 0x88

	)

292 
	#SETFEATURES_EN_MSN
 0x95

	)

293 
	#SETFEATURES_EN_RETRY
 0x99

	)

294 
	#SETFEATURES_EN_RLA
 0xAA

	)

295 
	#SETFEATURES_PREFETCH
 0xAB

	)

296 
	#SETFEATURES_EN_REST
 0xAC

	)

297 
	#SETFEATURES_4B_RW_LONG
 0xBB

	)

298 
	#SETFEATURES_DIS_AAM
 0xC2

	)

299 
	#SETFEATURES_EN_RPOD
 0xCC

	)

300 
	#SETFEATURES_DIS_RI
 0xDD

	)

301 
	#SETFEATURES_EN_SAME_M
 0xDD

	)

302 
	#SETFEATURES_DIS_SI
 0xDE

	)

306 
	#SECURITY_SET_PASSWORD
 0xBA

	)

307 
	#SECURITY_UNLOCK
 0xBB

	)

308 
	#SECURITY_ERASE_PREPARE
 0xBC

	)

309 
	#SECURITY_ERASE_UNIT
 0xBD

	)

310 
	#SECURITY_FREEZE_LOCK
 0xBE

	)

311 
	#SECURITY_DISABLE_PASSWORD
 0xBF

	)

313 
	shd_geomëry
 {

314 
	mhóds
;

315 
	m£˘‹s
;

316 
	mcylödîs
;

317 
	m°¨t
;

321 
	#HDIO_GETGEO
 0x0301

	)

322 
	#HDIO_GET_UNMASKINTR
 0x0302

	)

323 
	#HDIO_GET_MULTCOUNT
 0x0304

	)

324 
	#HDIO_GET_QDMA
 0x0305

	)

326 
	#HDIO_SET_XFER
 0x0306

	)

328 
	#HDIO_OBSOLETE_IDENTITY
 0x0307

	)

329 
	#HDIO_GET_KEEPSETTINGS
 0x0308

	)

330 
	#HDIO_GET_32BIT
 0x0309

	)

331 
	#HDIO_GET_NOWERR
 0x030®

	)

332 
	#HDIO_GET_DMA
 0x030b

	)

333 
	#HDIO_GET_NICE
 0x030¯

	)

334 
	#HDIO_GET_IDENTITY
 0x030d

	)

335 
	#HDIO_GET_WCACHE
 0x030ê

	)

336 
	#HDIO_GET_ACOUSTIC
 0x030‡

	)

337 
	#HDIO_GET_ADDRESS
 0x0310

	)

339 
	#HDIO_GET_BUSSTATE
 0x031®

	)

340 
	#HDIO_TRISTATE_HWIF
 0x031b

	)

341 
	#HDIO_DRIVE_RESET
 0x031¯

	)

342 
	#HDIO_DRIVE_TASKFILE
 0x031d

	)

343 
	#HDIO_DRIVE_TASK
 0x031ê

	)

344 
	#HDIO_DRIVE_CMD
 0x031‡

	)

345 
	#HDIO_DRIVE_CMD_AEB
 
HDIO_DRIVE_TASK


	)

348 
	#HDIO_SET_MULTCOUNT
 0x0321

	)

349 
	#HDIO_SET_UNMASKINTR
 0x0322

	)

350 
	#HDIO_SET_KEEPSETTINGS
 0x0323

	)

351 
	#HDIO_SET_32BIT
 0x0324

	)

352 
	#HDIO_SET_NOWERR
 0x0325

	)

353 
	#HDIO_SET_DMA
 0x0326

	)

354 
	#HDIO_SET_PIO_MODE
 0x0327

	)

355 
	#HDIO_SCAN_HWIF
 0x0328

	)

356 
	#HDIO_UNREGISTER_HWIF
 0x032®

	)

357 
	#HDIO_SET_NICE
 0x0329

	)

358 
	#HDIO_SET_WCACHE
 0x032b

	)

359 
	#HDIO_SET_ACOUSTIC
 0x032¯

	)

360 
	#HDIO_SET_BUSSTATE
 0x032d

	)

361 
	#HDIO_SET_QDMA
 0x032ê

	)

362 
	#HDIO_SET_ADDRESS
 0x032‡

	)

366 
	mBUSSTATE_OFF
 = 0,

367 
	mBUSSTATE_ON
,

368 
	mBUSSTATE_TRISTATE


377 
	#__NEW_HD_DRIVE_ID


	)

385 
	shd_driveid
 {

386 
	mc⁄fig
;

387 
	mcyls
;

388 
	mª£rved2
;

389 
	mhóds
;

390 
	måack_byãs
;

391 
	m£˘‹_byãs
;

392 
	m£˘‹s
;

393 
	mvíd‹0
;

394 
	mvíd‹1
;

395 
	mvíd‹2
;

396 
	m£rül_no
[20];

397 
	mbuf_ty≥
;

398 
	mbuf_size
;

401 
	mecc_byãs
;

402 
	mfw_ªv
[8];

403 
	mmodñ
[40];

404 
	mmax_mu…£˘
;

405 
	mvíd‹3
;

406 
	mdw‹d_io
;

407 
	mvíd‹4
;

408 
	mˇ∑bûôy
;

414 
	mª£rved50
;

415 
	mvíd‹5
;

416 
	mtPIO
;

417 
	mvíd‹6
;

418 
	mtDMA
;

419 
	mfõld_vÆid
;

424 
	mcur_cyls
;

425 
	mcur_hóds
;

426 
	mcur_£˘‹s
;

427 
	mcur_ˇ∑côy0
;

428 
	mcur_ˇ∑côy1
;

429 
	mmu…£˘
;

430 
	mmu…£˘_vÆid
;

431 
	mlba_ˇ∑côy
;

432 
	mdma_1w‹d
;

433 
	mdma_mw‹d
;

434 
	meide_pio_modes
;

435 
	meide_dma_mö
;

436 
	meide_dma_time
;

437 
	meide_pio
;

438 
	meide_pio_i‹dy
;

439 
	mw‹ds69_70
[2];

442 
	mw‹ds71_74
[4];

445 
	mqueue_dïth
;

449 
	mw‹ds76_79
[4];

450 
	mmaj‹_ªv_num
;

451 
	mmö‹_ªv_num
;

452 
	mcomm™d_£t_1
;

470 
	mcomm™d_£t_2
;

488 
	mcfs£
;

500 
	mcfs_íabÀ_1
;

519 
	mcfs_íabÀ_2
;

538 
	mcsf_deÁu…
;

550 
	mdma_u…ø
;

551 
	må£uc
;

552 
	måsEuc
;

553 
	mCurAPMvÆues
;

554 
	mm¥c
;

555 
	mhw_c⁄fig
;

573 
	macou°ic
;

577 
	mm§qs
;

578 
	msx„π
;

579 
	mßl
;

580 
	m•g
;

581 
	mlba_ˇ∑côy_2
;

582 
	mw‹ds104_125
[22];

583 
	mœ°_lun
;

584 
	mw‹d127
;

592 
	mdlf
;

604 
	mcsfo
;

612 
	mw‹ds130_155
[26];

613 
	mw‹d156
;

614 
	mw‹ds157_159
[3];

615 
	mcÁ_powî
;

622 
	mw‹ds161_175
[15];

623 
	mw‹ds176_205
[30];

624 
	mw‹ds206_254
[49];

625 
	möãgrôy_w‹d
;

636 
	#IDE_NICE_DSC_OVERLAP
 (0Ë

	)

637 
	#IDE_NICE_ATAPI_OVERLAP
 (1Ë

	)

638 
	#IDE_NICE_1
 (3Ë

	)

639 
	#IDE_NICE_0
 (2Ë

	)

640 
	#IDE_NICE_2
 (4Ë

	)

	@/usr/include/linux/kdev_t.h

1 #i‚de‡
_LINUX_KDEV_T_H


2 
	#_LINUX_KDEV_T_H


	)

8 
	#MAJOR
(
dev
Ë((dev)>>8)

	)

9 
	#MINOR
(
dev
Ë((devË& 0xff)

	)

10 
	#MKDEV
(
ma
,
mi
Ë((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

1 #i‚de‡
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

4 
	~<löux/sysöfo.h
>

9 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`ty≥of
(x))◊Ë- 1)

	)

10 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

	@/usr/include/linux/mmc/ioctl.h

1 #i‚de‡
LINUX_MMC_IOCTL_H


2 
	#LINUX_MMC_IOCTL_H


	)

4 
	~<löux/ty≥s.h
>

6 
	smmc_ioc_cmd
 {

8 
	mwrôe_Êag
;

11 
	mis_acmd
;

13 
__u32
 
	m›code
;

14 
__u32
 
	m¨g
;

15 
__u32
 
	mª•⁄£
[4];

16 
	mÊags
;

17 
	mblksz
;

18 
	mblocks
;

27 
	mpo°¶ìp_mö_us
;

28 
	mpo°¶ìp_max_us
;

33 
	md©a_timeout_ns
;

34 
	mcmd_timeout_ms
;

41 
__u32
 
	m__∑d
;

44 
__u64
 
	md©a_±r
;

46 
	#mmc_ioc_cmd_£t_d©a
(
ic
, 
±r
Ëic.
d©a_±r
 = (
__u64
)(Ë
	)
ptr

54 
	smmc_ioc_mu…i_cmd
 {

55 
__u64
 
	mnum_of_cmds
;

56 
mmc_ioc_cmd
 
	mcmds
[0];

59 
	#MMC_IOC_CMD
 
	`_IOWR
(
MMC_BLOCK_MAJOR
, 0, 
mmc_ioc_cmd
)

	)

65 
	#MMC_IOC_MULTI_CMD
 
	`_IOWR
(
MMC_BLOCK_MAJOR
, 1, 
mmc_ioc_mu…i_cmd
)

	)

72 
	#MMC_IOC_MAX_BYTES
 (512L * 256)

	)

73 
	#MMC_IOC_MAX_CMDS
 255

	)

	@/usr/include/linux/sched.h

1 #i‚de‡
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

7 
	#CSIGNAL
 0x000000f‡

	)

8 
	#CLONE_VM
 0x00000100

	)

9 
	#CLONE_FS
 0x00000200

	)

10 
	#CLONE_FILES
 0x00000400

	)

11 
	#CLONE_SIGHAND
 0x00000800

	)

12 
	#CLONE_PTRACE
 0x00002000

	)

13 
	#CLONE_VFORK
 0x00004000

	)

14 
	#CLONE_PARENT
 0x00008000

	)

15 
	#CLONE_THREAD
 0x00010000

	)

16 
	#CLONE_NEWNS
 0x00020000

	)

17 
	#CLONE_SYSVSEM
 0x00040000

	)

18 
	#CLONE_SETTLS
 0x00080000

	)

19 
	#CLONE_PARENT_SETTID
 0x00100000

	)

20 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

21 
	#CLONE_DETACHED
 0x00400000

	)

22 
	#CLONE_UNTRACED
 0x00800000

	)

23 
	#CLONE_CHILD_SETTID
 0x01000000

	)

24 
	#CLONE_NEWCGROUP
 0x02000000

	)

25 
	#CLONE_NEWUTS
 0x04000000

	)

26 
	#CLONE_NEWIPC
 0x08000000

	)

27 
	#CLONE_NEWUSER
 0x10000000

	)

28 
	#CLONE_NEWPID
 0x20000000

	)

29 
	#CLONE_NEWNET
 0x40000000

	)

30 
	#CLONE_IO
 0x80000000

	)

35 
	#SCHED_NORMAL
 0

	)

36 
	#SCHED_FIFO
 1

	)

37 
	#SCHED_RR
 2

	)

38 
	#SCHED_BATCH
 3

	)

40 
	#SCHED_IDLE
 5

	)

41 
	#SCHED_DEADLINE
 6

	)

44 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

49 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

	@/usr/include/linux/serial_reg.h

14 #i‚de‡
_LINUX_SERIAL_REG_H


15 
	#_LINUX_SERIAL_REG_H


	)

20 
	#UART_RX
 0

	)

21 
	#UART_TX
 0

	)

23 
	#UART_IER
 1

	)

24 
	#UART_IER_MSI
 0x08

	)

25 
	#UART_IER_RLSI
 0x04

	)

26 
	#UART_IER_THRI
 0x02

	)

27 
	#UART_IER_RDI
 0x01

	)

31 
	#UART_IERX_SLEEP
 0x10

	)

33 
	#UART_IIR
 2

	)

34 
	#UART_IIR_NO_INT
 0x01

	)

35 
	#UART_IIR_ID
 0x0ê

	)

36 
	#UART_IIR_MSI
 0x00

	)

37 
	#UART_IIR_THRI
 0x02

	)

38 
	#UART_IIR_RDI
 0x04

	)

39 
	#UART_IIR_RLSI
 0x06

	)

41 
	#UART_IIR_BUSY
 0x07

	)

43 
	#UART_IIR_RX_TIMEOUT
 0x0¯

	)

44 
	#UART_IIR_XOFF
 0x10

	)

45 
	#UART_IIR_CTS_RTS_DSR
 0x20

	)

47 
	#UART_FCR
 2

	)

48 
	#UART_FCR_ENABLE_FIFO
 0x01

	)

49 
	#UART_FCR_CLEAR_RCVR
 0x02

	)

50 
	#UART_FCR_CLEAR_XMIT
 0x04

	)

51 
	#UART_FCR_DMA_SELECT
 0x08

	)

66 
	#UART_FCR_R_TRIG_00
 0x00

	)

67 
	#UART_FCR_R_TRIG_01
 0x40

	)

68 
	#UART_FCR_R_TRIG_10
 0x80

	)

69 
	#UART_FCR_R_TRIG_11
 0xc0

	)

70 
	#UART_FCR_T_TRIG_00
 0x00

	)

71 
	#UART_FCR_T_TRIG_01
 0x10

	)

72 
	#UART_FCR_T_TRIG_10
 0x20

	)

73 
	#UART_FCR_T_TRIG_11
 0x30

	)

75 
	#UART_FCR_TRIGGER_MASK
 0xC0

	)

76 
	#UART_FCR_TRIGGER_1
 0x00

	)

77 
	#UART_FCR_TRIGGER_4
 0x40

	)

78 
	#UART_FCR_TRIGGER_8
 0x80

	)

79 
	#UART_FCR_TRIGGER_14
 0xC0

	)

81 
	#UART_FCR6_R_TRIGGER_8
 0x00

	)

82 
	#UART_FCR6_R_TRIGGER_16
 0x40

	)

83 
	#UART_FCR6_R_TRIGGER_24
 0x80

	)

84 
	#UART_FCR6_R_TRIGGER_28
 0xC0

	)

85 
	#UART_FCR6_T_TRIGGER_16
 0x00

	)

86 
	#UART_FCR6_T_TRIGGER_8
 0x10

	)

87 
	#UART_FCR6_T_TRIGGER_24
 0x20

	)

88 
	#UART_FCR6_T_TRIGGER_30
 0x30

	)

89 
	#UART_FCR7_64BYTE
 0x20

	)

92 
	#UART_FCR_R_TRIG_SHIFT
 6

	)

93 
	#UART_FCR_R_TRIG_BITS
(
x
) \

94 (((
x
Ë& 
UART_FCR_TRIGGER_MASK
Ë>> 
UART_FCR_R_TRIG_SHIFT
)

	)

95 
	#UART_FCR_R_TRIG_MAX_STATE
 4

	)

97 
	#UART_LCR
 3

	)

102 
	#UART_LCR_DLAB
 0x80

	)

103 
	#UART_LCR_SBC
 0x40

	)

104 
	#UART_LCR_SPAR
 0x20

	)

105 
	#UART_LCR_EPAR
 0x10

	)

106 
	#UART_LCR_PARITY
 0x08

	)

107 
	#UART_LCR_STOP
 0x04

	)

108 
	#UART_LCR_WLEN5
 0x00

	)

109 
	#UART_LCR_WLEN6
 0x01

	)

110 
	#UART_LCR_WLEN7
 0x02

	)

111 
	#UART_LCR_WLEN8
 0x03

	)

117 
	#UART_LCR_CONF_MODE_A
 
UART_LCR_DLAB


	)

118 
	#UART_LCR_CONF_MODE_B
 0xBF

	)

120 
	#UART_MCR
 4

	)

121 
	#UART_MCR_CLKSEL
 0x80

	)

122 
	#UART_MCR_TCRTLR
 0x40

	)

123 
	#UART_MCR_XONANY
 0x20

	)

124 
	#UART_MCR_AFE
 0x20

	)

125 
	#UART_MCR_LOOP
 0x10

	)

126 
	#UART_MCR_OUT2
 0x08

	)

127 
	#UART_MCR_OUT1
 0x04

	)

128 
	#UART_MCR_RTS
 0x02

	)

129 
	#UART_MCR_DTR
 0x01

	)

131 
	#UART_LSR
 5

	)

132 
	#UART_LSR_FIFOE
 0x80

	)

133 
	#UART_LSR_TEMT
 0x40

	)

134 
	#UART_LSR_THRE
 0x20

	)

135 
	#UART_LSR_BI
 0x10

	)

136 
	#UART_LSR_FE
 0x08

	)

137 
	#UART_LSR_PE
 0x04

	)

138 
	#UART_LSR_OE
 0x02

	)

139 
	#UART_LSR_DR
 0x01

	)

140 
	#UART_LSR_BRK_ERROR_BITS
 0x1E

	)

142 
	#UART_MSR
 6

	)

143 
	#UART_MSR_DCD
 0x80

	)

144 
	#UART_MSR_RI
 0x40

	)

145 
	#UART_MSR_DSR
 0x20

	)

146 
	#UART_MSR_CTS
 0x10

	)

147 
	#UART_MSR_DDCD
 0x08

	)

148 
	#UART_MSR_TERI
 0x04

	)

149 
	#UART_MSR_DDSR
 0x02

	)

150 
	#UART_MSR_DCTS
 0x01

	)

151 
	#UART_MSR_ANY_DELTA
 0x0F

	)

153 
	#UART_SCR
 7

	)

158 
	#UART_DLL
 0

	)

159 
	#UART_DLM
 1

	)

164 
	#UART_EFR
 2

	)

165 
	#UART_XR_EFR
 9

	)

166 
	#UART_EFR_CTS
 0x80

	)

167 
	#UART_EFR_RTS
 0x40

	)

168 
	#UART_EFR_SCD
 0x20

	)

169 
	#UART_EFR_ECB
 0x10

	)

177 
	#UART_XON1
 4

	)

178 
	#UART_XON2
 5

	)

179 
	#UART_XOFF1
 6

	)

180 
	#UART_XOFF2
 7

	)

185 
	#UART_TI752_TCR
 6

	)

186 
	#UART_TI752_TLR
 7

	)

191 
	#UART_TRG
 0

	)

197 
	#UART_TRG_1
 0x01

	)

198 
	#UART_TRG_4
 0x04

	)

199 
	#UART_TRG_8
 0x08

	)

200 
	#UART_TRG_16
 0x10

	)

201 
	#UART_TRG_32
 0x20

	)

202 
	#UART_TRG_64
 0x40

	)

203 
	#UART_TRG_96
 0x60

	)

204 
	#UART_TRG_120
 0x78

	)

205 
	#UART_TRG_128
 0x80

	)

207 
	#UART_FCTR
 1

	)

208 
	#UART_FCTR_RTS_NODELAY
 0x00

	)

209 
	#UART_FCTR_RTS_4DELAY
 0x01

	)

210 
	#UART_FCTR_RTS_6DELAY
 0x02

	)

211 
	#UART_FCTR_RTS_8DELAY
 0x03

	)

212 
	#UART_FCTR_IRDA
 0x04

	)

213 
	#UART_FCTR_TX_INT
 0x08

	)

214 
	#UART_FCTR_TRGA
 0x00

	)

215 
	#UART_FCTR_TRGB
 0x10

	)

216 
	#UART_FCTR_TRGC
 0x20

	)

217 
	#UART_FCTR_TRGD
 0x30

	)

218 
	#UART_FCTR_SCR_SWAP
 0x40

	)

219 
	#UART_FCTR_RX
 0x00

	)

220 
	#UART_FCTR_TX
 0x80

	)

225 
	#UART_EMSR
 7

	)

226 
	#UART_EMSR_FIFO_COUNT
 0x01

	)

227 
	#UART_EMSR_ALT_COUNT
 0x02

	)

232 
	#UART_IER_DMAE
 0x80

	)

233 
	#UART_IER_UUE
 0x40

	)

234 
	#UART_IER_NRZE
 0x20

	)

235 
	#UART_IER_RTOIE
 0x10

	)

237 
	#UART_IIR_TOD
 0x08

	)

239 
	#UART_FCR_PXAR1
 0x00

	)

240 
	#UART_FCR_PXAR8
 0x40

	)

241 
	#UART_FCR_PXAR16
 0x80

	)

242 
	#UART_FCR_PXAR32
 0xc0

	)

247 
	#UART_ASR
 0x01

	)

248 
	#UART_RFL
 0x03

	)

249 
	#UART_TFL
 0x04

	)

250 
	#UART_ICR
 0x05

	)

253 
	#UART_ACR
 0x00

	)

254 
	#UART_CPR
 0x01

	)

255 
	#UART_TCR
 0x02

	)

256 
	#UART_CKS
 0x03

	)

257 
	#UART_TTL
 0x04

	)

258 
	#UART_RTL
 0x05

	)

259 
	#UART_FCL
 0x06

	)

260 
	#UART_FCH
 0x07

	)

261 
	#UART_ID1
 0x08

	)

262 
	#UART_ID2
 0x09

	)

263 
	#UART_ID3
 0x0A

	)

264 
	#UART_REV
 0x0B

	)

265 
	#UART_CSR
 0x0C

	)

266 
	#UART_NMR
 0x0D

	)

267 
	#UART_CTR
 0xFF

	)

272 
	#UART_ACR_RXDIS
 0x01

	)

273 
	#UART_ACR_TXDIS
 0x02

	)

274 
	#UART_ACR_DSRFC
 0x04

	)

275 
	#UART_ACR_TLENB
 0x20

	)

276 
	#UART_ACR_ICRRD
 0x40

	)

277 
	#UART_ACR_ASREN
 0x80

	)

287 
	#UART_RSA_BASE
 (-8)

	)

289 
	#UART_RSA_MSR
 ((
UART_RSA_BASE
Ë+ 0Ë

	)

291 
	#UART_RSA_MSR_SWAP
 (1 << 0Ë

	)

292 
	#UART_RSA_MSR_FIFO
 (1 << 2Ë

	)

293 
	#UART_RSA_MSR_FLOW
 (1 << 3Ë

	)

294 
	#UART_RSA_MSR_ITYP
 (1 << 4Ë

	)

296 
	#UART_RSA_IER
 ((
UART_RSA_BASE
Ë+ 1Ë

	)

298 
	#UART_RSA_IER_Rx_FIFO_H
 (1 << 0Ë

	)

299 
	#UART_RSA_IER_Tx_FIFO_H
 (1 << 1Ë

	)

300 
	#UART_RSA_IER_Tx_FIFO_E
 (1 << 2Ë

	)

301 
	#UART_RSA_IER_Rx_TOUT
 (1 << 3Ë

	)

302 
	#UART_RSA_IER_TIMER
 (1 << 4Ë

	)

304 
	#UART_RSA_SRR
 ((
UART_RSA_BASE
Ë+ 2Ë

	)

306 
	#UART_RSA_SRR_Tx_FIFO_NEMP
 (1 << 0Ë

	)

307 
	#UART_RSA_SRR_Tx_FIFO_NHFL
 (1 << 1Ë

	)

308 
	#UART_RSA_SRR_Tx_FIFO_NFUL
 (1 << 2Ë

	)

309 
	#UART_RSA_SRR_Rx_FIFO_NEMP
 (1 << 3Ë

	)

310 
	#UART_RSA_SRR_Rx_FIFO_NHFL
 (1 << 4Ë

	)

311 
	#UART_RSA_SRR_Rx_FIFO_NFUL
 (1 << 5Ë

	)

312 
	#UART_RSA_SRR_Rx_TOUT
 (1 << 6Ë

	)

313 
	#UART_RSA_SRR_TIMER
 (1 << 7Ë

	)

315 
	#UART_RSA_FRR
 ((
UART_RSA_BASE
Ë+ 2Ë

	)

317 
	#UART_RSA_TIVSR
 ((
UART_RSA_BASE
Ë+ 3Ë

	)

319 
	#UART_RSA_TCR
 ((
UART_RSA_BASE
Ë+ 4Ë

	)

321 
	#UART_RSA_TCR_SWITCH
 (1 << 0Ë

	)

327 
	#SERIAL_RSA_BAUD_BASE
 (921600)

	)

328 
	#SERIAL_RSA_BAUD_BASE_LO
 (
SERIAL_RSA_BAUD_BASE
 / 8)

	)

334 
	#OMAP1_UART1_BASE
 0xfffb0000

	)

335 
	#OMAP1_UART2_BASE
 0xfffb0800

	)

336 
	#OMAP1_UART3_BASE
 0xfffb9800

	)

337 
	#UART_OMAP_MDR1
 0x08

	)

338 
	#UART_OMAP_MDR2
 0x09

	)

339 
	#UART_OMAP_SCR
 0x10

	)

340 
	#UART_OMAP_SSR
 0x11

	)

341 
	#UART_OMAP_EBLR
 0x12

	)

342 
	#UART_OMAP_OSC_12M_SEL
 0x13

	)

343 
	#UART_OMAP_MVER
 0x14

	)

344 
	#UART_OMAP_SYSC
 0x15

	)

345 
	#UART_OMAP_SYSS
 0x16

	)

346 
	#UART_OMAP_WER
 0x17

	)

347 
	#UART_OMAP_TX_LVL
 0x1®

	)

352 
	#UART_OMAP_MDR1_16X_MODE
 0x00

	)

353 
	#UART_OMAP_MDR1_SIR_MODE
 0x01

	)

354 
	#UART_OMAP_MDR1_16X_ABAUD_MODE
 0x02

	)

355 
	#UART_OMAP_MDR1_13X_MODE
 0x03

	)

356 
	#UART_OMAP_MDR1_MIR_MODE
 0x04

	)

357 
	#UART_OMAP_MDR1_FIR_MODE
 0x05

	)

358 
	#UART_OMAP_MDR1_CIR_MODE
 0x06

	)

359 
	#UART_OMAP_MDR1_DISABLE
 0x07

	)

364 
	#UART_EXAR_8XMODE
 0x88

	)

365 
	#UART_EXAR_SLEEP
 0x8b

	)

366 
	#UART_EXAR_DVID
 0x8d

	)

368 
	#UART_EXAR_FCTR
 0x08

	)

369 
	#UART_FCTR_EXAR_IRDA
 0x08

	)

370 
	#UART_FCTR_EXAR_485
 0x10

	)

371 
	#UART_FCTR_EXAR_TRGA
 0x00

	)

372 
	#UART_FCTR_EXAR_TRGB
 0x60

	)

373 
	#UART_FCTR_EXAR_TRGC
 0x80

	)

374 
	#UART_FCTR_EXAR_TRGD
 0xc0

	)

376 
	#UART_EXAR_TXTRG
 0x0®

	)

377 
	#UART_EXAR_RXTRG
 0x0b

	)

	@/usr/include/linux/tty.h

1 #i‚de‡
_LINUX_TTY_H


2 
	#_LINUX_TTY_H


	)

8 
	#NR_LDISCS
 30

	)

11 
	#N_TTY
 0

	)

12 
	#N_SLIP
 1

	)

13 
	#N_MOUSE
 2

	)

14 
	#N_PPP
 3

	)

15 
	#N_STRIP
 4

	)

16 
	#N_AX25
 5

	)

17 
	#N_X25
 6

	)

18 
	#N_6PACK
 7

	)

19 
	#N_MASC
 8

	)

20 
	#N_R3964
 9

	)

21 
	#N_PROFIBUS_FDL
 10

	)

22 
	#N_IRDA
 11

	)

23 
	#N_SMSBLOCK
 12

	)

25 
	#N_HDLC
 13

	)

26 
	#N_SYNC_PPP
 14

	)

27 
	#N_HCI
 15

	)

28 
	#N_GIGASET_M101
 16

	)

29 
	#N_SLCAN
 17

	)

30 
	#N_PPS
 18

	)

31 
	#N_V253
 19

	)

32 
	#N_CAIF
 20

	)

33 
	#N_GSM0710
 21

	)

34 
	#N_TI_WL
 22

	)

35 
	#N_TRACESINK
 23

	)

36 
	#N_TRACEROUTER
 24

	)

37 
	#N_NCI
 25

	)

	@/usr/include/linux/ioctl.h

1 #i‚de‡
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/io˘l.h
>

	@/usr/include/linux/limits.h

1 #i‚de‡
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 1024

	)

6 
	#NGROUPS_MAX
 65536

	)

7 
	#ARG_MAX
 131072

	)

8 
	#LINK_MAX
 127

	)

9 
	#MAX_CANON
 255

	)

10 
	#MAX_INPUT
 255

	)

11 
	#NAME_MAX
 255

	)

12 
	#PATH_MAX
 4096

	)

13 
	#PIPE_BUF
 4096

	)

14 
	#XATTR_NAME_MAX
 255

	)

15 
	#XATTR_SIZE_MAX
 65536

	)

16 
	#XATTR_LIST_MAX
 65536

	)

18 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/sysinfo.h

1 #i‚de‡
_LINUX_SYSINFO_H


2 
	#_LINUX_SYSINFO_H


	)

4 
	~<löux/ty≥s.h
>

6 
	#SI_LOAD_SHIFT
 16

	)

7 
	ssysöfo
 {

8 
__kî√l_l⁄g_t
 
	mu±ime
;

9 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

10 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

11 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

12 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

13 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

14 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

15 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

16 
__u16
 
	m¥ocs
;

17 
__u16
 
	m∑d
;

18 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

19 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

20 
__u32
 
	mmem_unô
;

21 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/linux/types.h

1 #i‚de‡
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty≥s.h
>

6 #i‚de‡
__ASSEMBLY__


8 
	~<löux/posix_ty≥s.h
>

16 #ifde‡
__CHECKER__


17 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

19 
	#__bôwi£__


	)

21 #ifde‡
__CHECK_ENDIAN__


22 
	#__bôwi£
 
__bôwi£__


	)

24 
	#__bôwi£


	)

27 
__u16
 
	t__bôwi£
 
	t__À16
;

28 
__u16
 
	t__bôwi£
 
	t__be16
;

29 
__u32
 
	t__bôwi£
 
	t__À32
;

30 
__u32
 
	t__bôwi£
 
	t__be32
;

31 
__u64
 
	t__bôwi£
 
	t__À64
;

32 
__u64
 
	t__bôwi£
 
	t__be64
;

34 
__u16
 
	t__bôwi£
 
	t__sum16
;

35 
__u32
 
	t__bôwi£
 
	t__wsum
;

46 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

48 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

	@/usr/include/linux/posix_types.h

1 #i‚de‡
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<löux/°ddef.h
>

21 #unde‡
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__kî√l_fd_£t
;

29 (*
	t__kî√l_sigh™dÀr_t
)();

32 
	t__kî√l_key_t
;

33 
	t__kî√l_mqd_t
;

35 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/stddef.h

	@
1
.
1
/usr/include
21
500
block.c
mmc_test.c
queue.c
queue.h
sdio_uart.c
/usr/include/linux/capability.h
/usr/include/linux/errno.h
/usr/include/linux/fs.h
/usr/include/linux/hdreg.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/mmc/ioctl.h
/usr/include/linux/sched.h
/usr/include/linux/serial_reg.h
/usr/include/linux/tty.h
/usr/include/linux/ioctl.h
/usr/include/linux/limits.h
/usr/include/linux/sysinfo.h
/usr/include/linux/types.h
/usr/include/linux/posix_types.h
/usr/include/linux/stddef.h
